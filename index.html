<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט AI - רקע WhatsApp</title>
    <style>
        /* --- משתני עיצוב גלובליים --- */
        :root {
            --font-main: Assistant, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-code: 'Consolas', 'Monaco', 'Courier New', monospace;
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --border-radius-large: 18px;
            --border-radius-round: 50%;
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;

            /* --- Light Mode --- */
            --lm-bg-default: #e5ddd5; /* רקע כמו וואטסאפ מסביב */
            --lm-chat-bg: #ffffff; /* רקע הקונטיינר חזר ללבן */
            --lm-header-bg: #00a884;
            --lm-header-text: #ffffff;
            --lm-header-icon-fill: #ffffff;
            --lm-user-msg-bg: #dcf8c6;
            --lm-ai-msg-bg: #ffffff;
            --lm-msg-text: #111b21;
            --lm-input-area-bg: #f0f2f5;
            --lm-input-bg: #ffffff;
            --lm-input-text: #111b21;
            --lm-input-border: #e0e0e0;
            --lm-input-border-focus: var(--lm-button-bg);
            --lm-button-bg: #008069;
            --lm-button-hover-bg: #00a884;
            --lm-button-active-bg: #005c4b;
            --lm-button-icon-fill: #ffffff;
            --lm-timestamp-color: rgba(17, 27, 33, 0.65);
            --lm-model-indicator-color: rgba(17, 27, 33, 0.55);
            --lm-border-color: #e9edef; /* חזרה לגבול בהיר יותר */
            --lm-icon-button-hover-bg: rgba(0, 0, 0, 0.07);
            --lm-msg-action-icon-fill: rgba(0, 0, 0, 0.5);
            --lm-msg-action-icon-hover-fill: #000000;
            --lm-msg-action-icon-hover-bg: rgba(0, 0, 0, 0.09);
            --lm-scrollbar-thumb: #b0b0b0;
            --lm-scrollbar-track: #f0f0f0; /* רקע בהיר לפס גלילה */
            --lm-link-color: #007bff;
            --lm-code-bg: #f8f9fa;
            --lm-code-text: #212529;
            --lm-code-border: #dee2e6;
            --lm-code-copy-btn-bg: rgba(0, 0, 0, 0.05);
            --lm-code-copy-btn-hover-bg: rgba(0, 0, 0, 0.1);
            --lm-code-copy-btn-copied-bg: var(--lm-button-bg);
            --lm-code-copy-btn-copied-text: #ffffff;
            --lm-loading-spinner-color1: #00a884;
            --lm-loading-spinner-color2: #dcf8c6;
            --lm-shadow-light: 0 1px 2px rgba(0, 0, 0, 0.07);
            --lm-shadow-medium: 0 3px 6px rgba(0, 0, 0, 0.09);
            --lm-scroll-btn-bg: rgba(255, 255, 255, 0.85);
            --lm-scroll-btn-icon: #54656f;
            --lm-scroll-btn-hover-bg: #ffffff;

            /* --- Dark Mode --- */
            --dm-bg-default: #111b21; --dm-chat-bg: #0b141a; --dm-header-bg: #202c33; --dm-header-text: #e9edef; --dm-header-icon-fill: #aebac1; --dm-user-msg-bg: #005c4b; --dm-ai-msg-bg: #202c33; --dm-msg-text: #e9edef; --dm-input-area-bg: #1f2c34; --dm-input-bg: #2a3942; --dm-input-text: #e9edef; --dm-input-border: #374151; --dm-input-border-focus: var(--dm-button-bg); --dm-button-bg: #00a884; --dm-button-hover-bg: #008069; --dm-button-active-bg: #00a884; --dm-button-icon-fill: #111b21; --dm-timestamp-color: rgba(233, 237, 239, 0.7); --dm-model-indicator-color: rgba(233, 237, 239, 0.6); --dm-border-color: #2a3942; --dm-icon-button-hover-bg: rgba(255, 255, 255, 0.08); --dm-msg-action-icon-fill: rgba(255, 255, 255, 0.6); --dm-msg-action-icon-hover-fill: #ffffff; --dm-msg-action-icon-hover-bg: rgba(255, 255, 255, 0.1); --dm-scrollbar-thumb: #4a4a4a;
            --dm-scrollbar-track: var(--dm-chat-bg); /* רקע כהה לפס גלילה */
            --dm-link-color: #58a6ff; --dm-code-bg: #182128; --dm-code-text: #d1d5db; --dm-code-border: #374151; --dm-code-copy-btn-bg: rgba(255, 255, 255, 0.1); --dm-code-copy-btn-hover-bg: rgba(255, 255, 255, 0.15); --dm-code-copy-btn-copied-bg: var(--dm-button-bg); --dm-code-copy-btn-copied-text: #111b21; --dm-loading-spinner-color1: #25d366; --dm-loading-spinner-color2: #005c4b; --dm-shadow-light: 0 1px 1px rgba(0, 0, 0, 0.3); --dm-shadow-medium: 0 3px 6px rgba(0, 0, 0, 0.4); --dm-scroll-btn-bg: rgba(42, 57, 66, 0.85); --dm-scroll-btn-icon: #aebac1; --dm-scroll-btn-hover-bg: #2a3942;

            /* ברירת מחדל */
             --bg-default: var(--lm-bg-default); --chat-bg: var(--lm-chat-bg); --header-bg: var(--lm-header-bg); --header-text: var(--lm-header-text); --header-icon-fill: var(--lm-header-icon-fill); --user-msg-bg: var(--lm-user-msg-bg); --ai-msg-bg: var(--lm-ai-msg-bg); --msg-text: var(--lm-msg-text); --input-area-bg: var(--lm-input-area-bg); --input-bg: var(--lm-input-bg); --input-text: var(--lm-input-text); --input-border: var(--lm-input-border); --input-border-focus: var(--lm-input-border-focus); --button-bg: var(--lm-button-bg); --button-hover-bg: var(--lm-button-hover-bg); --button-active-bg: var(--lm-button-active-bg); --button-icon-fill: var(--lm-button-icon-fill); --timestamp-color: var(--lm-timestamp-color); --model-indicator-color: var(--lm-model-indicator-color); --border-color: var(--lm-border-color); --icon-button-hover-bg: var(--lm-icon-button-hover-bg); --msg-action-icon-fill: var(--lm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--lm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--lm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--lm-scrollbar-thumb); --scrollbar-track: var(--lm-scrollbar-track); --link-color: var(--lm-link-color); --code-bg: var(--lm-code-bg); --code-text: var(--lm-code-text); --code-border: var(--lm-code-border); --code-copy-btn-bg: var(--lm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--lm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--lm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--lm-code-copy-btn-copied-text); --loading-spinner-color1: var(--lm-loading-spinner-color1); --loading-spinner-color2: var(--lm-loading-spinner-color2); --shadow-light: var(--lm-shadow-light); --shadow-medium: var(--lm-shadow-medium); --scroll-btn-bg: var(--lm-scroll-btn-bg); --scroll-btn-icon: var(--lm-scroll-btn-icon); --scroll-btn-hover-bg: var(--lm-scroll-btn-hover-bg);
            --select-bg: rgba(255, 255, 255, 0.15); --select-border: rgba(255, 255, 255, 0.3); --select-text: var(--lm-header-text); --select-arrow: var(--lm-header-icon-fill); --stop-button-fill: var(--lm-msg-action-icon-fill); --stop-button-hover-fill: var(--lm-msg-action-icon-hover-fill);
        }
        body.dark-mode {
             --bg-default: var(--dm-bg-default); --chat-bg: var(--dm-chat-bg); --header-bg: var(--dm-header-bg); --header-text: var(--dm-header-text); --header-icon-fill: var(--dm-header-icon-fill); --user-msg-bg: var(--dm-user-msg-bg); --ai-msg-bg: var(--dm-ai-msg-bg); --msg-text: var(--dm-msg-text); --input-area-bg: var(--dm-input-area-bg); --input-bg: var(--dm-input-bg); --input-text: var(--dm-input-text); --input-border: var(--dm-input-border); --input-border-focus: var(--dm-input-border-focus); --button-bg: var(--dm-button-bg); --button-hover-bg: var(--dm-button-hover-bg); --button-active-bg: var(--dm-button-active-bg); --button-icon-fill: var(--dm-button-icon-fill); --timestamp-color: var(--dm-timestamp-color); --model-indicator-color: var(--dm-model-indicator-color); --border-color: var(--dm-border-color); --icon-button-hover-bg: var(--dm-icon-button-hover-bg); --msg-action-icon-fill: var(--dm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--dm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--dm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--dm-scrollbar-thumb); --scrollbar-track: var(--dm-scrollbar-track); --link-color: var(--dm-link-color); --code-bg: var(--dm-code-bg); --code-text: var(--dm-code-text); --code-border: var(--dm-code-border); --code-copy-btn-bg: var(--dm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--dm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--dm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--dm-code-copy-btn-copied-text); --loading-spinner-color1: var(--dm-loading-spinner-color1); --loading-spinner-color2: var(--dm-loading-spinner-color2); --shadow-light: var(--dm-shadow-light); --shadow-medium: var(--dm-shadow-medium); --scroll-btn-bg: var(--dm-scroll-btn-bg); --scroll-btn-icon: var(--dm-scroll-btn-icon); --scroll-btn-hover-bg: var(--dm-scroll-btn-hover-bg);
             --select-bg: rgba(255, 255, 255, 0.08); --select-border: rgba(255, 255, 255, 0.15); --select-text: var(--dm-header-text); --select-arrow: var(--dm-header-icon-fill); --stop-button-fill: var(--dm-msg-action-icon-fill); --stop-button-hover-fill: var(--dm-msg-action-icon-hover-fill);
        }

        /* --- CSS הכללי נשאר זהה --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: var(--font-main); background-color: var(--bg-default); color: var(--msg-text); display: flex; flex-direction: column; transition: background-color var(--transition-medium), color var(--transition-medium); font-size: 14.5px; }
        * { box-sizing: border-box; }
        #chat-container { width: 100%; max-width: 850px; height: calc(100vh - 20px); margin: 10px auto; background-color: var(--chat-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; transition: background-color var(--transition-medium), box-shadow var(--transition-medium); box-shadow: var(--shadow-medium); border-radius: var(--border-radius-medium); }
        #chat-header { background-color: var(--header-bg); color: var(--header-text); padding: 10px 16px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); z-index: 10; transition: background-color var(--transition-medium), color var(--transition-medium); gap: 10px; flex-shrink: 0; border-top-left-radius: var(--border-radius-medium); border-top-right-radius: var(--border-radius-medium); }
        #chat-header h1 { margin: 0; font-size: 18px; font-weight: 600; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-controls { display: flex; align-items: center; gap: 6px; }
        #model-select { background-color: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border); border-radius: var(--border-radius-large); padding: 6px 28px 6px 12px; font-size: 13px; cursor: pointer; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23ffffff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 8px center; background-size: 18px; transition: background-color var(--transition-fast), border-color var(--transition-fast), background-image var(--transition-medium); }
        #model-select:hover { background-color: color-mix(in srgb, var(--select-bg) 80%, #000000 20%); }
        #model-select option { background-color: var(--chat-bg); color: var(--msg-text); }
        body.dark-mode #model-select option { background-color: var(--input-bg); color: var(--msg-text); }
        .icon-button { background: none; border: none; padding: 8px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-fast); }
        .icon-button:hover { background-color: var(--icon-button-hover-bg); }
        .icon-button:active { background-color: color-mix(in srgb, var(--icon-button-hover-bg) 70%, #000000); transform: scale(0.92); }
        .icon-button svg { width: 22px; height: 22px; fill: var(--header-icon-fill); transition: fill var(--transition-medium); }

        #chat-output {
            flex-grow: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; scroll-behavior: smooth;
            position: relative;
            background-color: transparent; /* הסרת צבע הרקע המוצק */
        }
         /* החזרת רקע התמונה במצב בהיר */
         body:not(.dark-mode) #chat-output {
             background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
             background-repeat: repeat;
         }
         /* רקע מוצק במצב כהה */
         body.dark-mode #chat-output {
             background-color: var(--dm-chat-bg);
         }

        #chat-output::-webkit-scrollbar { width: 8px; }
        #chat-output::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 4px; }
        #chat-output::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--chat-bg); /* התאמת צבע הגבול לרקע הקונטיינר */ }
        #chat-output::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--scrollbar-thumb) 70%, #000000); }
        #chat-output { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }
        #scroll-to-bottom { position: absolute; bottom: 70px; left: 20px; background-color: var(--scroll-btn-bg); backdrop-filter: blur(5px); border: 1px solid color-mix(in srgb, var(--border-color) 50%, transparent); border-radius: var(--border-radius-round); width: 36px; height: 36px; padding: 0; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: var(--shadow-medium); opacity: 0; transition: opacity var(--transition-medium), transform var(--transition-medium), background-color var(--transition-fast); z-index: 20; }
        #scroll-to-bottom.visible { display: flex; opacity: 0.8; }
        #scroll-to-bottom:hover { opacity: 1; background-color: var(--scroll-btn-hover-bg); transform: scale(1.05); }
        #scroll-to-bottom svg { width: 20px; height: 20px; fill: var(--scroll-btn-icon); }

        .message { max-width: 78%; padding: 9px 15px; margin-bottom: 12px; border-radius: var(--border-radius-large); word-wrap: break-word; line-height: 1.55; font-size: 14.8px; color: var(--msg-text); box-shadow: var(--shadow-light); transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-medium), transform var(--transition-fast); opacity: 0; animation: fadeInSlideUp 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; position: relative; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background-color: var(--user-msg-bg); align-self: flex-start; margin-left: auto; border-bottom-left-radius: var(--border-radius-medium); }
        .ai-message { background-color: var(--ai-msg-bg); align-self: flex-end; margin-right: auto; border: 1px solid var(--border-color); border-bottom-right-radius: var(--border-radius-medium); box-shadow: none; }
        .ai-message.typing-cursor .message-content::after { content: '▍'; display: inline-block; animation: blink-cursor 0.8s infinite; margin-right: 2px; color: var(--timestamp-color); }
        @keyframes blink-cursor { 50% { opacity: 0; } }
        .message-content { padding-bottom: 2px; min-height: 1.55em; }
        .message-footer { display: flex; align-items: center; font-size: 11.5px; margin-top: 6px; gap: 8px; transition: color var(--transition-medium); flex-wrap: wrap; opacity: 0.85; }
        .model-indicator { color: var(--model-indicator-color); white-space: nowrap; font-weight: 500; }
        .timestamp { color: var(--timestamp-color); white-space: nowrap; }
        .user-message .message-footer { justify-content: flex-end; color: var(--timestamp-color); }
        .ai-message .message-footer { justify-content: flex-start; color: var(--timestamp-color); }
        .user-message .model-indicator { display: none; }
        .message-actions { position: absolute; top: 4px; display: flex; gap: 4px; opacity: 0; transition: opacity var(--transition-fast), transform var(--transition-fast); background-color: color-mix(in srgb, var(--chat-bg) 85%, transparent); backdrop-filter: blur(3px); border-radius: var(--border-radius-large); padding: 3px 5px; z-index: 1; pointer-events: none; }
        .user-message .message-actions { left: -8px; transform: translateX(-100%) translateY(-5px) scale(0.9); }
        .ai-message .message-actions { right: -8px; transform: translateX(100%) translateY(-5px) scale(0.9); }
        .message:hover .message-actions { opacity: 1; transform: translateX(0) translateY(0) scale(1); pointer-events: auto; }
        .msg-action-button { background: none; border: none; padding: 4px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-fast); }
        .msg-action-button svg { width: 17px; height: 17px; fill: var(--msg-action-icon-fill); transition: fill var(--transition-fast); }
        .msg-action-button:hover { background-color: var(--msg-action-icon-hover-bg); }
        .msg-action-button:hover svg { fill: var(--msg-action-icon-hover-fill); }
        .msg-action-button:active { transform: scale(0.9); }
        .msg-action-button.copied { animation: copied-feedback 0.5s ease; }
        .msg-action-button.copied svg { fill: var(--button-bg); }
        @keyframes copied-feedback { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .message-content pre { background-color: var(--code-bg); color: var(--code-text); padding: 12px 16px; border-radius: var(--border-radius-medium); overflow-x: auto; font-family: var(--font-code); font-size: 13.5px; margin: 10px 0; direction: ltr; text-align: left; white-space: pre; border: 1px solid var(--code-border); position: relative; }
        .message-content pre .copy-code-button { position: absolute; top: 8px; right: 8px; background-color: var(--code-copy-btn-bg); color: var(--code-text); border: none; border-radius: var(--border-radius-small); padding: 4px 8px; font-size: 11px; font-family: var(--font-main); cursor: pointer; opacity: 0; transition: opacity var(--transition-fast), background-color var(--transition-fast); z-index: 2; backdrop-filter: blur(2px); }
        .message-content pre:hover .copy-code-button { opacity: 0.8; }
        .message-content pre .copy-code-button:hover { opacity: 1; background-color: var(--code-copy-btn-hover-bg); }
        .message-content pre .copy-code-button.copied { background-color: var(--code-copy-btn-copied-bg); color: var(--code-copy-btn-copied-text); opacity: 1; }
        .message-content code:not(pre > code) { background-color: color-mix(in srgb, var(--code-bg) 80%, var(--chat-bg)); color: var(--code-text); padding: 0.2em 0.5em; margin: 0 0.1em; font-size: 88%; border-radius: var(--border-radius-small); font-family: var(--font-code); direction: ltr; text-align: left; border: 1px solid var(--code-border); }

        #chat-input-area { display: flex; align-items: flex-end; padding: 10px 14px; border-top: 1px solid var(--border-color); background-color: var(--input-area-bg); flex-shrink: 0; transition: background-color var(--transition-medium), border-color var(--transition-medium); gap: 10px; border-bottom-left-radius: var(--border-radius-medium); border-bottom-right-radius: var(--border-radius-medium); }
        #user-input { flex-grow: 1; padding: 11px 18px; border: 1px solid var(--input-border); border-radius: var(--border-radius-large); font-size: 15px; background-color: var(--input-bg); color: var(--input-text); outline: none; transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-fast), height var(--transition-fast), border-color var(--transition-fast); resize: none; overflow-y: hidden; min-height: 44px; max-height: 160px; line-height: 1.45; box-sizing: border-box; box-shadow: 0 1px 2px rgba(0,0,0,0.05) inset; }
        #user-input:focus { border-color: var(--input-border-focus); box-shadow: 0 0 0 3px color-mix(in srgb, var(--button-bg) 20%, transparent), 0 1px 2px rgba(0,0,0,0.05) inset; }
        #send-button { width: 44px; height: 44px; padding: 0; background-color: var(--button-bg); border: none; border-radius: var(--border-radius-round); cursor: pointer; font-size: 0; display: flex; justify-content: center; align-items: center; transition: background-color var(--transition-fast), transform var(--transition-fast), opacity var(--transition-fast), box-shadow var(--transition-fast); flex-shrink: 0; align-self: flex-end; box-shadow: var(--shadow-light); }
        #send-button:hover { background-color: var(--button-hover-bg); transform: scale(1.03); box-shadow: var(--shadow-medium); }
        #send-button:active { background-color: var(--button-active-bg); transform: scale(0.95); box-shadow: none; }
        #send-button::before { content: ''; display: block; width: 22px; height: 22px; background-color: var(--button-icon-fill); mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/%3E%3C/svg%3E'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/%3E%3C/svg%3E'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; transition: background-color var(--transition-medium); }
        #send-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: color-mix(in srgb, var(--button-bg) 50%, var(--input-area-bg)); transform: scale(1); box-shadow: none; }

        /* --- אנימצית טעינה "מגניבה" --- */
         .typing-indicator .message-content { color: var(--timestamp-color); }
         .cool-loading-container { display: flex; align-items: center; justify-content: flex-start; gap: 8px; padding: 4px 0; }
         .cool-loading-container span { font-size: 0.9em; animation: pulse-text 1.5s infinite ease-in-out; }
         .loading-spinner { width: 20px; height: 20px; border-radius: 50%; border: 3px solid var(--loading-spinner-color1); border-top-color: transparent; animation: cool-spinner 1s linear infinite; flex-shrink: 0; }
         @keyframes cool-spinner { to { transform: rotate(360deg); } }
         @keyframes pulse-text { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        #stop-generation-button { background: none; border: none; padding: 4px; margin: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: var(--border-radius-round); transition: background-color var(--transition-fast), transform var(--transition-fast); }
        #stop-generation-button svg { width: 16px; height: 16px; fill: var(--stop-button-fill); transition: fill var(--transition-fast); }
        #stop-generation-button:hover { background-color: var(--msg-action-icon-hover-bg); }
        #stop-generation-button:hover svg { fill: var(--stop-button-hover-fill); }
        #stop-generation-button:active { transform: scale(0.9); }

        *:focus-visible { outline: 2px solid var(--button-bg); outline-offset: 2px; border-radius: var(--border-radius-small); }
        #user-input:focus-visible { outline: none; }

    </style>
</head>
<body>

<div id="chat-container">
    <div id="chat-header">
        <h1>צ'אט AI</h1>
        <div class="header-controls">
            <select id="model-select" aria-label="בחר מודל AI">
                <option value="main-ai.php">Gemini 2 Flash</option>
                <option value="gemini25.php">Gemini 2.5 Pro</option>
            </select>
            <button class="icon-button" id="dark-mode-toggle" title="שנה ערכת נושא" aria-label="שנה ערכת נושא">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18v-8a2 2 0 0 0-2-2H4.08A8 8 0 0 1 12 4v8a2 2 0 0 0 2 2h5.92A8 8 0 0 1 12 20z"/></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>
            </button>
            <button class="icon-button" id="download-chat" title="הורד צ'אט" aria-label="הורד צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="icon-button" id="clear-chat" title="נקה צ'אט" aria-label="נקה צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>
    </div>
    <div id="chat-output" aria-live="polite">
        <div class="message ai-message" data-message-id="initial-0">
            <div class="message-content"><span>שלום! בחר מודל AI והתחל לשוחח.</span></div>
            <div class="message-footer"><span class="timestamp">התחל</span></div>
        </div>
         <button id="scroll-to-bottom" title="גלול לתחתית" aria-label="גלול לתחתית">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/><path d="M0 0h24v24H0V0z" fill="none"/></svg>
         </button>
    </div>
    <div id="chat-input-area">
        <textarea id="user-input" placeholder="הקלד/י הודעה..." rows="1" aria-label="הודעת משתמש"></textarea>
        <button id="send-button" aria-label="שלח"></button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');

        // --- State Variables ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/';
        let messageCounter = 0;
        let currentAbortController = null;
        let typingTimeout = null;
        const TYPING_SPEED = 10; // מהירות הקלדה
        const SCROLL_THRESHOLD = 150;

        // --- Utility Functions ---
        function getCurrentTimestamp() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }
        function generateMessageId() { return `msg-${Date.now()}-${messageCounter++}`; }
        function scrollToBottom(behavior = 'smooth') { if (behavior === 'smooth') { chatOutput.scrollTo({ top: chatOutput.scrollHeight, behavior: 'smooth' }); } else { chatOutput.scrollTop = chatOutput.scrollHeight; } }

        // --- Get Chat History Function ---
        function getChatHistory(currentUserMessage, forRegeneration = false, regenerationTargetMsgId = null) {
             const history = [];
             const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)');
             messages.forEach((msg) => {
                 const sender = msg.dataset.sender; const timestamp = msg.dataset.timestamp; const messageId = msg.dataset.messageId;
                 if (timestamp === 'התחל' && sender === 'ai') return;
                 if (forRegeneration && messageId === regenerationTargetMsgId && sender === 'ai') return;
                 const contentElement = msg.querySelector('.message-content'); let content = '';
                 contentElement.childNodes.forEach(node => { if (node.nodeType === Node.TEXT_NODE) { content += node.textContent; } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('copy-code-button')) { if (node.tagName === 'PRE') { content += node.textContent; } else { content += node.textContent; } } });
                 content = content.trim();
                 if (content) { const role = sender === 'user' ? 'user' : 'model'; history.push({ role: role, content: content }); }
             });
             return history;
         }

        // --- Add Message to Chat Function ---
        function addMessageToChat(text, sender, options = {}) {
            const { isLoading = false, timestamp = null, modelNameUsed = null, userQuery = null, modelValue = null } = options;
            const messageId = generateMessageId(); const messageDiv = document.createElement('div'); messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message'); messageDiv.dataset.sender = sender; messageDiv.dataset.messageId = messageId; const contentDiv = document.createElement('div'); contentDiv.classList.add('message-content');

            if (isLoading) {
                messageDiv.classList.add('typing-indicator');
                // --- אנימצית טעינה "מגניבה" ---
                contentDiv.innerHTML = `
                    <div class="cool-loading-container">
                        <div class="loading-spinner"></div>
                        <span>מעבד...</span>
                        <button id="stop-generation-button" class="msg-action-button stop-button" title="עצור יצירה" aria-label="עצור יצירה">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13H7v-2h10v2z"/></svg>
                        </button>
                    </div>`;
                messageDiv.appendChild(contentDiv);
                const stopButton = messageDiv.querySelector('#stop-generation-button');
                if (stopButton) { stopButton.addEventListener('click', stopTypingAndGeneration); }
            } else {
                if (sender === 'user') { contentDiv.textContent = text; }
                messageDiv.appendChild(contentDiv);
                const footerDiv = document.createElement('div'); footerDiv.classList.add('message-footer'); const currentTimestamp = timestamp || getCurrentTimestamp(); messageDiv.dataset.timestamp = currentTimestamp; if (sender === 'ai' && modelNameUsed && timestamp !== 'התחל') { const modelSpan = document.createElement('span'); modelSpan.classList.add('model-indicator'); modelSpan.textContent = `(${modelNameUsed})`; footerDiv.appendChild(modelSpan); messageDiv.dataset.userQuery = userQuery || ''; messageDiv.dataset.modelName = modelNameUsed || ''; messageDiv.dataset.modelValue = modelValue || ''; } const timestampSpan = document.createElement('span'); timestampSpan.classList.add('timestamp'); timestampSpan.textContent = currentTimestamp; footerDiv.appendChild(timestampSpan); messageDiv.appendChild(footerDiv); const actionsDiv = document.createElement('div'); actionsDiv.classList.add('message-actions'); const copyButton = document.createElement('button'); copyButton.classList.add('msg-action-button', 'copy-button'); copyButton.title = 'העתק הודעה'; copyButton.setAttribute('aria-label', 'העתק הודעה'); copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; copyButton.addEventListener('click', handleCopyClick); actionsDiv.appendChild(copyButton); if (sender === 'ai' && userQuery && modelValue && timestamp !== 'התחל') { const regenerateButton = document.createElement('button'); regenerateButton.classList.add('msg-action-button', 'regenerate-button'); regenerateButton.title = 'צור תגובה מחדש'; regenerateButton.setAttribute('aria-label', 'צור תגובה מחדש'); regenerateButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>'; regenerateButton.addEventListener('click', handleRegenerateClick); actionsDiv.appendChild(regenerateButton); } messageDiv.appendChild(actionsDiv);
            }
            chatOutput.insertBefore(messageDiv, scrollToBottomButton);
            if (!isLoading) { setTimeout(() => scrollToBottom('smooth'), 50); }
            else { chatOutput.scrollTop = chatOutput.scrollHeight; }
            return messageDiv;
        }

        // --- AI Typing Effect Function ---
         function typeAiResponse(messageElement, fullText) {
             const contentDiv = messageElement.querySelector('.message-content');
             if (!contentDiv) { console.error("Content div not found for typing"); return; }
             contentDiv.innerHTML = ''; messageElement.classList.add('typing-cursor');
             let nodeIndex = 0; const nodes = []; const tempDiv = document.createElement('div'); tempDiv.innerHTML = fullText;
             tempDiv.childNodes.forEach(node => nodes.push(node));
             clearTimeout(typingTimeout);

             function processNode() {
                 if (nodeIndex >= nodes.length) { finalizeAiMessage(messageElement, contentDiv); return; }
                 const currentNode = nodes[nodeIndex];
                 if (currentNode.nodeType === Node.TEXT_NODE) {
                     let textContent = currentNode.textContent; let charIndex = 0;
                     function typeChar() {
                         if (charIndex < textContent.length) { if (contentDiv.lastChild && contentDiv.lastChild.nodeType === Node.TEXT_NODE) { contentDiv.lastChild.textContent += textContent[charIndex]; } else { contentDiv.appendChild(document.createTextNode(textContent[charIndex])); } charIndex++; scrollToBottom('auto'); typingTimeout = setTimeout(typeChar, TYPING_SPEED); }
                         else { nodeIndex++; typingTimeout = setTimeout(processNode, TYPING_SPEED); }
                     }
                     typeChar();
                 } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
                     const clonedNode = currentNode.cloneNode(true); contentDiv.appendChild(clonedNode); if (clonedNode.tagName === 'PRE') { addCopyButtonToCodeBlock(clonedNode); } nodeIndex++; scrollToBottom('auto'); typingTimeout = setTimeout(processNode, TYPING_SPEED);
                 } else { nodeIndex++; processNode(); }
             }
             processNode();
         }

        // --- Finalize AI Message after typing/rendering ---
        function finalizeAiMessage(messageElement, contentDiv) {
             clearTimeout(typingTimeout); typingTimeout = null;
             if (messageElement) { messageElement.classList.remove('typing-cursor'); contentDiv.querySelectorAll('pre').forEach(addCopyButtonToCodeBlock); }
             scrollToBottom('smooth');
             if (!document.querySelector('.typing-indicator') && !typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; if (document.activeElement !== sendButton && document.activeElement !== modelSelect) { userInput.focus(); } }
        }

        // --- Stop Typing and Fetch Request ---
         function stopTypingAndGeneration() {
             console.log('Stopping generation...');
             clearTimeout(typingTimeout); typingTimeout = null;
             const typingIndicator = chatOutput.querySelector('.typing-indicator'); if (typingIndicator) typingIndicator.remove();
             const typingCursorMsg = chatOutput.querySelector('.typing-cursor'); if(typingCursorMsg) typingCursorMsg.classList.remove('typing-cursor');
             if (currentAbortController) { currentAbortController.abort(); currentAbortController = null; }
             else { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); const lastAiMsg = chatOutput.querySelector('.message.ai-message:last-child'); if (!lastAiMsg || lastAiMsg.querySelector('.message-footer')) { addMessageToChat('היצירה הופסקה.', 'ai', { modelNameUsed: 'N/A' }); } }
         }

        // --- Helper Function to Add Copy Button to Code Blocks ---
        function addCopyButtonToCodeBlock(preElement) {
             if (!preElement || preElement.querySelector('.copy-code-button')) return; const copyButton = document.createElement('button'); copyButton.textContent = 'העתק קוד'; copyButton.className = 'copy-code-button'; copyButton.setAttribute('aria-label', 'העתק קוד'); copyButton.addEventListener('click', (e) => { e.stopPropagation(); const codeElement = preElement.querySelector('code') || preElement; const codeToCopy = codeElement.textContent || ''; navigator.clipboard.writeText(codeToCopy).then(() => { copyButton.textContent = 'הועתק!'; copyButton.classList.add('copied'); setTimeout(() => { copyButton.textContent = 'העתק קוד'; copyButton.classList.remove('copied'); }, 1500); }).catch(err => { console.error('שגיאה בהעתקת קוד: ', err); copyButton.textContent = 'שגיאה'; }); }); preElement.appendChild(copyButton);
        }

        // --- Send Message Function ---
        async function sendMessage(textToSend, options = {}) {
             const { isRegeneration = false, originalAiMsgId = null, modelValueOverride = null, modelNameOverride = null } = options;
             const currentText = textToSend !== undefined ? textToSend.trim() : userInput.value.trim();
             if (currentText === '' || typingTimeout) return;

             userInput.disabled = true; sendButton.disabled = true; userInput.style.opacity = '0.7';

             if (!isRegeneration) { addMessageToChat(currentText, 'user', { timestamp: getCurrentTimestamp() }); userInput.value = ''; adjustTextareaHeight(); }
             else if (originalAiMsgId) { const oldAiMsg = chatOutput.querySelector(`.message[data-message-id="${originalAiMsgId}"]`); if (oldAiMsg) oldAiMsg.remove(); }

             const historyArray = getChatHistory( null, isRegeneration, originalAiMsgId );
             let historyStringPart = ""; historyArray.forEach(message => { historyStringPart += `[ROLE=${message.role}] ${message.content}\n`; }); historyStringPart = historyStringPart.trim();
             const combinedStructuredText = `[USER_INPUT_START]\n${currentText}\n[USER_INPUT_END]\n[CHAT_HISTORY_START]\n${historyStringPart}\n[CHAT_HISTORY_END]`;

             const selectedOption = modelValueOverride ? Array.from(modelSelect.options).find(opt => opt.value === modelValueOverride) || modelSelect.options[modelSelect.selectedIndex] : modelSelect.options[modelSelect.selectedIndex];
             const modelName = modelNameOverride || selectedOption.text; const selectedModelFile = selectedOption.value; const currentApiUrl = BASE_API_URL + selectedModelFile;

             const typingIndicatorElement = addMessageToChat(null, 'ai', { isLoading: true });
             currentAbortController = new AbortController(); const signal = currentAbortController.signal;

             try {
                 const requestBody = { text: combinedStructuredText };
                 const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal });
                 const wasAborted = signal.aborted;
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }
                 if (wasAborted) throw new DOMException('Aborted by user', 'AbortError');

                 if (!response.ok) { let errorText = `Server Error: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); if(errorData && errorData.error) errorText += ` - ${errorData.error}`; else if(errorData && errorData.message) errorText += ` - ${errorData.message}`; } catch (e) {} throw new Error(errorText); }

                 const data = await response.json();
                 if (data && data.text) {
                     const aiMessageElement = addMessageToChat('', 'ai', { timestamp: getCurrentTimestamp(), modelNameUsed: modelName, userQuery: currentText, modelValue: selectedModelFile });
                     typeAiResponse(aiMessageElement, data.text);
                 } else {
                     console.error("Invalid response format from server (after OK):", data);
                     addMessageToChat("Unexpected response format from server.", 'ai', { modelNameUsed: modelName });
                     if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 }
             } catch (error) {
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }
                 if (error.name === 'AbortError') {
                      console.log('Request aborted.');
                      if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 } else {
                      console.error("Error sending/receiving message:", error);
                      addMessageToChat(`שגיאה: ${error.message}`, 'ai', { modelNameUsed: modelName });
                      if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 }
             }
         }

        // --- UI Interaction Functions ---
        function toggleDarkMode(forceMode) { const body = document.body; let isDark; if (forceMode) isDark = (forceMode === 'dark'); else isDark = !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); themeIconLight.style.display = isDark ? 'none' : 'inline-block'; sunIcon.style.display = isDark ? 'inline-block' : 'none'; localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); updateSelectArrowColor(); }
        function updateSelectArrowColor() { const getEncodedColor = () => { try { const colorValue = getComputedStyle(document.documentElement).getPropertyValue('--select-arrow').trim(); const hexColor = colorValue.startsWith('#') ? colorValue.substring(1) : 'ffffff'; const validHex = /^[0-9A-Fa-f]{3}$|^[0-9A-Fa-f]{6}$/.test(hexColor); return encodeURIComponent(validHex ? hexColor : 'ffffff'); } catch (e) { console.error("Error getting computed style for --select-arrow", e); return 'ffffff'; } }; const encodedColor = getEncodedColor(); modelSelect.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg fill="%23${encodedColor}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>')`; }
        function downloadChat() { let chatContent = `AI Chat History (${new Date().toLocaleString('he-IL')})\nModel: ${modelSelect.options[modelSelect.selectedIndex].text}\n====================\n\n`; const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)'); messages.forEach(msg => { const sender = msg.dataset.sender === 'user' ? 'User' : 'AI'; const timestamp = msg.dataset.timestamp || ''; const modelInfo = msg.dataset.modelName ? ` (${msg.dataset.modelName})` : ''; const textContent = msg.querySelector('.message-content')?.textContent || msg.querySelector('.message-content')?.innerText || ''; if (timestamp === "התחל" && sender === "AI") return; chatContent += `[${timestamp}] ${sender}${modelInfo}: ${textContent.trim()}\n`; }); const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const now = new Date(); const filename = `ai_chat_log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.txt`; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
        function clearChat() { if (confirm("האם אתה בטוח שברצונך למחוק את כל ההודעות בצ'אט?")) { stopTypingAndGeneration(); chatOutput.innerHTML = ''; chatOutput.appendChild(scrollToBottomButton); addMessageToChat("בחר מודל AI והתחל לשוחח.", 'ai', { timestamp: 'התחל' }); messageCounter = 0; scrollToBottomButton.classList.remove('visible'); } }
        function handleUrlParameter() { const urlParams = new URLSearchParams(window.location.search); const conversationText = urlParams.get('conversation'); if (conversationText) { const decodedText = decodeURIComponent(conversationText).trim(); if (decodedText) { console.log("Sending conversation from URL parameter:", decodedText); setTimeout(() => sendMessage(decodedText), 100); } } }
        function adjustTextareaHeight() { userInput.style.height = 'auto'; const scrollHeight = userInput.scrollHeight; const maxHeight = parseInt(window.getComputedStyle(userInput).maxHeight, 10); if (scrollHeight > maxHeight) { userInput.style.height = `${maxHeight}px`; userInput.style.overflowY = 'auto'; } else { userInput.style.height = `${scrollHeight}px`; userInput.style.overflowY = 'hidden'; } }
        function handleCopyClick(event) { const button = event.currentTarget; const messageElement = button.closest('.message'); if (!messageElement) return; const contentElement = messageElement.querySelector('.message-content'); if (!contentElement) return; const textToCopy = contentElement.textContent || contentElement.innerText || ''; navigator.clipboard.writeText(textToCopy.trim()).then(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>'; button.classList.add('copied'); button.title = 'הועתק!'; setTimeout(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; button.classList.remove('copied'); button.title = 'העתק הודעה'; }, 1500); }).catch(err => { console.error('Failed to copy message: ', err); alert('לא ניתן היה להעתיק את ההודעה.'); }); }
        function handleRegenerateClick(event) { if (typingTimeout) return; const button = event.currentTarget; const messageElement = button.closest('.message.ai-message'); if (!messageElement) return; const userQuery = messageElement.dataset.userQuery; const modelValue = messageElement.dataset.modelValue; const modelName = messageElement.dataset.modelName; const messageId = messageElement.dataset.messageId; if (!userQuery || !modelValue || !modelName || !messageId) { console.error('Regen Error: Missing data', messageElement.dataset); return; } console.log(`Regenerating for: "${userQuery}" using ${modelName} (${modelValue}), replacing ${messageId}`); sendMessage(userQuery, { isRegeneration: true, originalAiMsgId: messageId, modelValueOverride: modelValue, modelNameOverride: modelName }); }
        function handleScroll() { const isScrolledUp = chatOutput.scrollHeight - chatOutput.scrollTop - chatOutput.clientHeight > SCROLL_THRESHOLD; scrollToBottomButton.classList.toggle('visible', isScrolledUp); }

        // --- Event Listeners Setup ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
        userInput.addEventListener('input', adjustTextareaHeight);
        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', clearChat);
        modelSelect.addEventListener('change', () => { localStorage.setItem('selectedModel', modelSelect.value); console.log(`Model changed to: ${modelSelect.value}`); });
        chatOutput.addEventListener('scroll', handleScroll);
        scrollToBottomButton.addEventListener('click', () => scrollToBottom('smooth'));

        // --- Initialization ---
        const savedModel = localStorage.getItem('selectedModel'); if (savedModel) { const isValidOption = Array.from(modelSelect.options).some(opt => opt.value === savedModel); if (isValidOption) modelSelect.value = savedModel; else localStorage.removeItem('selectedModel'); }
        const savedDarkMode = localStorage.getItem('darkMode'); if (savedDarkMode === 'enabled') toggleDarkMode('dark'); else toggleDarkMode('light');
        handleUrlParameter(); adjustTextareaHeight(); scrollToBottom('auto');
        console.log("Enhanced Chat interface V2.4 (Cool Loading Animation) initialized.");

    });
</script>

</body>
</html>
