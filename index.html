<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט AI - טקסט מובנה</title>
    <style>
        /* CSS נשאר זהה לחלוטין */
        :root { --bg-default: #e5ddd5; --chat-bg: #ffffff; --header-bg: #00a884; --header-text: #ffffff; --header-icon-fill: #ffffff; --user-msg-bg: #dcf8c6; --ai-msg-bg: #ffffff; --msg-text: #111b21; --input-area-bg: #f0f2f5; --input-bg: #ffffff; --input-text: #111b21; --button-bg: #008069; --button-hover-bg: #00a884; --button-icon-fill: #ffffff; --timestamp-color: rgba(17, 27, 33, 0.6); --model-indicator-color: rgba(17, 27, 33, 0.5); --border-color: #e9edef; --icon-button-hover-bg: rgba(0, 0, 0, 0.05); --msg-action-icon-fill: rgba(0, 0, 0, 0.4); --msg-action-icon-hover-fill: rgba(0, 0, 0, 0.6); --msg-action-icon-hover-bg: rgba(0, 0, 0, 0.08); --scrollbar-thumb: #c1c1c1; --scrollbar-track: #f0f0f0; --link-color: #007bff; --code-bg: #f5f5f5; --code-text: #333; --typing-indicator-dot: rgba(0, 0, 0, 0.5); --stop-button-fill: var(--msg-action-icon-fill); --stop-button-hover-fill: var(--msg-action-icon-hover-fill); --select-bg: rgba(255, 255, 255, 0.15); --select-border: rgba(255, 255, 255, 0.3); --select-text: var(--header-text); --select-arrow: var(--header-icon-fill); }
        body.dark-mode { --bg-default: #111b21; --chat-bg: #0d141a; --header-bg: #202c33; --header-text: #e9edef; --header-icon-fill: #aebac1; --user-msg-bg: #005c4b; --ai-msg-bg: #202c33; --msg-text: #e9edef; --input-area-bg: #1f2c34; --input-bg: #2a3942; --input-text: #e9edef; --button-bg: #00a884; --button-hover-bg: #008069; --button-icon-fill: #111b21; --timestamp-color: rgba(233, 237, 239, 0.6); --model-indicator-color: rgba(233, 237, 239, 0.5); --border-color: #2a3942; --icon-button-hover-bg: rgba(255, 255, 255, 0.08); --msg-action-icon-fill: rgba(255, 255, 255, 0.5); --msg-action-icon-hover-fill: rgba(255, 255, 255, 0.8); --msg-action-icon-hover-bg: rgba(255, 255, 255, 0.1); --scrollbar-thumb: #4a4a4a; --scrollbar-track: #202c33; --link-color: #58a6ff; --code-bg: #2a3942; --code-text: #f0f0f0; --typing-indicator-dot: rgba(255, 255, 255, 0.6); --stop-button-fill: var(--msg-action-icon-fill); --stop-button-hover-fill: var(--msg-action-icon-hover-fill); --select-bg: rgba(255, 255, 255, 0.08); --select-border: rgba(255, 255, 255, 0.15); --select-text: var(--header-text); --select-arrow: var(--header-icon-fill); }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; } body { font-family: Assistant, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--bg-default); color: var(--msg-text); display: flex; flex-direction: column; transition: background-color 0.3s ease, color 0.3s ease; } #chat-container { width: 100%; max-width: 800px; height: 100vh; margin: 0 auto; background-color: var(--chat-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; transition: background-color 0.3s ease; } #chat-header { background-color: var(--header-bg); color: var(--header-text); padding: 8px 10px; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); z-index: 10; transition: background-color 0.3s ease, color 0.3s ease; gap: 8px; flex-shrink: 0; } #chat-header h1 { margin: 0; font-size: 17px; font-weight: 600; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .header-controls { display: flex; align-items: center; gap: 5px; } #model-select { background-color: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border); border-radius: 6px; padding: 5px 25px 5px 8px; font-size: 13px; cursor: pointer; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23ffffff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 5px center; background-size: 18px; transition: background-color 0.3s ease, border-color 0.3s ease, background-image 0.3s ease; } #model-select option { background-color: var(--chat-bg); color: var(--msg-text); } body.dark-mode #model-select option { background-color: var(--input-bg); } .icon-button { background: none; border: none; padding: 7px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; } .icon-button:hover { background-color: var(--icon-button-hover-bg); } .icon-button svg { width: 20px; height: 20px; fill: var(--header-icon-fill); transition: fill 0.3s ease; } #chat-output { flex-grow: 1; padding: 15px 15px 10px 15px; overflow-y: auto; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-repeat: repeat; display: flex; flex-direction: column; scroll-behavior: smooth; } body.dark-mode #chat-output { background-image: none; background-color: var(--chat-bg); } #chat-output::-webkit-scrollbar { width: 6px; } #chat-output::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 3px; } #chat-output::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; } #chat-output::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--scrollbar-thumb) 70%, black); } #chat-output { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }
        .message { max-width: 75%; padding: 6px 12px 8px 12px; margin-bottom: 8px; border-radius: 12px; word-wrap: break-word; line-height: 1.45; font-size: 14.2px; color: var(--msg-text); box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; opacity: 0; animation: fadeIn 0.3s ease forwards; position: relative; } @keyframes fadeIn { to { opacity: 1; } } .user-message { background-color: var(--user-msg-bg); align-self: flex-start; margin-left: auto; border-bottom-left-radius: 4px; } body.dark-mode .user-message { color: var(--msg-text); } .ai-message { background-color: var(--ai-msg-bg); align-self: flex-end; margin-right: auto; border: 1px solid var(--border-color); border-bottom-right-radius: 4px; box-shadow: none; } .message-content {} .message-footer { display: flex; align-items: center; font-size: 11px; margin-top: 5px; gap: 8px; transition: color 0.3s ease; flex-wrap: wrap; } .model-indicator { color: var(--model-indicator-color); white-space: nowrap; } .timestamp { color: var(--timestamp-color); white-space: nowrap; } .user-message .message-footer { justify-content: flex-end; color: var(--timestamp-color); } .ai-message .message-footer { justify-content: flex-start; color: var(--timestamp-color); } .user-message .model-indicator { display: none; } .message-actions { position: absolute; top: 2px; display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s ease-in-out; background-color: color-mix(in srgb, var(--chat-bg) 80%, transparent); border-radius: 10px; padding: 1px 3px; z-index: 1; } .user-message .message-actions { left: 5px; } .ai-message .message-actions { right: 5px; } .message:hover .message-actions { opacity: 1; } .msg-action-button { background: none; border: none; padding: 3px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; } .msg-action-button svg { width: 16px; height: 16px; fill: var(--msg-action-icon-fill); transition: fill 0.2s ease; } .msg-action-button:hover { background-color: var(--msg-action-icon-hover-bg); } .msg-action-button:hover svg { fill: var(--msg-action-icon-hover-fill); } .msg-action-button.copied svg { fill: var(--button-bg); } .user-message .msg-action-button.regenerate-button { display: none; } .message-content pre { background-color: var(--code-bg); color: var(--code-text); padding: 10px; border-radius: 6px; overflow-x: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; margin: 8px 0; direction: ltr; text-align: left; white-space: pre; } .message-content code:not(pre > code) { background-color: var(--code-bg); color: var(--code-text); padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; direction: ltr; text-align: left; } body.dark-mode .message-content pre, body.dark-mode .message-content code:not(pre > code) { border: 1px solid var(--border-color); }
        #chat-input-area { display: flex; align-items: flex-end; padding: 8px 12px; border-top: 1px solid var(--border-color); background-color: var(--input-area-bg); flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; gap: 8px; } #user-input { flex-grow: 1; padding: 10px 18px; border: none; border-radius: 20px; font-size: 15px; background-color: var(--input-bg); color: var(--input-text); outline: none; transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.2s ease, height 0.1s ease; resize: none; overflow-y: hidden; min-height: 20px; max-height: 150px; line-height: 1.4; box-sizing: border-box; } #user-input:focus { box-shadow: 0 0 0 2px color-mix(in srgb, var(--button-bg) 30%, transparent); } #send-button { width: 40px; height: 40px; padding: 0; background-color: var(--button-bg); border: none; border-radius: 50%; cursor: pointer; font-size: 0; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.2s ease; flex-shrink: 0; align-self: flex-end; } #send-button:active { transform: scale(0.9); } #send-button::before { content: ''; display: block; width: 20px; height: 20px; background-color: var(--button-icon-fill); mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/%3E%3C/svg%3E'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/%3E%3C/svg%3E'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; transition: background-color 0.3s ease; } #send-button:hover { background-color: var(--button-hover-bg); } #send-button:disabled { opacity: 0.6; cursor: not-allowed; background-color: color-mix(in srgb, var(--button-bg) 50%, var(--input-area-bg)); }
        .typing-indicator span { display: inline-block; } .typing-indicator .dot { display: inline-block; width: 5px; height: 5px; background-color: var(--typing-indicator-dot); border-radius: 50%; margin: 0 1px; animation: typing-dots 1.4s linear infinite; } .typing-indicator .dot:nth-child(1) { animation-delay: -0.3s; } .typing-indicator .dot:nth-child(2) { animation-delay: -0.15s; } .typing-indicator .dot:nth-child(3) { animation-delay: 0s; } @keyframes typing-dots { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } } .typing-container { display: flex; align-items: center; gap: 8px; } #stop-generation-button { background: none; border: none; padding: 0; margin: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; transition: background-color 0.2s ease; } #stop-generation-button svg { width: 14px; height: 14px; fill: var(--stop-button-fill); transition: fill 0.2s ease; } #stop-generation-button:hover { background-color: var(--msg-action-icon-hover-bg); } #stop-generation-button:hover svg { fill: var(--stop-button-hover-fill); }
    </style>
</head>
<body>

<div id="chat-container">
    <!-- Header -->
    <div id="chat-header">
        <h1>צ'אט AI</h1>
        <div class="header-controls">
            <select id="model-select" aria-label="בחר מודל AI">
                 <option value="main-ai.php">Gemini 2 Flash</option>
                 <option value="gemini25.php">Gemini 2.5 Pro</option>
            </select>
            <button class="icon-button" id="dark-mode-toggle" title="שנה ערכת נושא" aria-label="שנה ערכת נושא">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18v-8a2 2 0 0 0-2-2H4.08A8 8 0 0 1 12 4v8a2 2 0 0 0 2 2h5.92A8 8 0 0 1 12 20z"/></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>
            </button>
            <button class="icon-button" id="download-chat" title="הורד צ'אט" aria-label="הורד צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="icon-button" id="clear-chat" title="נקה צ'אט" aria-label="נקה צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>
    </div>
    <!-- Chat Messages Area -->
    <div id="chat-output">
        <div class="message ai-message" data-message-id="initial-0">
            <div class="message-content"><span>שלום! בחר מודל AI והתחל לשוחח.</span></div>
            <div class="message-footer">
                 <span class="timestamp">התחל</span>
            </div>
        </div>
    </div>
    <!-- Input Area -->
    <div id="chat-input-area">
        <textarea id="user-input" placeholder="הקלד/י הודעה..." rows="1" aria-label="הודעת משתמש"></textarea>
        <button id="send-button" aria-label="שלח"></button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');

        // --- State Variables ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/'; // Replace with your actual API endpoint
        let messageCounter = 0;
        let currentAbortController = null;

        // --- Utility Functions ---
        function getCurrentTimestamp() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }
        function generateMessageId() { return `msg-${Date.now()}-${messageCounter++}`; }
        function scrollToBottom() { chatOutput.scrollTo({ top: chatOutput.scrollHeight, behavior: 'smooth' }); }

        // --- Get Chat History Function (returns array) ---
        function getChatHistory(currentUserMessage, forRegeneration = false, regenerationTargetMsgId = null) {
             const history = [];
             const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)');
             messages.forEach((msg) => {
                 const sender = msg.dataset.sender; const timestamp = msg.dataset.timestamp; const messageId = msg.dataset.messageId;
                 if (timestamp === 'התחל' && sender === 'ai') return;
                 if (forRegeneration && messageId === regenerationTargetMsgId && sender === 'ai') return;
                 const contentElement = msg.querySelector('.message-content'); const content = contentElement?.textContent?.trim() || '';
                 if (content) { const role = sender === 'user' ? 'user' : 'model'; history.push({ role: role, content: content }); }
             });
             // NOTE: currentUserMessage is NOT added here, it's handled in sendMessage
             // console.log("Generated History Array:", JSON.stringify(history));
             return history;
         }

        // --- Add Message to Chat Function ---
        function addMessageToChat(text, sender, options = {}) {
            const { isLoading = false, timestamp = null, modelNameUsed = null, userQuery = null, modelValue = null } = options;
            const messageId = generateMessageId(); const messageDiv = document.createElement('div'); messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message'); messageDiv.dataset.sender = sender; messageDiv.dataset.messageId = messageId; const contentDiv = document.createElement('div'); contentDiv.classList.add('message-content');
            if (isLoading) { messageDiv.classList.add('typing-indicator'); contentDiv.innerHTML = `<div class="typing-container"><span>מקליד</span><span class="dot"></span><span class="dot"></span><span class="dot"></span><button id="stop-generation-button" class="msg-action-button stop-button" title="עצור יצירה" aria-label="עצור יצירה"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13H7v-2h10v2z"/></svg></button></div>`; messageDiv.appendChild(contentDiv); const stopButton = messageDiv.querySelector('#stop-generation-button'); if (stopButton) { stopButton.addEventListener('click', () => { if (currentAbortController) { console.log('Abort request sent'); currentAbortController.abort(); } }); } }
            else { if (sender === 'ai') { if (/<[a-z][\s\S]*>/i.test(text)) { contentDiv.innerHTML = text; } else { contentDiv.textContent = text; } } else { contentDiv.textContent = text; } messageDiv.appendChild(contentDiv); const footerDiv = document.createElement('div'); footerDiv.classList.add('message-footer'); const currentTimestamp = timestamp || getCurrentTimestamp(); messageDiv.dataset.timestamp = currentTimestamp; if (sender === 'ai' && modelNameUsed && timestamp !== 'התחל') { const modelSpan = document.createElement('span'); modelSpan.classList.add('model-indicator'); modelSpan.textContent = `(${modelNameUsed})`; footerDiv.appendChild(modelSpan); messageDiv.dataset.userQuery = userQuery || ''; messageDiv.dataset.modelName = modelNameUsed || ''; messageDiv.dataset.modelValue = modelValue || ''; } const timestampSpan = document.createElement('span'); timestampSpan.classList.add('timestamp'); timestampSpan.textContent = currentTimestamp; footerDiv.appendChild(timestampSpan); messageDiv.appendChild(footerDiv); const actionsDiv = document.createElement('div'); actionsDiv.classList.add('message-actions'); const copyButton = document.createElement('button'); copyButton.classList.add('msg-action-button', 'copy-button'); copyButton.title = 'העתק הודעה'; copyButton.setAttribute('aria-label', 'העתק הודעה'); copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; copyButton.addEventListener('click', handleCopyClick); actionsDiv.appendChild(copyButton); if (sender === 'ai' && userQuery && modelValue && timestamp !== 'התחל') { const regenerateButton = document.createElement('button'); regenerateButton.classList.add('msg-action-button', 'regenerate-button'); regenerateButton.title = 'צור תגובה מחדש'; regenerateButton.setAttribute('aria-label', 'צור תגובה מחדש'); regenerateButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>'; regenerateButton.addEventListener('click', handleRegenerateClick); actionsDiv.appendChild(regenerateButton); } messageDiv.appendChild(actionsDiv); }
            chatOutput.appendChild(messageDiv); if (!isLoading) { setTimeout(scrollToBottom, 50); } else { chatOutput.scrollTop = chatOutput.scrollHeight; } return messageDiv;
        }

        // --- Send Message Function (Sends STRUCTURED text+history string) ---
        async function sendMessage(textToSend, options = {}) {
             const { isRegeneration = false, originalAiMsgId = null, modelValueOverride = null, modelNameOverride = null } = options;
             const currentText = textToSend !== undefined ? textToSend.trim() : userInput.value.trim();
             if (currentText === '') return;

             userInput.disabled = true; sendButton.disabled = true; userInput.style.opacity = '0.7';

             if (!isRegeneration) {
                 addMessageToChat(currentText, 'user', { timestamp: getCurrentTimestamp() });
                 userInput.value = ''; adjustTextareaHeight();
             } else if (originalAiMsgId) {
                  const oldAiMsg = chatOutput.querySelector(`.message[data-message-id="${originalAiMsgId}"]`);
                  if (oldAiMsg) oldAiMsg.remove();
             }

             // Get History Array
             const historyArray = getChatHistory( null, isRegeneration, originalAiMsgId );

             // Format History Array into the Structured String Part
             let historyStringPart = "";
             historyArray.forEach(message => {
                 historyStringPart += `[ROLE=${message.role}] ${message.content}\n`; // Add newline
             });
             historyStringPart = historyStringPart.trim(); // Remove trailing newline

             // Create the Final Combined Structured String
             const combinedStructuredText = `[USER_INPUT_START]\n${currentText}\n[USER_INPUT_END]\n[CHAT_HISTORY_START]\n${historyStringPart}\n[CHAT_HISTORY_END]`;

             // Determine model details
             const selectedOption = modelValueOverride ? Array.from(modelSelect.options).find(opt => opt.value === modelValueOverride) || modelSelect.options[modelSelect.selectedIndex] : modelSelect.options[modelSelect.selectedIndex];
             const modelName = modelNameOverride || selectedOption.text;
             const selectedModelFile = selectedOption.value;
             const currentApiUrl = BASE_API_URL + selectedModelFile;

             const typingIndicatorElement = addMessageToChat(null, 'ai', { isLoading: true });
             currentAbortController = new AbortController(); const signal = currentAbortController.signal;

             try {
                 console.log(`Sending request to: ${currentApiUrl} with model: ${modelName}`);
                 const requestBody = {
                     text: combinedStructuredText // Send the structured string under 'text'
                 };
                 console.log("Request Body (Structured Text):", JSON.stringify(requestBody));

                 const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal });
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }

                 if (!response.ok) {
                      let errorText = `Server Error: ${response.status} ${response.statusText}`;
                      try { const errorData = await response.json(); if(errorData && errorData.error) errorText += ` - ${errorData.error}`; else if(errorData && errorData.message) errorText += ` - ${errorData.message}`; } catch (e) {}
                      throw new Error(errorText);
                 }

                 const data = await response.json();
                 console.log("Received data from server:", data);
                 if (data && data.text) {
                     addMessageToChat(data.text, 'ai', { timestamp: getCurrentTimestamp(), modelNameUsed: modelName, userQuery: currentText, modelValue: selectedModelFile });
                 } else {
                     console.error("Invalid response format from server (after OK):", data);
                     addMessageToChat("Unexpected response format from server.", 'ai', { modelNameUsed: modelName });
                 }
             } catch (error) {
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }
                 if (error.name === 'AbortError') { console.log('Request aborted by user.'); addMessageToChat('Generation stopped.', 'ai', { modelNameUsed: modelName }); }
                 else { console.error("Error sending/receiving message:", error); addMessageToChat(`Error: ${error.message}`, 'ai', { modelNameUsed: modelName }); }
             } finally {
                  userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1';
                  if (!isRegeneration) userInput.focus();
             }
         }

        // --- UI Interaction Functions ---
        function toggleDarkMode(forceMode) { const body = document.body; let isDark; if (forceMode) isDark = (forceMode === 'dark'); else isDark = !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); themeIconLight.style.display = isDark ? 'none' : 'inline-block'; sunIcon.style.display = isDark ? 'inline-block' : 'none'; localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); updateSelectArrowColor(); }
        function updateSelectArrowColor() { const getEncodedColor = () => { try { const colorValue = getComputedStyle(document.documentElement).getPropertyValue('--select-arrow').trim(); const hexColor = colorValue.startsWith('#') ? colorValue.substring(1) : 'ffffff'; const validHex = /^[0-9A-Fa-f]{3}$|^[0-9A-Fa-f]{6}$/.test(hexColor); return encodeURIComponent(validHex ? hexColor : 'ffffff'); } catch (e) { console.error("Error getting computed style for --select-arrow", e); return 'ffffff'; } }; const encodedColor = getEncodedColor(); modelSelect.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg fill="%23${encodedColor}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>')`; }
        function downloadChat() { let chatContent = `AI Chat History (${new Date().toLocaleString('he-IL')})\nModel: ${modelSelect.options[modelSelect.selectedIndex].text}\n====================\n\n`; const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)'); messages.forEach(msg => { const sender = msg.dataset.sender === 'user' ? 'User' : 'AI'; const timestamp = msg.dataset.timestamp || ''; const modelInfo = msg.dataset.modelName ? ` (${msg.dataset.modelName})` : ''; const textContent = msg.querySelector('.message-content')?.textContent || msg.querySelector('.message-content')?.innerText || ''; if (timestamp === "התחל" && sender === "AI") return; chatContent += `[${timestamp}] ${sender}${modelInfo}: ${textContent.trim()}\n`; }); const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const now = new Date(); const filename = `ai_chat_log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.txt`; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
        function clearChat() { if (confirm("האם אתה בטוח שברצונך למחוק את כל ההודעות בצ'אט?")) { if (currentAbortController) currentAbortController.abort(); userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; chatOutput.innerHTML = ''; addMessageToChat("בחר מודל AI והתחל לשוחח.", 'ai', { timestamp: 'התחל' }); messageCounter = 0; } }
        function handleUrlParameter() { const urlParams = new URLSearchParams(window.location.search); const conversationText = urlParams.get('conversation'); if (conversationText) { const decodedText = decodeURIComponent(conversationText).trim(); if (decodedText) { console.log("Sending conversation from URL parameter:", decodedText); setTimeout(() => sendMessage(decodedText), 100); } } }
        function adjustTextareaHeight() { userInput.style.height = 'auto'; const scrollHeight = userInput.scrollHeight; const maxHeight = parseInt(window.getComputedStyle(userInput).maxHeight, 10); if (scrollHeight > maxHeight) { userInput.style.height = `${maxHeight}px`; userInput.style.overflowY = 'auto'; } else { userInput.style.height = `${scrollHeight}px`; userInput.style.overflowY = 'hidden'; } }
        function handleCopyClick(event) { const button = event.currentTarget; const messageElement = button.closest('.message'); if (!messageElement) return; const contentElement = messageElement.querySelector('.message-content'); if (!contentElement) return; const textToCopy = contentElement.textContent || contentElement.innerText || ''; navigator.clipboard.writeText(textToCopy.trim()).then(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>'; button.classList.add('copied'); button.title = 'הועתק!'; setTimeout(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; button.classList.remove('copied'); button.title = 'העתק הודעה'; }, 1500); }).catch(err => { console.error('Failed to copy message: ', err); alert('לא ניתן היה להעתיק את ההודעה.'); }); }
        function handleRegenerateClick(event) { const button = event.currentTarget; const messageElement = button.closest('.message.ai-message'); if (!messageElement) return; const userQuery = messageElement.dataset.userQuery; const modelValue = messageElement.dataset.modelValue; const modelName = messageElement.dataset.modelName; const messageId = messageElement.dataset.messageId; if (!userQuery || !modelValue || !modelName || !messageId) { console.error('Regen Error: Missing data', messageElement.dataset); return; } console.log(`Regenerating for: "${userQuery}" using ${modelName} (${modelValue}), replacing ${messageId}`); sendMessage(userQuery, { isRegeneration: true, originalAiMsgId: messageId, modelValueOverride: modelValue, modelNameOverride: modelName }); }

        // --- Event Listeners Setup ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
        userInput.addEventListener('input', adjustTextareaHeight);
        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', clearChat);
        modelSelect.addEventListener('change', () => { localStorage.setItem('selectedModel', modelSelect.value); console.log(`Model changed to: ${modelSelect.value}`); });

        // --- Initialization ---
        const savedModel = localStorage.getItem('selectedModel'); if (savedModel) { const isValidOption = Array.from(modelSelect.options).some(opt => opt.value === savedModel); if (isValidOption) modelSelect.value = savedModel; else localStorage.removeItem('selectedModel'); }
        const savedDarkMode = localStorage.getItem('darkMode'); if (savedDarkMode === 'enabled') toggleDarkMode('dark'); else toggleDarkMode('light');
        handleUrlParameter(); adjustTextareaHeight(); scrollToBottom();
        console.log("Chat interface initialized. Sending structured text string. Ensure PHP backend is updated to parse it correctly!");

    });
</script>

</body>
</html>
