<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט AI אולטימטיבי V4.0</title>
    <!-- Syntax Highlighting CSS (Choose a theme) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
    <!-- Font Awesome for Icons (Optional but used in examples) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- KaTeX for Math Rendering (Optional) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* --- V3.0 Variables + NEW --- */
        :root {
            /* Existing variables... */
            --font-main: Assistant, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-code: 'Consolas', 'Monaco', 'Courier New', monospace;
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --border-radius-large: 18px;
            --border-radius-avatar: 50%;
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
            --avatar-size: 30px;
            --message-spacing: 10px;
            --message-spacing-grouped: 3px;
            --message-horizontal-gap: 10px;

            /* NEW Variables */
            --header-height: 59px; /* Approximate */
            --input-area-min-height: 64px; /* Includes padding */
            --pinned-message-height: 40px;
            --reply-preview-height: 50px; /* NEW */
            --toolbar-height: 35px;
            --accent-color-light: #008069; /* Default light accent */
            --accent-color-dark: #00a884; /* Default dark accent */
            --accent-color: var(--accent-color-light); /* Default */
            --lm-accent-color: var(--accent-color-light);
            --dm-accent-color: var(--accent-color-dark);
            --lm-reply-bg: rgba(0, 0, 0, 0.05);
            --dm-reply-bg: rgba(255, 255, 255, 0.08);
            --lm-modal-bg: rgba(255, 255, 255, 0.95);
            --dm-modal-bg: rgba(30, 40, 50, 0.95);
            --lm-modal-shadow: 0 5px 15px rgba(0,0,0,0.2);
            --dm-modal-shadow: 0 5px 20px rgba(0,0,0,0.4);
            --lm-search-highlight-bg: #fff3cd;
            --dm-search-highlight-bg: #6a4d00;
            --lm-pinned-bg: #fffbeb; --lm-pinned-border: #ffeccc;
            --dm-pinned-bg: #2c3e50; --dm-pinned-border: #34495e;
            --lm-toolbar-bg: #e9edef; --lm-toolbar-button-hover: #d1d7db;
            --dm-toolbar-bg: #2a3942; --dm-toolbar-button-hover: #374151;
            --lm-tooltip-bg: #333; --lm-tooltip-text: #fff;
            --dm-tooltip-bg: #ddd; --dm-tooltip-text: #111;
            --lm-error-msg-bg: #fff0f0; --lm-error-msg-border: #ffcccc; --lm-error-msg-text: #c00;
            --dm-error-msg-bg: #4d1f1f; --dm-error-msg-border: #662d2d; --dm-error-msg-text: #ffdddd;
            --lm-reply-context-bg: rgba(0, 128, 105, 0.08); /* Light reply context bg */
            --dm-reply-context-bg: rgba(0, 168, 132, 0.15); /* Dark reply context bg */
            --lm-action-spinner-color: var(--lm-accent-color);
            --dm-action-spinner-color: var(--dm-accent-color);
            --lm-skeleton-bg: #e0e0e0;
            --dm-skeleton-bg: #374151;


            /* --- Light Mode --- */
            --lm-bg-default: #e5ddd5; --lm-chat-bg: #ffffff; --lm-header-bg: #00a884; --lm-header-bg-gradient: linear-gradient(to bottom, #00b09b, #00a884); --lm-header-text: #ffffff; --lm-header-icon-fill: #ffffff; --lm-user-msg-bg: #dcf8c6; --lm-ai-msg-bg: #ffffff; --lm-msg-text: #111b21; --lm-avatar-user-bg: #adff2f; --lm-avatar-ai-bg: #b0e0e6; --lm-input-area-bg: #f0f2f5; --lm-input-bg: #ffffff; --lm-input-text: #111b21; --lm-input-border: #e0e0e0; --lm-input-border-focus: var(--lm-accent-color); --lm-button-bg: var(--lm-accent-color); --lm-button-hover-bg: color-mix(in srgb, var(--lm-accent-color) 85%, #000); --lm-button-active-bg: color-mix(in srgb, var(--lm-accent-color) 70%, #000); --lm-button-icon-fill: #ffffff; --lm-timestamp-color: rgba(17, 27, 33, 0.6); --lm-model-indicator-color: rgba(17, 27, 33, 0.5); --lm-border-color: #e9edef; --lm-icon-button-hover-bg: rgba(0, 0, 0, 0.07); --lm-msg-action-icon-fill: rgba(0, 0, 0, 0.5); --lm-msg-action-icon-hover-fill: #000000; --lm-msg-action-icon-hover-bg: rgba(0, 0, 0, 0.09); --lm-scrollbar-thumb: #b0b0b0; --lm-scrollbar-track: #f5f5f5; --lm-link-color: #007bff; --lm-code-bg: #f8f9fa; --lm-code-text: #212529; --lm-code-border: #dee2e6; --lm-code-copy-btn-bg: rgba(0, 0, 0, 0.05); --lm-code-copy-btn-hover-bg: rgba(0, 0, 0, 0.1); --lm-code-copy-btn-copied-bg: var(--lm-button-bg); --lm-code-copy-btn-copied-text: #ffffff; --lm-loading-spinner-color1: var(--lm-accent-color); --lm-loading-spinner-color2: #dcf8c6; --lm-shadow-light: 0 1px 1px rgba(0, 0, 0, 0.06); --lm-shadow-medium: 0 2px 4px rgba(0, 0, 0, 0.08); --lm-scroll-btn-bg: rgba(255, 255, 255, 0.9); --lm-scroll-btn-icon: #54656f; --lm-scroll-btn-hover-bg: #ffffff; --lm-date-separator-bg: #e9e9e9; --lm-date-separator-text: #54656f; --lm-focus-outline: var(--lm-accent-color);

            /* --- Dark Mode --- */
            --dm-bg-default: #0f1a21; --dm-chat-bg: #0b141a; --dm-header-bg: #202c33; --dm-header-bg-gradient: linear-gradient(to bottom, #2a3942, #202c33); --dm-header-text: #e9edef; --dm-header-icon-fill: #aebac1; --dm-user-msg-bg: #005c4b; --dm-ai-msg-bg: #202c33; --dm-msg-text: #e9edef; --dm-avatar-user-bg: #008069; --dm-avatar-ai-bg: #345665; --dm-input-area-bg: #1f2c34; --dm-input-bg: #2a3942; --dm-input-text: #e9edef; --dm-input-border: #374151; --dm-input-border-focus: var(--dm-accent-color); --dm-button-bg: var(--dm-accent-color); --dm-button-hover-bg: color-mix(in srgb, var(--dm-accent-color) 85%, #fff); --dm-button-active-bg: color-mix(in srgb, var(--dm-accent-color) 70%, #fff); --dm-button-icon-fill: #111b21; --dm-timestamp-color: rgba(233, 237, 239, 0.65); --dm-model-indicator-color: rgba(233, 237, 239, 0.55); --dm-border-color: #2a3942; --dm-icon-button-hover-bg: rgba(255, 255, 255, 0.08); --dm-msg-action-icon-fill: rgba(255, 255, 255, 0.6); --dm-msg-action-icon-hover-fill: #ffffff; --dm-msg-action-icon-hover-bg: rgba(255, 255, 255, 0.1); --dm-scrollbar-thumb: #4a4a4a; --dm-scrollbar-track: #1a242b; --dm-link-color: #58a6ff; --dm-code-bg: #182128; --dm-code-text: #d1d5db; --dm-code-border: #374151; --dm-code-copy-btn-bg: rgba(255, 255, 255, 0.1); --dm-code-copy-btn-hover-bg: rgba(255, 255, 255, 0.15); --dm-code-copy-btn-copied-bg: var(--dm-button-bg); --dm-code-copy-btn-copied-text: #111b21; --dm-loading-spinner-color1: var(--dm-accent-color); --dm-loading-spinner-color2: #005c4b; --dm-shadow-light: 0 1px 1px rgba(0, 0, 0, 0.25); --dm-shadow-medium: 0 2px 5px rgba(0, 0, 0, 0.3); --dm-scroll-btn-bg: rgba(42, 57, 66, 0.9); --dm-scroll-btn-icon: #aebac1; --dm-scroll-btn-hover-bg: #2a3942; --dm-date-separator-bg: #2a3942; --dm-date-separator-text: #aebac1; --dm-focus-outline: var(--dm-accent-color);


             /* Default Assign Light */
             --bg-default: var(--lm-bg-default); --chat-bg: var(--lm-chat-bg); /* ... other light vars ... */
             --accent-color: var(--lm-accent-color); --reply-bg: var(--lm-reply-bg);
             --modal-bg: var(--lm-modal-bg); --modal-shadow: var(--lm-modal-shadow);
             --pinned-bg: var(--lm-pinned-bg); --pinned-border: var(--lm-pinned-border);
             --toolbar-bg: var(--lm-toolbar-bg); --toolbar-button-hover: var(--lm-toolbar-button-hover);
             --tooltip-bg: var(--lm-tooltip-bg); --tooltip-text: var(--lm-tooltip-text);
             --error-msg-bg: var(--lm-error-msg-bg); --error-msg-border: var(--lm-error-msg-border);
             --error-msg-text: var(--lm-error-msg-text);
             --search-highlight-bg: var(--lm-search-highlight-bg);
             --reply-context-bg: var(--lm-reply-context-bg);
             --action-spinner-color: var(--lm-action-spinner-color);
             --skeleton-bg: var(--lm-skeleton-bg);
             /* Assign all other LM vars */
             --header-bg: var(--lm-header-bg); --header-bg-image: var(--lm-header-bg-gradient); --header-text: var(--lm-header-text); --header-icon-fill: var(--lm-header-icon-fill); --user-msg-bg: var(--lm-user-msg-bg); --ai-msg-bg: var(--lm-ai-msg-bg); --msg-text: var(--lm-msg-text); --avatar-user-bg: var(--lm-avatar-user-bg); --avatar-ai-bg: var(--lm-avatar-ai-bg); --input-area-bg: var(--lm-input-area-bg); --input-bg: var(--lm-input-bg); --input-text: var(--lm-input-text); --input-border: var(--lm-input-border); --input-border-focus: var(--lm-input-border-focus); --button-bg: var(--lm-button-bg); --button-hover-bg: var(--lm-button-hover-bg); --button-active-bg: var(--lm-button-active-bg); --button-icon-fill: var(--lm-button-icon-fill); --timestamp-color: var(--lm-timestamp-color); --model-indicator-color: var(--lm-model-indicator-color); --border-color: var(--lm-border-color); --icon-button-hover-bg: var(--lm-icon-button-hover-bg); --msg-action-icon-fill: var(--lm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--lm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--lm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--lm-scrollbar-thumb); --scrollbar-track: var(--lm-scrollbar-track); --link-color: var(--lm-link-color); --code-bg: var(--lm-code-bg); --code-text: var(--lm-code-text); --code-border: var(--lm-code-border); --code-copy-btn-bg: var(--lm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--lm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--lm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--lm-code-copy-btn-copied-text); --loading-spinner-color1: var(--lm-loading-spinner-color1); --loading-spinner-color2: var(--lm-loading-spinner-color2); --shadow-light: var(--lm-shadow-light); --shadow-medium: var(--lm-shadow-medium); --scroll-btn-bg: var(--lm-scroll-btn-bg); --scroll-btn-icon: var(--lm-scroll-btn-icon); --scroll-btn-hover-bg: var(--lm-scroll-btn-hover-bg); --date-separator-bg: var(--lm-date-separator-bg); --date-separator-text: var(--lm-date-separator-text); --focus-outline-color: var(--lm-focus-outline);
             --select-bg: rgba(255, 255, 255, 0.15); --select-border: rgba(255, 255, 255, 0.3); --select-text: var(--lm-header-text); --select-arrow: var(--lm-header-icon-fill); --stop-button-fill: var(--lm-msg-action-icon-fill); --stop-button-hover-fill: var(--lm-msg-action-icon-hover-fill);

        }
        body.dark-mode {
             /* Assign all DM vars */
             --bg-default: var(--dm-bg-default); --chat-bg: var(--dm-chat-bg); /* ... other dark vars ... */
             --accent-color: var(--dm-accent-color); --reply-bg: var(--dm-reply-bg);
             --modal-bg: var(--dm-modal-bg); --modal-shadow: var(--dm-modal-shadow);
             --pinned-bg: var(--dm-pinned-bg); --pinned-border: var(--dm-pinned-border);
             --toolbar-bg: var(--dm-toolbar-bg); --toolbar-button-hover: var(--dm-toolbar-button-hover);
             --tooltip-bg: var(--dm-tooltip-bg); --tooltip-text: var(--dm-tooltip-text);
             --error-msg-bg: var(--dm-error-msg-bg); --error-msg-border: var(--dm-error-msg-border);
             --error-msg-text: var(--dm-error-msg-text);
             --search-highlight-bg: var(--dm-search-highlight-bg);
             --reply-context-bg: var(--dm-reply-context-bg);
             --action-spinner-color: var(--dm-action-spinner-color);
             --skeleton-bg: var(--dm-skeleton-bg);
             /* Assign all other DM vars */
             --header-bg: var(--dm-header-bg); --header-bg-image: var(--dm-header-bg-gradient); --header-text: var(--dm-header-text); --header-icon-fill: var(--dm-header-icon-fill); --user-msg-bg: var(--dm-user-msg-bg); --ai-msg-bg: var(--dm-ai-msg-bg); --msg-text: var(--dm-msg-text); --avatar-user-bg: var(--dm-avatar-user-bg); --avatar-ai-bg: var(--dm-avatar-ai-bg); --input-area-bg: var(--dm-input-area-bg); --input-bg: var(--dm-input-bg); --input-text: var(--dm-input-text); --input-border: var(--dm-input-border); --input-border-focus: var(--dm-input-border-focus); --button-bg: var(--dm-button-bg); --button-hover-bg: var(--dm-button-hover-bg); --button-active-bg: var(--dm-button-active-bg); --button-icon-fill: var(--dm-button-icon-fill); --timestamp-color: var(--dm-timestamp-color); --model-indicator-color: var(--dm-model-indicator-color); --border-color: var(--dm-border-color); --icon-button-hover-bg: var(--dm-icon-button-hover-bg); --msg-action-icon-fill: var(--dm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--dm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--dm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--dm-scrollbar-thumb); --scrollbar-track: var(--dm-scrollbar-track); --link-color: var(--dm-link-color); --code-bg: var(--dm-code-bg); --code-text: var(--dm-code-text); --code-border: var(--dm-code-border); --code-copy-btn-bg: var(--dm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--dm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--dm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--dm-code-copy-btn-copied-text); --loading-spinner-color1: var(--dm-loading-spinner-color1); --loading-spinner-color2: var(--dm-loading-spinner-color2); --shadow-light: var(--dm-shadow-light); --shadow-medium: var(--dm-shadow-medium); --scroll-btn-bg: var(--dm-scroll-btn-bg); --scroll-btn-icon: var(--dm-scroll-btn-icon); --scroll-btn-hover-bg: var(--dm-scroll-btn-hover-bg); --date-separator-bg: var(--dm-date-separator-bg); --date-separator-text: var(--dm-date-separator-text); --focus-outline-color: var(--dm-focus-outline);
             --select-bg: rgba(255, 255, 255, 0.08); --select-border: rgba(255, 255, 255, 0.15); --select-text: var(--dm-header-text); --select-arrow: var(--dm-header-icon-fill); --stop-button-fill: var(--dm-msg-action-icon-fill); --stop-button-hover-fill: var(--dm-msg-action-icon-hover-fill);
        }

        /* --- Base & Layout --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: var(--font-main); background-color: var(--bg-default); color: var(--msg-text); display: flex; flex-direction: column; transition: background-color var(--transition-medium), color var(--transition-medium); font-size: 14.5px; }
        * { box-sizing: border-box; scroll-behavior: smooth; /* Base smooth scroll */ }
        #chat-container { width: 100%; max-width: 950px; /* Even wider */ height: calc(100vh - 20px); margin: 10px auto; background-color: var(--chat-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; transition: background-color var(--transition-medium), box-shadow var(--transition-medium); box-shadow: var(--shadow-medium); border-radius: var(--border-radius-medium); }

        /* Compact Mode */
        body.compact-mode { font-size: 13.5px; }
        body.compact-mode #chat-container { max-width: 1100px; }
        body.compact-mode .message { padding: 6px 12px; line-height: 1.45; }
        body.compact-mode .message-wrapper { --message-spacing: 6px; --message-spacing-grouped: 2px; }
        body.compact-mode .avatar-placeholder { --avatar-size: 26px; }
        body.compact-mode #chat-input-area { padding: 8px 12px; --input-area-min-height: 56px; }
        body.compact-mode #user-input { padding: 9px 15px; min-height: 38px; }
        body.compact-mode #send-button { width: 38px; height: 38px; }
        body.compact-mode #send-button::before { width: 20px; height: 20px; }
        body.compact-mode #pinned-message { height: 35px; font-size: 12px; }
        body.compact-mode #reply-preview { height: 45px; font-size: 12px; }
        body.compact-mode #input-toolbar { height: 30px; }

        /* Rounded Mode */
        body.rounded-mode { --border-radius-medium: 16px; --border-radius-large: 24px; }
        body.rounded-mode .avatar-placeholder { border-radius: 40%; } /* Squircle */
        body.rounded-mode #user-input { border-radius: 22px; }
        body.rounded-mode #send-button { border-radius: 22px; }
        body.rounded-mode .date-separator { border-radius: 20px; }
        body.rounded-mode #pinned-message { border-radius: var(--border-radius-medium); margin: 5px; height: calc(var(--pinned-message-height) - 10px);}
        body.rounded-mode #reply-preview { border-top-left-radius: var(--border-radius-medium); border-top-right-radius: var(--border-radius-medium); }
        body.rounded-mode .modal-content { border-radius: var(--border-radius-large); }


        /* --- Header --- */
        #chat-header {
            display: flex; /* Ensure flex for centering */
            align-items: center; /* Vertical centering */
            height: var(--header-height);
            padding: 0 16px; /* Adjusted padding */
            background-color: var(--header-bg);
            background-image: var(--header-bg-image);
            color: var(--header-text);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
            flex-shrink: 0;
            border-top-left-radius: var(--border-radius-medium); border-top-right-radius: var(--border-radius-medium);
             transition: background-color var(--transition-medium), color var(--transition-medium), background-image var(--transition-medium), opacity var(--transition-fast);
        }
        #chat-header.model-changing { opacity: 0.8; }
        #chat-header h1 { margin: 0; font-size: 18px; font-weight: 600; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        #chat-header h1:hover { opacity: 0.8; }
        #chat-header h1:focus { outline: 1px dashed var(--header-text); } /* Focus style for editing */
        .header-controls { display: flex; align-items: center; gap: 6px; }
        .icon-button { background: none; border: none; padding: 8px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-fast); color: var(--header-icon-fill); } /* Set color */
        .icon-button:hover { background-color: var(--icon-button-hover-bg); transform: scale(1.05); }
        .icon-button:active { transform: scale(0.92); }
        .icon-button svg, .icon-button i { width: 22px; height: 22px; fill: var(--header-icon-fill); font-size: 20px; /* For FontAwesome */ }

        /* NEW: Search Bar in Header */
        .header-search-container { display: none; align-items: center; background-color: var(--chat-bg); padding: 5px 10px; position: absolute; top: 0; left: 0; right: 0; height: 100%; z-index: 11; animation: slideDownFadeIn 0.3s ease forwards; }
        .header-search-container.active { display: flex; }
        @keyframes slideDownFadeIn { from { opacity: 0; transform: translateY(-100%); } to { opacity: 1; transform: translateY(0); } }
        #chat-search-input { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-large); background-color: var(--input-bg); color: var(--input-text); outline: none; font-size: 14px; }
        #search-results-count { font-size: 12px; color: var(--timestamp-color); margin: 0 8px; white-space: nowrap; }
        #search-prev-button, #search-next-button, #search-close-button { padding: 6px; color: var(--msg-action-icon-fill); } /* Use message action color */
        #search-prev-button:hover, #search-next-button:hover, #search-close-button:hover { background-color: var(--icon-button-hover-bg); color: var(--msg-action-icon-hover-fill); }

        /* --- Pinned Message Area --- */
        #pinned-message {
            display: none; flex-shrink: 0; height: var(--pinned-message-height);
            background-color: var(--pinned-bg); border-bottom: 1px solid var(--pinned-border);
            padding: 0 16px; align-items: center; font-size: 13px;
            color: var(--msg-text); cursor: pointer; overflow: hidden;
            position: relative;
            transition: background-color var(--transition-medium), border-color var(--transition-medium), color var(--transition-medium), height var(--transition-fast);
        }
        #pinned-message.visible { display: flex; }
        #pinned-message:hover { background-color: color-mix(in srgb, var(--pinned-bg) 90%, var(--border-color)); }
        #pinned-message .pinned-icon { margin-left: 8px; font-size: 14px; color: var(--timestamp-color); flex-shrink: 0; }
        #pinned-message .pinned-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        #unpin-button { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; padding: 5px; cursor: pointer; border-radius: 50%; line-height: 0; display: flex; align-items: center; justify-content: center;}
        #unpin-button:hover { background-color: rgba(0,0,0,0.1); }
        #unpin-button svg, #unpin-button i { width: 16px; height: 16px; fill: var(--timestamp-color); color: var(--timestamp-color); }


        /* --- Chat Output --- */
        #chat-output {
            flex-grow: 1; /* Takes remaining space */
            padding: 15px 15px 5px 15px; overflow-y: auto;
            display: flex; flex-direction: column; position: relative;
            background-color: transparent; /* Base transparent */
             /* Height calculation is now complex, better handle dynamically or rely on flex-grow */
         }
         /* Background images remain same */
         body:not(.dark-mode) #chat-output { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-repeat: repeat; }
         body.dark-mode #chat-output { background-color: var(--chat-bg); }
         /* Scrollbar styles remain same */
        #chat-output::-webkit-scrollbar { width: 8px; }
        #chat-output::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 4px; }
        #chat-output::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; border: 1px solid var(--scrollbar-track); }
        #chat-output::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--scrollbar-thumb) 70%, #000000); }
        #chat-output { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }

        /* --- Scroll Buttons --- */
        #scroll-to-bottom, #scroll-to-top {
            position: absolute; left: 20px;
            background-color: var(--scroll-btn-bg); backdrop-filter: blur(5px);
            border: 1px solid color-mix(in srgb, var(--border-color) 50%, transparent);
            border-radius: var(--border-radius-round); width: 38px; height: 38px;
            padding: 0; cursor: pointer; display: none; align-items: center; justify-content: center;
            box-shadow: var(--shadow-medium); opacity: 0;
            transition: opacity var(--transition-medium), transform var(--transition-medium), background-color var(--transition-fast);
            z-index: 20; color: var(--scroll-btn-icon); /* Color for FontAwesome */
        }
        #scroll-to-bottom { bottom: 75px; transform: translateY(10px); }
        #scroll-to-top { top: 70px; transform: translateY(-10px); } /* Position top */
        #scroll-to-bottom.visible, #scroll-to-top.visible { display: flex; opacity: 0.85; transform: translateY(0); }
        #scroll-to-bottom:hover, #scroll-to-top:hover { opacity: 1; background-color: var(--scroll-btn-hover-bg); transform: scale(1.05) translateY(0); }
        #scroll-to-bottom svg, #scroll-to-top svg, #scroll-to-bottom i, #scroll-to-top i { width: 22px; height: 22px; fill: var(--scroll-btn-icon); font-size: 18px; }

        /* Date Separator Styles remain same */
        .date-separator { align-self: center; background-color: var(--date-separator-bg); /* ... */ }

        /* --- Messages --- */
        /* Wrapper, Avatar, Base Message styles remain largely same */
        .message-wrapper { display: flex; margin-bottom: var(--message-spacing); opacity: 0; animation: fadeInSlideUp 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; align-items: flex-end; position: relative; /* For context menu */ }
        .message-wrapper.grouped { margin-bottom: var(--message-spacing-grouped); }
        .avatar-placeholder { /* ... */ }
        .user-message-wrapper { flex-direction: row-reverse; }
        .ai-message-wrapper { flex-direction: row; }
        .message { max-width: calc(78% - var(--avatar-size) - var(--message-horizontal-gap)); padding: 9px 15px; border-radius: var(--border-radius-large); word-wrap: break-word; line-height: 1.55; font-size: 14.8px; color: var(--msg-text); box-shadow: var(--shadow-light); transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-medium); position: relative; outline: none; /* For tabindex focus */ }
        .message:focus-visible { box-shadow: 0 0 0 2px var(--focus-outline-color); /* Focus indicator */ }
        .user-message { background-color: var(--user-msg-bg); margin-left: auto; border-bottom-left-radius: var(--border-radius-medium); }
        .ai-message { background-color: var(--ai-msg-bg); margin-right: auto; border: 1px solid var(--border-color); border-bottom-right-radius: var(--border-radius-medium); box-shadow: none; }
        .message-wrapper.grouped .message { border-bottom-left-radius: var(--border-radius-large); border-bottom-right-radius: var(--border-radius-large); }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing cursor style remains same */
        .ai-message.typing-cursor .message-content::after { /* ... */ }

        /* Content Styling (Markdown, Code, etc.) */
        .message-content { padding-bottom: 2px; min-height: 1.55em; }
        .message-content strong { font-weight: 600; }
        .message-content em { font-style: italic; }
        .message-content ul, .message-content ol { padding-right: 25px; margin: 8px 0; }
        .message-content li { margin-bottom: 4px; }
        .message-content a { color: var(--link-color); text-decoration: underline; text-underline-offset: 3px; }
        .message-content a:hover { text-decoration: none; opacity: 0.8; }
        .message-content a[target="_blank"]::after { /* External link icon */ content: ' \f08e'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 0.8em; margin-left: 3px; opacity: 0.7; }
        .message-content code:not(pre > code) { /* ... inline code ... */ }
        .message-content pre { /* ... code block ... */ }
        /* Highlight.js styles applied by library */
        .message-content pre .copy-code-button { /* ... copy button ... */ }
        .message-content img { max-width: 100%; height: auto; border-radius: var(--border-radius-medium); margin-top: 5px; cursor: pointer; }
        /* Table styling */
        .message-content table { width: 100%; border-collapse: collapse; margin: 10px 0; direction: rtl; text-align: right; }
        .message-content th, .message-content td { border: 1px solid var(--border-color); padding: 6px 10px; }
        .message-content th { background-color: var(--input-area-bg); font-weight: 600; }
        /* KaTeX Math Styling */
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 5px 0; } /* Allow horizontal scroll for wide equations */

        /* Search Highlight */
        .message.highlighted { /* Style when scrolled to via search */ box-shadow: 0 0 0 3px var(--accent-color); transition: box-shadow 0.5s ease; }
        mark.search-highlight { /* Style for the specific term */ background-color: var(--search-highlight-bg); color: inherit; padding: 0.1em 0; border-radius: var(--border-radius-small); box-shadow: 0 0 0 1px var(--search-highlight-bg); }

        /* Error Message Style */
        .message.error-message { background-color: var(--error-msg-bg); border: 1px solid var(--error-msg-border); color: var(--error-msg-text); }
        .message.error-message .model-indicator { color: var(--error-msg-text) !important; opacity: 0.8; }

        /* Reply Context Style */
        .reply-context {
            background-color: var(--reply-context-bg);
            padding: 5px 10px; margin: -5px -10px 8px -10px; /* Extend slightly into padding */
            border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
            border-bottom: 1px dashed color-mix(in srgb, var(--border-color) 50%, transparent);
            font-size: 0.9em; opacity: 0.85; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .reply-context i { font-size: 0.9em; }
        .reply-context strong { margin-left: 3px; }
        .reply-context:hover { opacity: 1; }


        /* Message Footer */
        .message-footer { display: flex; align-items: center; font-size: 11.5px; margin-top: 6px; gap: 8px; transition: color var(--transition-medium); flex-wrap: wrap; opacity: 0.85; justify-content: flex-end; /* Default align end */ }
        .ai-message .message-footer { justify-content: flex-start; /* AI aligns start */}
        .model-indicator { color: var(--model-indicator-color); white-space: nowrap; font-weight: 500; margin-right: auto; /* Push left for AI */ }
        .user-message .model-indicator { display: none; }
        .timestamp { color: var(--timestamp-color); white-space: nowrap; }
        /* Read receipts (Visual Only) */
        .message-footer .read-receipts { margin-left: 5px; font-size: 14px; color: var(--timestamp-color); line-height: 1; order: 1; /* Ensure it's at the very end */ }
        .message-footer .read-receipts.sent::before { content: '✓'; }
        .message-footer .read-receipts.delivered::before { content: '✓✓'; }
        .message-footer .read-receipts.read::before { content: '✓✓'; color: #4fc3f7; }
        .ai-message .message-footer .read-receipts { display: none; }

        /* Message Actions */
        .message-actions { position: absolute; top: -12px; display: flex; gap: 5px; opacity: 0; transition: opacity var(--transition-fast), transform var(--transition-fast); background-color: color-mix(in srgb, var(--chat-bg) 90%, transparent); backdrop-filter: blur(4px); border-radius: var(--border-radius-large); padding: 4px 6px; z-index: 1; pointer-events: none; box-shadow: var(--shadow-medium); }
        .user-message-wrapper .message-actions { left: -10px; transform: translateX(-100%) translateY(0) scale(0.9); }
        .ai-message-wrapper .message-actions { right: -10px; transform: translateX(100%) translateY(0) scale(0.9); }
        .message-wrapper:hover .message-actions, .message:focus-within + .message-actions /* Show on focus */ { opacity: 1; transform: translateX(0) translateY(0) scale(1); pointer-events: auto; }
        .msg-action-button { background: none; border: none; padding: 5px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-fast); color: var(--msg-action-icon-fill); position: relative; /* For spinner */ }
        .msg-action-button i { font-size: 16px; line-height: 1; } /* Icon size */
        .msg-action-button:hover { background-color: var(--msg-action-icon-hover-bg); transform: scale(1.1); color: var(--msg-action-icon-hover-fill); }
        .msg-action-button:active { transform: scale(0.95); }
        .msg-action-button.copied { animation: copied-feedback 0.6s ease-out; }
        .msg-action-button.copied i::before { content: "\f00c"; /* Checkmark icon */ } /* Show check on copy */
        @keyframes copied-feedback { /* ... existing ... */ }
        .msg-action-button.active { background-color: var(--msg-action-icon-hover-bg); color: var(--accent-color); } /* Style for active pin/star */
        /* Tooltip styles remain same */
        .msg-action-button[title]::after { /* ... */ }
        /* Action Spinner */
        .action-spinner {
            display: none; /* Hidden by default */
            width: 12px; height: 12px; border-radius: 50%; margin: 0 2px;
            border: 2px solid var(--action-spinner-color); border-top-color: transparent;
            animation: cool-spinner 0.6s linear infinite;
        }
        .msg-action-button:disabled .action-spinner { display: inline-block; }
        .msg-action-button:disabled i { display: none; } /* Hide icon when spinner shows */


        /* Collapsible Code Block */
        .message-content pre.collapsible { max-height: 200px; overflow: hidden; position: relative; transition: max-height var(--transition-medium); padding-bottom: 30px; /* Space for button */ }
        .message-content pre.collapsible::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(to bottom, transparent, var(--code-bg)); pointer-events: none; }
        .message-content pre.collapsible.expanded { max-height: 1000px; padding-bottom: 12px; }
        .message-content pre.collapsible.expanded::after { display: none; }
        .expand-code-button { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); background-color: var(--code-copy-btn-hover-bg); /* ... */ }
        .message-content pre.collapsible.expanded .expand-code-button { content: 'הצג פחות'; }


        /* --- Input Area --- */
        /* Reply Preview */
        #reply-preview {
            display: none; height: var(--reply-preview-height);
            background-color: var(--reply-bg); padding: 8px 14px;
            border-top: 1px solid var(--border-color); flex-shrink: 0;
            align-items: center; font-size: 13px; color: var(--msg-text);
            position: relative; overflow: hidden;
            transition: height var(--transition-fast), padding var(--transition-fast);
        }
        #reply-preview.visible { display: flex; }
        #reply-preview .reply-icon { margin-left: 8px; color: var(--accent-color); flex-shrink: 0;}
        #reply-preview .reply-content-wrapper { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        #reply-preview .reply-sender { font-weight: 600; font-size: 0.95em; }
        #reply-preview .reply-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8; }
        #cancel-reply-button { /* ... */ }

        /* Input Toolbar */
        #input-toolbar {
            display: flex; /* Always display, control visibility via height/opacity? */
            height: 0; overflow: hidden; /* Collapsed by default */
            opacity: 0;
            background-color: var(--toolbar-bg); padding: 0 10px;
            border-top: 1px solid var(--border-color); flex-shrink: 0;
            align-items: center; gap: 5px;
            transition: height var(--transition-fast), opacity var(--transition-fast), padding var(--transition-fast);
        }
        #input-toolbar.visible {
            height: var(--toolbar-height);
            opacity: 1;
            padding: 0 10px; /* Ensure padding is correct when visible */
         }
        .toolbar-button { background: none; border: none; padding: 6px; cursor: pointer; border-radius: var(--border-radius-small); color: var(--msg-action-icon-fill); display: flex; align-items: center; justify-content: center; }
        .toolbar-button:hover { background-color: var(--toolbar-button-hover); color: var(--msg-action-icon-hover-fill); }
        .toolbar-button i { font-size: 16px; line-height: 1; }

        /* Main Input Area */
        #chat-input-area { display: flex; flex-direction: column; /* Stack reply/toolbar/main */ background-color: var(--input-area-bg); flex-shrink: 0; transition: background-color var(--transition-medium), border-color var(--transition-medium); border-bottom-left-radius: var(--border-radius-medium); border-bottom-right-radius: var(--border-radius-medium); }
        #chat-input-area::before { /* Remove top border effect if using toolbar/reply */ display: none; }

        .input-main-row { display: flex; align-items: flex-end; gap: 10px; width: 100%; padding: 10px 14px; /* Standard padding here */ }

        /* Prefix Buttons */
        .input-prefix-buttons { display: flex; align-items: center; gap: 5px; align-self: flex-end; margin-bottom: 5px; }
        .input-prefix-buttons .icon-button { padding: 6px; color: var(--timestamp-color); }
        .input-prefix-buttons .icon-button:hover { color: var(--msg-action-icon-hover-fill); background-color: var(--icon-button-hover-bg); }
        .input-prefix-buttons .icon-button i { font-size: 20px; }

        #user-input {
            flex-grow: 1; padding: 11px 18px; border: 1px solid var(--input-border); border-radius: var(--border-radius-large); font-size: 15px; background-color: var(--input-bg); color: var(--input-text); outline: none;
            transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-fast), height 0.1s ease-out, /* Faster height transition */ border-color var(--transition-fast), opacity var(--transition-medium);
            resize: none; overflow-y: hidden; min-height: 44px; max-height: 180px; /* Increased max height */ line-height: 1.45; box-sizing: border-box; box-shadow: 0 1px 1px rgba(0,0,0,0.04) inset;
        }
         /* Other input styles remain same */

        /* Char Counter */
        #char-counter { font-size: 11px; color: var(--timestamp-color); text-align: left; padding: 0 19px 5px 0; /* Align near send button */ height: 15px; }

        #send-button {
             /* ... existing styles ... */
            transition: background-color var(--transition-fast), transform var(--transition-fast), opacity var(--transition-medium), box-shadow var(--transition-fast);
            opacity: 0.5; /* Start slightly faded */
            transform: scale(0.95); /* Start smaller */
         }
         #send-button:not(:disabled) {
             opacity: 1;
             transform: scale(1);
         }
        #send-button.sending::before { animation: pulse-send-icon 0.5s ease-out; }
        @keyframes pulse-send-icon { /* ... */ }


        /* --- Modals (Settings, Confirmation, Lightbox) --- */
        /* Base Modal styles remain same */
        .modal-overlay { position: fixed; /* ... */ z-index: 100; display: none; /* ... */ }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background-color: var(--modal-bg); /* ... */ }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-button { /* ... */ }
        .modal-actions { /* ... */ }
        .modal-button { /* ... */ }
        .modal-button.primary { /* ... */ }
        .modal-button.secondary { /* ... */ }
        .modal-button.danger { /* ... */ }
        /* Settings Modal Specifics */
        .settings-section { margin-bottom: 20px; }
        .settings-section label { display: block; margin-bottom: 8px; /* ... */ }
        .settings-section select, .settings-section input, .settings-section textarea { /* ... */ }
        .settings-section input[type="range"] { padding: 0; }
        .settings-section .range-value { /* ... */ }
        .settings-section textarea { min-height: 80px; resize: vertical; }
        .setting-toggle { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        /* Add styles for Switches if using a library */

        /* Image Lightbox Styles remain same */
        #image-lightbox .modal-content { background:none; /* ... */ }
        #lightbox-image { /* ... */ }

        /* --- Skeleton Loaders --- */
        .skeleton {
             background-color: var(--skeleton-bg);
             border-radius: var(--border-radius-medium);
             animation: pulse-skeleton 1.5s infinite ease-in-out;
         }
         @keyframes pulse-skeleton { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
         .message-wrapper.skeleton-loading .avatar-placeholder { background-color: var(--skeleton-bg); }
         .message-wrapper.skeleton-loading .message { background-color: transparent; box-shadow: none; border: none; }
         .message-wrapper.skeleton-loading .message-content { min-height: 3em; background-color: var(--skeleton-bg); border-radius: var(--border-radius-medium); }
         .message-wrapper.skeleton-loading .message-footer { display: none; }


    </style>
</head>
<body > <!-- Add classes dynamically: compact-mode, rounded-mode -->

<div id="chat-container">
    <div id="chat-header">
        <!-- Search container -->
        <div class="header-search-container" id="header-search-area">
             <input type="text" id="chat-search-input" placeholder="חפש בהודעות...">
             <span id="search-results-count">0/0</span>
             <button class="icon-button" id="search-prev-button" title="התוצאה הקודמת" aria-label="התוצאה הקודמת"><i class="fas fa-chevron-up"></i></button>
             <button class="icon-button" id="search-next-button" title="התוצאה הבאה" aria-label="התוצאה הבאה"><i class="fas fa-chevron-down"></i></button>
             <button class="icon-button" id="search-close-button" title="סגור חיפוש" aria-label="סגור חיפוש"><i class="fas fa-times"></i></button>
        </div>
        <!-- Original Header Content -->
        <h1 id="chat-title" title="לחץ לעריכת שם השיחה">צ'אט AI אולטימטיבי</h1>
        <div class="header-controls">
            <button class="icon-button" id="search-open-button" title="חפש בשיחה" aria-label="חפש בשיחה"><i class="fas fa-search"></i></button>
            <select id="model-select" aria-label="בחר מודל AI">
                 <option value="main-ai.php">Gemini 1.5 Flash</option>
                 <option value="gemini25.php">Gemini 1.5 Pro</option>
            </select>
            <button class="icon-button" id="settings-button" title="הגדרות" aria-label="הגדרות"><i class="fas fa-cog"></i></button>
            <button class="icon-button" id="dark-mode-toggle" title="שנה ערכת נושא" aria-label="שנה ערכת נושא">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18v-8a2 2 0 0 0-2-2H4.08A8 8 0 0 1 12 4v8a2 2 0 0 0 2 2h5.92A8 8 0 0 1 12 20z"/></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>
            </button>
            <button class="icon-button" id="download-chat" title="הורד צ'אט" aria-label="הורד צ'אט">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="icon-button" id="clear-chat" title="נקה צ'אט" aria-label="נקה צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>
    </div>

    <!-- Pinned Message -->
    <div id="pinned-message">
        <i class="fas fa-thumbtack pinned-icon"></i>
        <span class="pinned-text"></span> <!-- Text set by JS -->
        <button id="unpin-button" title="בטל נעיצה" aria-label="בטל נעיצה">
             <i class="fas fa-times"></i> <!-- Use a simple X -->
        </button>
    </div>


    <div id="chat-output" aria-live="polite" role="log">
         <!-- Initial Message -->
         <div class="message-wrapper ai-message-wrapper" data-sender="ai" data-message-id="initial-0">
             <div class="avatar-placeholder"></div>
             <div class="message ai-message" tabindex="0">
                 <div class="message-content"><span>👋 שלום! אני מוכן לעזור. בחר מודל AI והתחל לשוחח. השתמש ב-Shift+Enter לשורה חדשה.</span></div>
                 <div class="message-footer"><span class="timestamp">התחל</span></div>
             </div>
         </div>
         <!-- Messages will be added here -->
         <button id="scroll-to-bottom" title="גלול לתחתית" aria-label="גלול לתחתית"><i class="fas fa-chevron-down"></i></button>
         <button id="scroll-to-top" title="גלול לראש השיחה" aria-label="גלול לראש השיחה" ><i class="fas fa-chevron-up"></i></button>
    </div>

    <div id="chat-input-area">
        <!-- Reply Preview Area -->
        <div id="reply-preview">
             <i class="fas fa-reply reply-icon"></i>
             <div class="reply-content-wrapper">
                 <span class="reply-sender"></span>
                 <span class="reply-text"></span>
             </div>
             <button id="cancel-reply-button" title="בטל תגובה" aria-label="בטל תגובה"><i class="fas fa-times"></i></button>
        </div>

        <!-- Input Toolbar -->
        <div id="input-toolbar">
             <button class="toolbar-button" data-format="bold" title="מודגש (Ctrl+B)"><i class="fas fa-bold"></i></button>
             <button class="toolbar-button" data-format="italic" title="נטוי (Ctrl+I)"><i class="fas fa-italic"></i></button>
             <button class="toolbar-button" data-format="code" title="קוד מוטבע"><i class="fas fa-code"></i></button>
             <button class="toolbar-button" data-format="ul" title="רשימה"><i class="fas fa-list-ul"></i></button>
             <button class="toolbar-button" data-format="link" title="קישור"><i class="fas fa-link"></i></button>
        </div>

        <!-- Main Input Row -->
        <div class="input-main-row">
            <div class="input-prefix-buttons">
                 <button class="icon-button" id="emoji-picker-button" title="בחר אימוג'י" aria-label="בחר אימוג'י"><i class="far fa-smile"></i></button>
                 <button class="icon-button" id="attachment-button" title="צרף קובץ (UI)" aria-label="צרף קובץ"><i class="fas fa-paperclip"></i></button>
            </div>
            <textarea id="user-input" placeholder="הקלד/י הודעה..." rows="1" aria-label="הודעת משתמש" aria-describedby="char-counter"></textarea>
            <button id="send-button" aria-label="שלח" disabled></button> <!-- Icon set by CSS -->
        </div>
         <!-- Character Counter -->
        <div id="char-counter">0</div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
        <button class="modal-close-button" aria-label="סגור הגדרות">&times;</button>
        <h2>הגדרות שיחה</h2>

        <div class="settings-section">
            <label for="system-prompt">הנחיית מערכת (System Prompt)</label>
            <textarea id="system-prompt" rows="3" placeholder="לדוגמה: תמיד תענה בצורה ידידותית ומפורטת."></textarea>
        </div>

        <div class="settings-section">
            <label for="temperature-slider">טמפרטורה (יצירתיות): <span class="range-value" id="temperature-value">0.7</span></label>
            <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.7">
        </div>

         <div class="settings-section">
             <label>מצב תצוגה</label>
             <div class="setting-toggle">
                 <span>מצב קומפקטי</span>
                 <input type="checkbox" id="compact-mode-toggle" class="toggle-switch"> <!-- Add class for styling -->
             </div>
             <div class="setting-toggle">
                 <span>פינות מעוגלות</span>
                 <input type="checkbox" id="rounded-mode-toggle" class="toggle-switch">
             </div>
             <div class="setting-toggle">
                <span>צלילי התראות (מושבת)</span>
                <input type="checkbox" id="sound-toggle" disabled class="toggle-switch">
            </div>
         </div>

        <div class="settings-section">
            <label for="accent-color-picker">צבע הדגשה</label>
            <input type="color" id="accent-color-picker" value="#008069">
        </div>


        <div class="modal-actions">
            <button class="modal-button secondary" id="settings-cancel-button">ביטול</button>
            <button class="modal-button primary" id="settings-save-button">שמור שינויים</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="confirmation-modal">
     <div class="modal-content" role="alertdialog" aria-labelledby="confirmation-title" aria-describedby="confirmation-message">
         <h2 id="confirmation-title"></h2>
         <p id="confirmation-message"></p>
         <div class="modal-actions">
             <button class="modal-button secondary" id="confirmation-cancel-button">ביטול</button>
             <button class="modal-button danger" id="confirmation-confirm-button">אישור</button>
         </div>
     </div>
</div>

<!-- Image Lightbox (Basic) -->
<div class="modal-overlay" id="image-lightbox">
    <div class="modal-content" style="background:none; box-shadow:none; padding:10px; max-width: 90vw; max-height: 90vh;">
         <button class="modal-close-button" style="color:white; background:rgba(0,0,0,0.5);">&times;</button>
        <img id="lightbox-image" src="" alt="תצוגה מקדימה" style="max-width:100%; max-height:100%; object-fit: contain; display:block;">
    </div>
</div>


<!-- Include Libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Optional: Load specific languages for highlight.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script> <!-- For HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<!-- KaTeX JS (Optional) -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="initKatex()"></script>


<script>
    // --- V4.0 Enhanced Code ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References (Extensive List) ---
        const body = document.body;
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const chatTitle = document.getElementById('chat-title');
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');
        const scrollToTopButton = document.getElementById('scroll-to-top');
        const pinnedMessageArea = document.getElementById('pinned-message');
        const pinnedMessageText = pinnedMessageArea.querySelector('.pinned-text');
        const unpinButton = document.getElementById('unpin-button');
        const replyPreviewArea = document.getElementById('reply-preview');
        const replySenderSpan = replyPreviewArea.querySelector('.reply-sender');
        const replyTextSpan = replyPreviewArea.querySelector('.reply-text');
        const cancelReplyButton = document.getElementById('cancel-reply-button');
        const inputToolbar = document.getElementById('input-toolbar');
        const emojiPickerButton = document.getElementById('emoji-picker-button');
        const attachmentButton = document.getElementById('attachment-button');
        const charCounter = document.getElementById('char-counter');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsCancelButton = document.getElementById('settings-cancel-button');
        const settingsSaveButton = document.getElementById('settings-save-button');
        const systemPromptInput = document.getElementById('system-prompt');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValue = document.getElementById('temperature-value');
        const compactModeToggle = document.getElementById('compact-mode-toggle');
        const roundedModeToggle = document.getElementById('rounded-mode-toggle');
        const accentColorPicker = document.getElementById('accent-color-picker');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmationCancelButton = document.getElementById('confirmation-cancel-button');
        const confirmationConfirmButton = document.getElementById('confirmation-confirm-button');
        const imageLightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const searchOpenButton = document.getElementById('search-open-button');
        const searchArea = document.getElementById('header-search-area');
        const searchInput = document.getElementById('chat-search-input');
        const searchResultsCount = document.getElementById('search-results-count');
        const searchPrevButton = document.getElementById('search-prev-button');
        const searchNextButton = document.getElementById('search-next-button');
        const searchCloseButton = document.getElementById('search-close-button');


        // --- State Variables ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/';
        let messageCounter = 0;
        let currentAbortController = null;
        let typingTimeout = null;
        let lastMessageSender = null;
        let lastMessageTimestamp = null;
        let isAutoScrolling = true;
        let userScrolledUp = false;
        let currentReplyMessageId = null;
        let inputHistory = JSON.parse(localStorage.getItem('inputHistory') || '[]');
        let inputHistoryIndex = inputHistory.length;
        let draftMessage = localStorage.getItem('draftMessage') || '';
        let pinnedMessageId = localStorage.getItem('pinnedMessageId');
        let currentSearchTerm = '';
        let searchResults = [];
        let currentSearchIndex = -1;
        let confirmationCallback = null;
        let katexInitialized = false; // Track KaTeX initialization

        const TYPING_SPEED = 8;
        const SCROLL_THRESHOLD = 150;
        const SCROLL_LOCK_THRESHOLD = 50;
        const MAX_INPUT_HISTORY = 50;
        const MAX_CHAR_COUNT = 4000; // Example limit


        // --- Utility Functions ---
        function getCurrentTimestamp() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }
        function getCurrentDateString(date = new Date()) { return date.toLocaleDateString('en-CA'); /* YYYY-MM-DD */ }
        function generateMessageId() { return `msg-${Date.now()}-${messageCounter++}`; }
        function sanitizeHtml(html) { /* Implement robust sanitization if needed */ return html; }
        function formatDateSeparator(dateStr) { /* ... V3.0 ... */ const today = new Date();const yesterday = new Date(today);yesterday.setDate(yesterday.getDate() - 1);const messageDate = new Date(dateStr + 'T00:00:00'); if (getCurrentDateString(messageDate) === getCurrentDateString(today)) { return 'היום'; } else if (getCurrentDateString(messageDate) === getCurrentDateString(yesterday)) { return 'אתמול'; } else { return messageDate.toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' }); }}

        function scrollToBottom(behavior = 'smooth', force = false) {
             if (!userScrolledUp || force) { // Check userScrolledUp flag
                 const scrollOptions = { top: chatOutput.scrollHeight, behavior: behavior };
                 chatOutput.scrollTo(scrollOptions);
                 isAutoScrolling = true; // Ensure auto-scroll is enabled when scrolling to bottom
             } else {
                 isAutoScrolling = false; // Explicitly disable if user scrolled up and we didn't force
             }
         }
        function scrollToTop(behavior = 'smooth') { chatOutput.scrollTo({ top: 0, behavior }); } // NEW

        // --- Debounce Function ---
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

         // --- Show/Hide Modal ---
         function showModal(modalElement) { modalElement.classList.add('visible'); /* Add focus trapping later */ }
         function hideModal(modalElement) { modalElement.classList.remove('visible'); if (confirmationCallback) { confirmationCallback = null; } }

         // --- Show Confirmation Modal ---
         function showConfirmation(title, message, confirmText = 'אישור', confirmClass = 'danger', callback) { confirmationTitle.textContent = title; confirmationMessage.textContent = message; confirmationConfirmButton.textContent = confirmText; confirmationConfirmButton.className = `modal-button ${confirmClass}`; confirmationCallback = callback; showModal(confirmationModal); }

        // --- Initialize KaTeX ---
        function initKatex() {
            if (typeof renderMathInElement === 'function') {
                katexInitialized = true;
                renderAllMessagesMath(); // Render existing messages if loaded before KaTeX
            }
        }

        // --- Render Math in a specific element ---
        function renderSingleElementMath(element) {
             if (katexInitialized && typeof renderMathInElement === 'function') {
                 try {
                     renderMathInElement(element, {
                         delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true} ],
                         throwOnError : false
                     });
                 } catch (e) { console.error("KaTeX rendering error:", e); }
             }
         }
         // --- Render Math in all existing messages ---
         function renderAllMessagesMath() {
            if (!katexInitialized) return;
            chatOutput.querySelectorAll('.message-content').forEach(renderSingleElementMath);
         }


        // --- Add Date Separator ---
        function addDateSeparatorIfNeeded(messageTimestamp) { const messageDateStr = getCurrentDateString(new Date(messageTimestamp)); const lastDateStr = lastMessageTimestamp ? getCurrentDateString(new Date(lastMessageTimestamp)) : null; if (!lastDateStr || messageDateStr !== lastDateStr) { const separator = document.createElement('div'); separator.className = 'date-separator'; separator.textContent = formatDateSeparator(messageDateStr); chatOutput.insertBefore(separator, scrollToBottomButton); lastMessageTimestamp = messageTimestamp; return true; } return false; }


        // --- Get Chat History ---
        // Basic version, needs improvement for robust markdown reconstruction if raw isn't stored
        function getChatHistory(currentUserMessage, forRegeneration = false, regenerationTargetMsgId = null) { const history = []; const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)'); messages.forEach((msg) => { const wrapper = msg.closest('.message-wrapper'); if (!wrapper || wrapper.classList.contains('skeleton-loading')) return; const sender = wrapper.dataset.sender; const timestamp = msg.dataset.timestamp; const messageId = msg.dataset.messageId; if (timestamp === 'התחל' && sender === 'ai') return; if (forRegeneration && messageId === regenerationTargetMsgId && sender === 'ai') return; let content = msg.dataset.rawMarkdown || msg.querySelector('.message-content')?.textContent || ''; content = content.trim(); if (content) { const role = sender === 'user' ? 'user' : 'model'; history.push({ role: role, content: content }); } }); return history; }


        // --- Add Skeleton Message ---
        function addSkeletonMessage(sender = 'ai') {
             const messageId = `skeleton-${Date.now()}`;
             const messageWrapper = document.createElement('div');
             messageWrapper.classList.add('message-wrapper', `${sender}-message-wrapper`, 'skeleton-loading');
             messageWrapper.dataset.messageId = messageId;

             const avatarDiv = document.createElement('div');
             avatarDiv.classList.add('avatar-placeholder', 'skeleton');

             const messageDiv = document.createElement('div');
             messageDiv.classList.add('message', sender === 'ai' ? 'ai-message' : 'user-message');

             const contentDiv = document.createElement('div');
             contentDiv.classList.add('message-content', 'skeleton');
             // Random width for content
             contentDiv.style.width = `${Math.random() * 40 + 40}%`; // 40% to 80% width

             messageDiv.appendChild(contentDiv);
             messageWrapper.appendChild(avatarDiv);
             messageWrapper.appendChild(messageDiv);
             chatOutput.insertBefore(messageWrapper, scrollToBottomButton);
             scrollToBottom('auto', true);
             return messageId; // Return ID to replace later
         }

         // --- Replace Skeleton Message ---
         function replaceSkeletonMessage(skeletonId, text, sender, options) {
             const skeletonWrapper = chatOutput.querySelector(`.message-wrapper[data-message-id="${skeletonId}"]`);
             if (skeletonWrapper) {
                 // Create the real message using addMessageToChat
                 const realMessageDiv = addMessageToChat(text, sender, { ...options, providedId: skeletonId }); // Reuse ID
                 // Replace the skeleton wrapper with the real message wrapper
                 const realMessageWrapper = realMessageDiv.closest('.message-wrapper');
                 if (realMessageWrapper) {
                    skeletonWrapper.parentNode.replaceChild(realMessageWrapper, skeletonWrapper);
                 } else { // Fallback if wrapper wasn't found immediately
                     skeletonWrapper.remove(); // Just remove skeleton
                 }
             }
         }


        // --- Add Message to Chat Function (Enhanced for Reply, Skeleton, Actions) ---
        function addMessageToChat(text, sender, options = {}) {
             const { isLoading = false, isError = false, timestamp: providedTimestamp = null, modelNameUsed = null, userQuery = null, modelValue = null, rawMarkdown = null, messageId: providedId = null, isStarred = false, replyToId = null, // Received reply ID
                 // No isPinned here, handle via separate state
              } = options;

             const messageTimestamp = Date.now();
             const displayTimestamp = providedTimestamp || getCurrentTimestamp();
             const dateSeparatorAdded = addDateSeparatorIfNeeded(messageTimestamp);

             const messageId = providedId || generateMessageId();
             const messageWrapper = document.createElement('div');
             messageWrapper.classList.add('message-wrapper', `${sender}-message-wrapper`);
             messageWrapper.dataset.sender = sender;
             messageWrapper.dataset.timestampMs = messageTimestamp;
             messageWrapper.dataset.messageId = messageId; // Add ID to wrapper

             const avatarDiv = document.createElement('div');
             avatarDiv.classList.add('avatar-placeholder');

             const messageDiv = document.createElement('div');
             messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
             if (isError) messageDiv.classList.add('error-message');
             if (isStarred) messageDiv.classList.add('starred');
             messageDiv.dataset.messageId = messageId;
             messageDiv.dataset.timestamp = displayTimestamp;
             messageDiv.setAttribute('tabindex', '0');

             // Grouping Logic
             const isGrouped = !dateSeparatorAdded && sender === lastMessageSender;
             if (isGrouped) messageWrapper.classList.add('grouped');
             else lastMessageSender = sender;


             if (isLoading) { /* Typing indicator remains same */ /* ... */ }
             else {
                  // Store raw markdown if provided
                  if (rawMarkdown) messageDiv.dataset.rawMarkdown = rawMarkdown;

                 // Add Reply Context UI if applicable
                 if (replyToId) {
                     const repliedMsgElement = chatOutput.querySelector(`.message[data-message-id="${replyToId}"]`);
                     if (repliedMsgElement) {
                         const replyContextDiv = document.createElement('div');
                         replyContextDiv.classList.add('reply-context');
                         const repliedSender = repliedMsgElement.closest('.message-wrapper')?.dataset.sender === 'user' ? 'אתה' : 'AI';
                         const repliedText = (repliedMsgElement.dataset.rawMarkdown || repliedMsgElement.querySelector('.message-content')?.textContent || '').substring(0, 50) + '...';
                         replyContextDiv.innerHTML = `<i class="fas fa-reply"></i> <strong>${repliedSender}:</strong> ${repliedText}`;
                         replyContextDiv.addEventListener('click', () => { /* scroll and highlight */ });
                         messageDiv.appendChild(replyContextDiv);
                     }
                 }


                 const contentDiv = document.createElement('div');
                 contentDiv.classList.add('message-content');

                 // Render content (Plain text for user, Markdown for AI/Error)
                 if (sender === 'user') { contentDiv.textContent = text; }
                 else { /* ... Markdown parsing ... */ }
                 messageDiv.appendChild(contentDiv);

                 // Render Math (after content is added)
                 renderSingleElementMath(contentDiv);

                 // Render Images (after content is added)
                  contentDiv.querySelectorAll('a').forEach(link => { /* ... render images, target _blank ... */ });


                 // Footer (with Read Receipts)
                 const footerDiv = document.createElement('div');
                 footerDiv.classList.add('message-footer');
                 if (sender === 'ai' && modelNameUsed && displayTimestamp !== 'התחל') { /* ... model indicator ... */ }
                 const timestampSpan = document.createElement('span');
                 timestampSpan.classList.add('timestamp');
                 timestampSpan.textContent = displayTimestamp;
                 if(sender === 'user') { /* ... read receipts span ... */ } // Add receipts
                 footerDiv.appendChild(timestampSpan);
                 messageDiv.appendChild(footerDiv);


                 // Actions (Only if not initial message)
                 if (displayTimestamp !== 'התחל') {
                     const actionsDiv = document.createElement('div');
                     actionsDiv.classList.add('message-actions');

                     actionsDiv.appendChild(createActionButton('copy-button', 'העתק הודעה', 'fas fa-copy', handleCopyClick));
                     actionsDiv.appendChild(createActionButton('reply-button', 'הגב', 'fas fa-reply', handleReplyClick));

                     if (sender === 'ai' && !isError) {
                         const regenButton = createActionButton('regenerate-button', 'צור תגובה מחדש', 'fas fa-sync-alt', handleRegenerateClick);
                         const spinner = document.createElement('div'); spinner.className = 'action-spinner'; regenButton.appendChild(spinner);
                         actionsDiv.appendChild(regenButton);
                     }
                     if (sender === 'user') {
                         actionsDiv.appendChild(createActionButton('edit-button', 'ערוך (UI)', 'fas fa-pencil-alt', handleEditClick));
                         actionsDiv.appendChild(createActionButton('delete-button', 'מחק (UI)', 'fas fa-trash-alt', handleDeleteClick));
                     }
                     // Check global state for pinned, not options
                     const isCurrentlyPinned = pinnedMessageId === messageId;
                     const pinButton = createActionButton('pin-button', isCurrentlyPinned ? 'בטל נעיצה' : 'נעל הודעה', 'fas fa-thumbtack', handlePinClick);
                     if (isCurrentlyPinned) pinButton.classList.add('active');
                     actionsDiv.appendChild(pinButton);

                     // Star needs state from somewhere (e.g., localStorage array)
                     // let isCurrentlyStarred = checkStarredStatus(messageId); // Hypothetical function
                     const starButton = createActionButton('star-button', isStarred ? 'בטל כוכב' : 'סמן בכוכב', isStarred ? 'fas fa-star' : 'far fa-star', handleStarClick);
                     if (isStarred) starButton.classList.add('active');
                     actionsDiv.appendChild(starButton);

                     messageDiv.appendChild(actionsDiv);
                     finalizeMessageRendering(contentDiv); // Highlight code, etc.
                 }
             }

             messageWrapper.appendChild(avatarDiv);
             messageWrapper.appendChild(messageDiv);

             // Find where to insert (before scroll button)
             const insertionPoint = chatOutput.querySelector('#scroll-to-bottom');
             chatOutput.insertBefore(messageWrapper, insertionPoint);


             // Scroll only if auto-scrolling is enabled
             if (!isLoading && isAutoScrolling) {
                 // Use requestAnimationFrame for smoother scrolling after render
                 requestAnimationFrame(() => {
                     scrollToBottom('smooth');
                 });
             } else if (isLoading) {
                 scrollToBottom('auto', true); // Force immediate for loading
             }

             return messageDiv;
         }

         // --- Create Action Button Helper ---
         function createActionButton(className, title, iconClass, clickHandler) { const button = document.createElement('button'); button.className = `msg-action-button ${className}`; button.title = title; button.setAttribute('aria-label', title); button.innerHTML = `<i class="${iconClass}"></i>`; button.addEventListener('click', clickHandler); return button; }


        // --- AI Typing Effect (Render instantly) ---
        function typeAiResponse(messageElement, fullMarkdownText) { /* ... V4.0 ... */ }

        // --- Finalize Rendering (Highlight, Copy, Math, Collapse) ---
        function finalizeMessageRendering(contentDiv) { if (!contentDiv) return; contentDiv.querySelectorAll('pre').forEach(pre => { if (!pre.querySelector('code')) { /* ... */ } addCopyButtonToCodeBlock(pre); /* ... collapsible logic ... */ }); contentDiv.querySelectorAll('pre code').forEach((block) => { if (typeof hljs !== 'undefined') hljs.highlightElement(block); }); /* Render Math (now called in addMessage) */ }

        // --- Finalize AI Message ---
        function finalizeAiMessage(messageElement) { clearTimeout(typingTimeout); typingTimeout = null; if (messageElement) messageElement.classList.remove('typing-cursor'); scrollToBottom('smooth'); enableInput(); }

        // --- Stop Generation ---
        function stopTypingAndGeneration() { /* ... V4.0 ... */ }

        // --- Add Copy Button to Code ---
        function addCopyButtonToCodeBlock(preElement) { /* ... V4.0 ... */ }

        // --- Disable/Enable Input ---
        function disableInput() { userInput.disabled = true; sendButton.disabled = true; userInput.style.opacity = '0.6'; sendButton.classList.remove('sending'); /* Remove sending animation */ }
        function enableInput() { if (!currentAbortController && !typingTimeout && !document.querySelector('.typing-indicator')) { userInput.disabled = false; userInput.style.opacity = '1'; adjustTextareaHeight(); /* Checks input length for button state */ if (document.activeElement === document.body || document.activeElement === chatOutput) { userInput.focus(); } } }

        // --- Send Message (Enhanced) ---
        async function sendMessage(textToSend, options = {}, skipResponse = false) {
             const { isRegeneration = false, originalAiMsgId = null, modelValueOverride = null, modelNameOverride = null } = options;
             let currentText = textToSend !== undefined ? textToSend.trim() : userInput.value.trim();

             if (currentText === '' || currentAbortController || typingTimeout) return;

             disableInput();
             sendButton.classList.add('sending'); // Add sending animation
             isAutoScrolling = true;

             // Add to history, clear draft
             if (!isRegeneration) { /* ... add to input history, clear draft ... */ }

             // Prepare message options (including reply)
             const messageOptions = { replyToId: currentReplyMessageId };

             let skeletonId = null; // To store skeleton ID

             if (!isRegeneration) {
                 // Show skeleton immediately for user message
                 // skeletonId = addSkeletonMessage('user'); // Option: Skeleton for user too
                 addMessageToChat(currentText, 'user', messageOptions); // Add real message directly for user
                 userInput.value = '';
                 adjustTextareaHeight();
                 sendButton.disabled = true;
                 charCounter.textContent = '0';
                 if (currentReplyMessageId) hideReplyPreview();
             } else { /* ... handle removing old AI msg ... */ }

             if (skipResponse && !isRegeneration) { /* ... */ enableInput(); return; }


             // --- Fetch Logic ---
             const historyArray = getChatHistory( null, isRegeneration, originalAiMsgId );
             const systemPrompt = localStorage.getItem('systemPrompt') || '';
             const temperature = parseFloat(localStorage.getItem('temperature') || '0.7');
             const selectedOption = modelValueOverride ? Array.from(modelSelect.options).find(opt => opt.value === modelValueOverride) || modelSelect.options[modelSelect.selectedIndex] : modelSelect.options[modelSelect.selectedIndex];
             const modelName = modelNameOverride || selectedOption.text; const selectedModelFile = selectedOption.value; const currentApiUrl = BASE_API_URL + selectedModelFile;

             // Show AI Skeleton Message
             const aiSkeletonId = addSkeletonMessage('ai');
             currentAbortController = new AbortController(); const signal = currentAbortController.signal;

             try {
                 console.log(`Sending to ${currentApiUrl}`);
                 const requestPayload = { text: currentText, history: historyArray, system_prompt: systemPrompt, temperature: temperature, /* reply_context: ... */ };
                 const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestPayload), signal });

                 const wasAborted = signal.aborted;
                 // Don't clear controller or remove skeleton yet

                 if (wasAborted) {
                      console.log('Fetch aborted by user.');
                      replaceSkeletonMessage(aiSkeletonId, 'היצירה הופסקה.', 'ai', { modelNameUsed: 'מערכת', isError: true });
                      currentAbortController = null;
                      enableInput();
                      return;
                 }

                 if (!response.ok) { /* ... handle server error ... */ throw new Error(/*...*/); }

                 const data = await response.json();
                 console.log("Received data:", data);

                 if (data && data.text) {
                     // Replace Skeleton with real message
                     replaceSkeletonMessage(aiSkeletonId, data.text, 'ai', {
                         timestamp: getCurrentTimestamp(),
                         modelNameUsed: modelName,
                         userQuery: currentText,
                         modelValue: selectedModelFile,
                         rawMarkdown: data.text,
                         replyToId: isRegeneration ? null : currentReplyMessageId // Pass reply ID if it was a new msg
                     });
                 } else {
                     throw new Error("תגובה לא צפויה מהשרת.");
                 }

             } catch (error) {
                 console.error("Error caught in sendMessage:", error);
                 if (error.name !== 'AbortError') { // Don't show error if user aborted
                     const userFriendlyError = formatErrorForUser(error);
                     replaceSkeletonMessage(aiSkeletonId, userFriendlyError, 'ai', { modelNameUsed: 'שגיאה', isError: true });
                 } else {
                      // If abort happened but wasn't caught earlier, remove skeleton
                     const skel = chatOutput.querySelector(`.message-wrapper[data-message-id="${aiSkeletonId}"]`);
                     skel?.remove();
                 }
             } finally {
                 // Ensure controller is cleared and input enabled AFTER potential replacement
                 currentAbortController = null;
                 enableInput();
                 sendButton.classList.remove('sending'); // Remove animation class
             }
         }

        // --- Format Error ---
        function formatErrorForUser(error) { /* ... V4.0 ... */ }

        // --- UI Interaction Functions ---
        function toggleDarkMode(forceMode) { const body = document.body; let isDark; if (forceMode) isDark = (forceMode === 'dark'); else isDark = !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); themeIconLight.style.display = isDark ? 'none' : 'inline-block'; sunIcon.style.display = isDark ? 'inline-block' : 'none'; localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); updateSelectArrowColor(); updateHighlightTheme(isDark); applyAccentColor(localStorage.getItem('accentColor')); /* Re-apply accent */ }
        function updateHighlightTheme(isDark) { const currentLink = document.querySelector('link[href*="highlight.js"][media*="prefers-color-scheme"]'); /* Needs more robust theme switching */ }
        function updateSelectArrowColor() { /* ... V3.0 ... */ }
        function downloadChat() { /* ... V4.0 ... */ }
        function handleClearChatClick() { showConfirmation( 'אישור מחיקת שיחה', 'האם אתה בטוח שברצונך למחוק לצמיתות את כל ההודעות בשיחה זו?', 'מחק הכל', 'danger', () => { clearChat(); hideModal(confirmationModal); } ); }
        function clearChat() { console.log("Clearing chat..."); stopTypingAndGeneration(); while (chatOutput.firstChild && chatOutput.firstChild !== scrollToBottomButton && chatOutput.firstChild !== scrollToTopButton) { chatOutput.removeChild(chatOutput.firstChild); } addMessageToChat(/* welcome */); messageCounter = 0; lastMessageSender = null; lastMessageTimestamp = null; pinnedMessageId = null; localStorage.removeItem('pinnedMessageId'); updatePinnedMessageDisplay(); hideReplyPreview(); scrollToBottomButton.classList.remove('visible'); scrollToTopButton.style.display = 'none'; isAutoScrolling = true; userScrolledUp = false; userInput.value = ''; draftMessage = ''; localStorage.removeItem('draftMessage'); localStorage.removeItem('inputHistory'); inputHistory = []; inputHistoryIndex = 0; adjustTextareaHeight(); enableInput(); console.log("Chat cleared."); }
        function handleUrlParameter() { /* ... V3.0 ... */ }
        function adjustTextareaHeight() { const currentLength = userInput.value.length; const scrollHeight = userInput.scrollHeight; const maxHeight = parseInt(window.getComputedStyle(userInput).maxHeight, 10); userInput.style.height = 'auto'; userInput.style.height = `${Math.min(scrollHeight, maxHeight)}px`; userInput.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden'; charCounter.textContent = `${currentLength}${MAX_CHAR_COUNT ? `/${MAX_CHAR_COUNT}` : ''}`; charCounter.style.color = (MAX_CHAR_COUNT && currentLength > MAX_CHAR_COUNT) ? 'red' : 'var(--timestamp-color)'; sendButton.disabled = userInput.value.trim().length === 0 || currentAbortController !== null || typingTimeout !== null; }
        const debouncedAdjustHeight = debounce(adjustTextareaHeight, 50);
        function handleCopyClick(event) { /* ... V4.0 ... */ }
        function handleRegenerateClick(event) { if (currentAbortController || typingTimeout) return; const button = event.currentTarget; const spinner = button.querySelector('.action-spinner'); const messageElement = button.closest('.message'); if (!messageElement) return; const userQuery = messageElement.dataset.userQuery; const modelValue = messageElement.dataset.modelValue; const modelName = messageElement.dataset.modelName; const messageId = messageElement.dataset.messageId; if (!userQuery || !modelValue || !modelName || !messageId) return; button.disabled = true; spinner.style.display = 'inline-block'; sendMessage(userQuery, { isRegeneration: true, originalAiMsgId: messageId, modelValueOverride: modelValue, modelNameOverride: modelName }) .finally(() => { /* Re-enable button on completion - careful with async replace */ setTimeout(() => { const newButton = chatOutput.querySelector(`.message[data-message-id="${messageId}"] .regenerate-button`); if(newButton) { newButton.disabled = false; newButton.querySelector('.action-spinner').style.display = 'none'; } else { enableInput(); } }, 100); }); }
        function handleReplyClick(event) { const button = event.currentTarget; const messageElement = button.closest('.message'); if (!messageElement) return; currentReplyMessageId = messageElement.dataset.messageId; showReplyPreview(messageElement); userInput.focus(); }
        function showReplyPreview(messageElement) { const sender = messageElement.closest('.message-wrapper')?.dataset.sender === 'user' ? 'אתה' : 'AI'; const content = (messageElement.dataset.rawMarkdown || messageElement.querySelector('.message-content')?.textContent || '').substring(0, 70) + '...'; replySenderSpan.textContent = `${sender}:`; replyTextSpan.textContent = content; replyPreviewArea.classList.add('visible'); adjustChatOutputHeight(); }
        function hideReplyPreview() { if (!replyPreviewArea.classList.contains('visible')) return; replyPreviewArea.classList.remove('visible'); currentReplyMessageId = null; adjustChatOutputHeight(); }
        function handlePinClick(event) { /* ... V4.0 ... */ }
        function updatePinnedMessageDisplay() { if (pinnedMessageId) { const pinnedMsgElement = chatOutput.querySelector(`.message[data-message-id="${pinnedMessageId}"]`); if (pinnedMsgElement) { const content = (pinnedMsgElement.dataset.rawMarkdown || pinnedMsgElement.querySelector('.message-content')?.textContent || '').substring(0, 100) + '...'; pinnedMessageText.textContent = content; pinnedMessageArea.classList.add('visible'); pinnedMessageArea.onclick = () => { /* scroll */ }; } else { pinnedMessageId = null; localStorage.removeItem('pinnedMessageId'); pinnedMessageArea.classList.remove('visible'); pinnedMessageArea.onclick = null; } } else { pinnedMessageArea.classList.remove('visible'); pinnedMessageArea.onclick = null; } adjustChatOutputHeight(); }
        function handleStarClick(event) { /* ... V4.0 ... */ }
        function handleEditClick(event) { /* ... V4.0 Placeholder ... */ }
        function handleDeleteClick(event) { const messageElement = event.currentTarget.closest('.message'); const messageId = messageElement?.dataset.messageId; if (!messageId) return; showConfirmation( 'אישור מחיקת הודעה', 'האם אתה בטוח?', 'מחק', 'danger', () => { messageElement?.closest('.message-wrapper')?.remove(); hideModal(confirmationModal); /* Update grouping */ } ); }

        function handleScroll() { const scrollPosition = chatOutput.scrollTop; const scrollHeight = chatOutput.scrollHeight; const clientHeight = chatOutput.clientHeight; const isNearBottom = scrollHeight - scrollPosition - clientHeight < SCROLL_THRESHOLD; const isScrolledToVeryBottom = scrollHeight - scrollPosition - clientHeight < 1; scrollToBottomButton.classList.toggle('visible', !isNearBottom); scrollToTopButton.style.display = scrollPosition > clientHeight ? 'flex' : 'none'; if (!isAutoScrolling && isScrolledToVeryBottom) { isAutoScrolling = true; userScrolledUp = false; } else if (chatOutput.dataset.userScrolling === 'true' && !isScrolledToVeryBottom) { isAutoScrolling = false; userScrolledUp = true; } chatOutput.dataset.userScrolling = 'false'; sessionStorage.setItem('scrollPosition', scrollPosition); }
        function updateGrouping(messageWrapper) { /* ... V3.0 ... */ }
        function navigateInputHistory(direction) { /* ... V4.0 ... */ }
        function applyInputFormatting(format) { /* ... V4.0 ... */ }
        function showImageLightbox(src) { lightboxImage.src = src; showModal(imageLightbox); }
        const debouncedSearch = debounce(performSearch, 300);
        function openSearch() { searchArea.classList.add('active'); searchInput.focus(); }
        function closeSearch() { searchArea.classList.remove('active'); currentSearchTerm = ''; searchResults = []; currentSearchIndex = -1; clearSearchHighlights(); searchResultsCount.textContent = '0/0'; searchInput.value = ''; }
        function performSearch() { const term = searchInput.value.trim().toLowerCase(); clearSearchHighlights(); if (term.length < 2) { searchResults = []; currentSearchIndex = -1; searchResultsCount.textContent = '0/0'; currentSearchTerm = term; return; } if (term === currentSearchTerm) { searchResultsCount.textContent = `${currentSearchIndex + 1}/${searchResults.length}`; return; } currentSearchTerm = term; searchResults = []; currentSearchIndex = -1; const messageContents = chatOutput.querySelectorAll('.message .message-content'); messageContents.forEach((content) => { const text = (content.closest('.message')?.dataset?.rawMarkdown || content.textContent || '').toLowerCase(); if (text.includes(term)) { searchResults.push(content.closest('.message')); highlightTermInNode(content, term); } }); searchResultsCount.textContent = `0/${searchResults.length}`; if (searchResults.length > 0) navigateToSearchResult(0); }
        function highlightTermInNode(node, term) { const termLower = term.toLowerCase(); const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT); let textNode; const nodesToReplace = []; while(textNode = walker.nextNode()) { let currentIndex = 0; let matchIndex; const nodeValueLower = textNode.nodeValue.toLowerCase(); while ((matchIndex = nodeValueLower.indexOf(termLower, currentIndex)) !== -1) { const originalText = textNode.nodeValue; const before = originalText.substring(currentIndex, matchIndex); const matched = originalText.substring(matchIndex, matchIndex + term.length); const mark = document.createElement('mark'); mark.className = 'search-highlight'; mark.textContent = matched; nodesToReplace.push({ node: textNode, before: before ? document.createTextNode(before) : null, mark: mark }); currentIndex = matchIndex + term.length; } const after = textNode.nodeValue.substring(currentIndex); if (after) nodesToReplace.push({ node: textNode, after: document.createTextNode(after) }); } nodesToReplace.forEach(replaceData => { const parent = replaceData.node.parentNode; if (replaceData.before) parent.insertBefore(replaceData.before, replaceData.node); if (replaceData.mark) parent.insertBefore(replaceData.mark, replaceData.node); if (replaceData.after) parent.insertBefore(replaceData.after, replaceData.node); if (parent.contains(replaceData.node)) parent.removeChild(replaceData.node); }); }
        function clearSearchHighlights() { chatOutput.querySelectorAll('mark.search-highlight').forEach(mark => { mark.outerHTML = mark.innerHTML; }); chatOutput.querySelectorAll('.message.highlighted').forEach(msg => msg.classList.remove('highlighted')); }
        function navigateToSearchResult(index) { if (searchResults.length === 0) return; const newIndex = (index + searchResults.length) % searchResults.length; // Wrap around if (currentSearchIndex !== -1 && searchResults[currentSearchIndex]) searchResults[currentSearchIndex].classList.remove('highlighted'); currentSearchIndex = newIndex; const targetMessage = searchResults[currentSearchIndex]; if (targetMessage) { targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' }); targetMessage.classList.add('highlighted'); targetMessage.focus(); searchResultsCount.textContent = `${currentSearchIndex + 1}/${searchResults.length}`; } }
        function loadSettings() { /* ... V4.0 ... */ systemPromptInput.value = localStorage.getItem('systemPrompt') || ''; const savedTemp = localStorage.getItem('temperature'); temperatureSlider.value = savedTemp !== null ? savedTemp : '0.7'; temperatureValue.textContent = temperatureSlider.value; compactModeToggle.checked = body.classList.contains('compact-mode'); roundedModeToggle.checked = body.classList.contains('rounded-mode'); const savedAccent = localStorage.getItem('accentColor'); if (savedAccent) { accentColorPicker.value = savedAccent; applyAccentColor(savedAccent); } else { const isDark = body.classList.contains('dark-mode'); accentColorPicker.value = getComputedStyle(body).getPropertyValue(isDark ? '--dm-accent-color' : '--lm-accent-color').trim(); } }
        function saveSettings() { localStorage.setItem('systemPrompt', systemPromptInput.value); localStorage.setItem('temperature', temperatureSlider.value); localStorage.setItem('compactMode', compactModeToggle.checked); localStorage.setItem('roundedMode', roundedModeToggle.checked); localStorage.setItem('accentColor', accentColorPicker.value); body.classList.toggle('compact-mode', compactModeToggle.checked); body.classList.toggle('rounded-mode', roundedModeToggle.checked); applyAccentColor(accentColorPicker.value); hideModal(settingsModal); console.log("Settings saved."); }
        function applyAccentColor(color) { const isDark = body.classList.contains('dark-mode'); document.documentElement.style.setProperty('--accent-color', color); document.documentElement.style.setProperty(isDark ? '--dm-accent-color' : '--lm-accent-color', color); updateSelectArrowColor(); }
        function enableTitleEditing() { /* ... V4.0 ... */ }
        function saveTitle() { /* ... V4.0 ... */ }
        function handleTitleKeydown(e) { /* ... V4.0 ... */ }

        // --- Dynamic Height Adjustment for Chat Output ---
        function adjustChatOutputHeight() {
            let usedHeight = chatHeader.offsetHeight;
            if (pinnedMessageArea.classList.contains('visible')) usedHeight += pinnedMessageArea.offsetHeight;
            if (replyPreviewArea.classList.contains('visible')) usedHeight += replyPreviewArea.offsetHeight;
            if (inputToolbar.classList.contains('visible')) usedHeight += inputToolbar.offsetHeight;
            usedHeight += document.getElementById('chat-input-area').offsetHeight; // Get actual input area height

            // chatOutput.style.height = `calc(100% - ${usedHeight}px)`; // This might cause layout shifts, rely on flex-grow instead
        }
        // Call adjustChatOutputHeight whenever relevant components change visibility/size
        // (e.g., after showing/hiding reply, pin, toolbar)

        // --- Event Listeners Setup ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
        userInput.addEventListener('input', debouncedAdjustHeight);
        userInput.addEventListener('keydown', (e) => { if (e.key === 'ArrowUp' && userInput.selectionStart === 0) { e.preventDefault(); navigateInputHistory('up'); } else if (e.key === 'ArrowDown' && userInput.selectionEnd === userInput.value.length) { e.preventDefault(); navigateInputHistory('down'); } });
        userInput.addEventListener('input', () => { if (inputHistoryIndex === inputHistory.length) { draftMessage = userInput.value; localStorage.setItem('draftMessage', draftMessage); } });
        userInput.addEventListener('focus', () => inputToolbar.classList.add('visible')); // Show toolbar on focus
        // Consider hiding toolbar on blur unless interacting with it
        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', handleClearChatClick);
        modelSelect.addEventListener('change', () => { localStorage.setItem('selectedModel', modelSelect.value); chatHeader.classList.add('model-changing'); setTimeout(() => chatHeader.classList.remove('model-changing'), 300); console.log(`Model changed to: ${modelSelect.value}`); });
        let scrollTimeout; chatOutput.addEventListener('scroll', () => { chatOutput.dataset.userScrolling = 'true'; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(handleScroll, 50); });
        scrollToBottomButton.addEventListener('click', () => { isAutoScrolling = true; userScrolledUp = false; scrollToBottom('smooth', true); });
        scrollToTopButton.addEventListener('click', () => scrollToTop('smooth'));
        cancelReplyButton.addEventListener('click', hideReplyPreview);
        unpinButton.addEventListener('click', (e) => { e.stopPropagation(); pinnedMessageId = null; localStorage.removeItem('pinnedMessageId'); updatePinnedMessageDisplay(); const pinButton = chatOutput.querySelector(`.message .pin-button.active`); if(pinButton){ pinButton.classList.remove('active'); pinButton.title = 'נעל הודעה'; pinButton.querySelector('i').className = 'fas fa-thumbtack'; } });
        inputToolbar.addEventListener('click', (e) => { const button = e.target.closest('.toolbar-button'); if (button && button.dataset.format) applyInputFormatting(button.dataset.format); });
        settingsButton.addEventListener('click', () => { loadSettings(); showModal(settingsModal); });
        settingsCancelButton.addEventListener('click', () => hideModal(settingsModal));
        settingsSaveButton.addEventListener('click', saveSettings);
        temperatureSlider.addEventListener('input', () => temperatureValue.textContent = temperatureSlider.value);
        accentColorPicker.addEventListener('input', () => applyAccentColor(accentColorPicker.value));
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) hideModal(settingsModal); });
        confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) hideModal(confirmationModal); });
        imageLightbox.addEventListener('click', (e) => { if (e.target === imageLightbox || e.target.closest('.modal-close-button')) hideModal(imageLightbox); });
        confirmationCancelButton.addEventListener('click', () => hideModal(confirmationModal));
        confirmationConfirmButton.addEventListener('click', () => { if (confirmationCallback) confirmationCallback(); });
        searchOpenButton.addEventListener('click', openSearch);
        searchCloseButton.addEventListener('click', closeSearch);
        searchInput.addEventListener('input', debouncedSearch);
        searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') {e.preventDefault(); searchNextButton.click();} else if (e.key === 'Escape') { closeSearch(); } });
        searchNextButton.addEventListener('click', () => navigateToSearchResult(currentSearchIndex + 1));
        searchPrevButton.addEventListener('click', () => navigateToSearchResult(currentSearchIndex - 1));
        chatTitle.addEventListener('click', enableTitleEditing);
        chatTitle.addEventListener('blur', saveTitle); // Save on blur too


        // --- Initialization ---
        body.classList.toggle('compact-mode', localStorage.getItem('compactMode') === 'true');
        body.classList.toggle('rounded-mode', localStorage.getItem('roundedMode') === 'true');
        const savedDarkMode = localStorage.getItem('darkMode'); toggleDarkMode(savedDarkMode === 'enabled' ? 'dark' : 'light'); // Apply dark mode first
        const savedAccent = localStorage.getItem('accentColor'); if(savedAccent) applyAccentColor(savedAccent); else applyAccentColor(getComputedStyle(body).getPropertyValue('--accent-color').trim()); // Apply default or saved accent
        const savedTitle = localStorage.getItem('chatTitle'); if (savedTitle) { chatTitle.textContent = savedTitle; document.title = savedTitle; }
        const savedModel = localStorage.getItem('selectedModel'); if (savedModel && modelSelect.querySelector(`option[value="${savedModel}"]`)) modelSelect.value = savedModel;
        userInput.value = draftMessage;

        // Initial Render (Clear & Add Welcome)
        while (chatOutput.firstChild && chatOutput.firstChild !== scrollToBottomButton && chatOutput.firstChild !== scrollToTopButton) { chatOutput.removeChild(chatOutput.firstChild); }
        addMessageToChat("👋 שלום! אני מוכן לעזור. בחר מודל AI והתחל לשוחח. השתמש ב-Shift+Enter לשורה חדשה.", 'ai', { timestamp: 'התחל' });

        handleUrlParameter();
        adjustTextareaHeight();
        updatePinnedMessageDisplay();

        // Restore scroll position
        const savedScrollPosition = sessionStorage.getItem('scrollPosition');
        if (savedScrollPosition !== null) { setTimeout(() => { chatOutput.scrollTop = parseInt(savedScrollPosition, 10); handleScroll(); }, 100); }
        else { scrollToBottom('auto', true); }

        enableInput(); // Ensure input is enabled/disabled correctly
        console.log("Ultimate AI Chat V4.0+ Initialized.");

    });
</script>

<!-- PHP code remains the same -->
<?php /* ... existing PHP ... */ ?>

</body>
</html>
```
