<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¦'××˜ AI ××•×œ×˜×™××˜×™×‘×™ V4.0</title>
    <!-- Syntax Highlighting CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
    <!-- Font Awesome for Icons (Optional but used in examples) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- KaTeX for Math Rendering (Optional) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* --- V3.0 Variables + NEW --- */
        :root {
            /* Existing variables... */
            --font-main: Assistant, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-code: 'Consolas', 'Monaco', 'Courier New', monospace;
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --border-radius-large: 18px;
            --border-radius-avatar: 50%;
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
            --avatar-size: 30px;
            --message-spacing: 10px;
            --message-spacing-grouped: 3px;
            --message-horizontal-gap: 10px;

            /* NEW Variables */
            --header-height: 59px; /* Approximate */
            --input-area-min-height: 64px; /* Includes padding */
            --pinned-message-height: 40px;
            --toolbar-height: 35px;
            --accent-color-light: #008069; /* Default light accent */
            --accent-color-dark: #00a884; /* Default dark accent */
            --accent-color: var(--accent-color-light); /* Default */
            --lm-accent-color: var(--accent-color-light);
            --dm-accent-color: var(--accent-color-dark);
            --lm-reply-bg: rgba(0, 0, 0, 0.05);
            --dm-reply-bg: rgba(255, 255, 255, 0.08);
            --lm-modal-bg: rgba(255, 255, 255, 0.95);
            --dm-modal-bg: rgba(30, 40, 50, 0.95);
            --lm-modal-shadow: 0 5px 15px rgba(0,0,0,0.2);
            --dm-modal-shadow: 0 5px 20px rgba(0,0,0,0.4);
            --lm-search-highlight-bg: #fff3cd;
            --dm-search-highlight-bg: #6a4d00;


            /* --- Light Mode --- */
            --lm-bg-default: #e5ddd5; --lm-chat-bg: #ffffff; --lm-header-bg: #00a884; --lm-header-bg-gradient: linear-gradient(to bottom, #00b09b, #00a884); --lm-header-text: #ffffff; --lm-header-icon-fill: #ffffff; --lm-user-msg-bg: #dcf8c6; --lm-ai-msg-bg: #ffffff; --lm-msg-text: #111b21; --lm-avatar-user-bg: #adff2f; --lm-avatar-ai-bg: #b0e0e6; --lm-input-area-bg: #f0f2f5; --lm-input-bg: #ffffff; --lm-input-text: #111b21; --lm-input-border: #e0e0e0; --lm-input-border-focus: var(--lm-accent-color); --lm-button-bg: var(--lm-accent-color); --lm-button-hover-bg: color-mix(in srgb, var(--lm-accent-color) 85%, #000); --lm-button-active-bg: color-mix(in srgb, var(--lm-accent-color) 70%, #000); --lm-button-icon-fill: #ffffff; --lm-timestamp-color: rgba(17, 27, 33, 0.6); --lm-model-indicator-color: rgba(17, 27, 33, 0.5); --lm-border-color: #e9edef; --lm-icon-button-hover-bg: rgba(0, 0, 0, 0.07); --lm-msg-action-icon-fill: rgba(0, 0, 0, 0.5); --lm-msg-action-icon-hover-fill: #000000; --lm-msg-action-icon-hover-bg: rgba(0, 0, 0, 0.09); --lm-scrollbar-thumb: #b0b0b0; --lm-scrollbar-track: #f5f5f5; --lm-link-color: #007bff; --lm-code-bg: #f8f9fa; --lm-code-text: #212529; --lm-code-border: #dee2e6; --lm-code-copy-btn-bg: rgba(0, 0, 0, 0.05); --lm-code-copy-btn-hover-bg: rgba(0, 0, 0, 0.1); --lm-code-copy-btn-copied-bg: var(--lm-button-bg); --lm-code-copy-btn-copied-text: #ffffff; --lm-loading-spinner-color1: var(--lm-accent-color); --lm-loading-spinner-color2: #dcf8c6; --lm-shadow-light: 0 1px 1px rgba(0, 0, 0, 0.06); --lm-shadow-medium: 0 2px 4px rgba(0, 0, 0, 0.08); --lm-scroll-btn-bg: rgba(255, 255, 255, 0.9); --lm-scroll-btn-icon: #54656f; --lm-scroll-btn-hover-bg: #ffffff; --lm-date-separator-bg: #e9e9e9; --lm-date-separator-text: #54656f; --lm-focus-outline: var(--lm-accent-color); --lm-pinned-bg: #fffbeb; --lm-pinned-border: #ffeccc; --lm-toolbar-bg: #e9edef; --lm-toolbar-button-hover: #d1d7db; --lm-tooltip-bg: #333; --lm-tooltip-text: #fff; --lm-error-msg-bg: #fff0f0; --lm-error-msg-border: #ffcccc; --lm-error-msg-text: #c00;

            /* --- Dark Mode --- */
            --dm-bg-default: #0f1a21; --dm-chat-bg: #0b141a; --dm-header-bg: #202c33; --dm-header-bg-gradient: linear-gradient(to bottom, #2a3942, #202c33); --dm-header-text: #e9edef; --dm-header-icon-fill: #aebac1; --dm-user-msg-bg: #005c4b; --dm-ai-msg-bg: #202c33; --dm-msg-text: #e9edef; --dm-avatar-user-bg: #008069; --dm-avatar-ai-bg: #345665; --dm-input-area-bg: #1f2c34; --dm-input-bg: #2a3942; --dm-input-text: #e9edef; --dm-input-border: #374151; --dm-input-border-focus: var(--dm-accent-color); --dm-button-bg: var(--dm-accent-color); --dm-button-hover-bg: color-mix(in srgb, var(--dm-accent-color) 85%, #fff); --dm-button-active-bg: color-mix(in srgb, var(--dm-accent-color) 70%, #fff); --dm-button-icon-fill: #111b21; --dm-timestamp-color: rgba(233, 237, 239, 0.65); --dm-model-indicator-color: rgba(233, 237, 239, 0.55); --dm-border-color: #2a3942; --dm-icon-button-hover-bg: rgba(255, 255, 255, 0.08); --dm-msg-action-icon-fill: rgba(255, 255, 255, 0.6); --dm-msg-action-icon-hover-fill: #ffffff; --dm-msg-action-icon-hover-bg: rgba(255, 255, 255, 0.1); --dm-scrollbar-thumb: #4a4a4a; --dm-scrollbar-track: #1a242b; --dm-link-color: #58a6ff; --dm-code-bg: #182128; --dm-code-text: #d1d5db; --dm-code-border: #374151; --dm-code-copy-btn-bg: rgba(255, 255, 255, 0.1); --dm-code-copy-btn-hover-bg: rgba(255, 255, 255, 0.15); --dm-code-copy-btn-copied-bg: var(--dm-button-bg); --dm-code-copy-btn-copied-text: #111b21; --dm-loading-spinner-color1: var(--dm-accent-color); --dm-loading-spinner-color2: #005c4b; --dm-shadow-light: 0 1px 1px rgba(0, 0, 0, 0.25); --dm-shadow-medium: 0 2px 5px rgba(0, 0, 0, 0.3); --dm-scroll-btn-bg: rgba(42, 57, 66, 0.9); --dm-scroll-btn-icon: #aebac1; --dm-scroll-btn-hover-bg: #2a3942; --dm-date-separator-bg: #2a3942; --dm-date-separator-text: #aebac1; --dm-focus-outline: var(--dm-accent-color); --dm-pinned-bg: #2c3e50; --dm-pinned-border: #34495e; --dm-toolbar-bg: #2a3942; --dm-toolbar-button-hover: #374151; --dm-tooltip-bg: #ddd; --dm-tooltip-text: #111; --dm-error-msg-bg: #4d1f1f; --dm-error-msg-border: #662d2d; --dm-error-msg-text: #ffdddd;


             /* Default Assign Light */
             --bg-default: var(--lm-bg-default); --chat-bg: var(--lm-chat-bg); /* ... other light vars ... */
             --accent-color: var(--lm-accent-color); --reply-bg: var(--lm-reply-bg);
             --modal-bg: var(--lm-modal-bg); --modal-shadow: var(--lm-modal-shadow);
             --pinned-bg: var(--lm-pinned-bg); --pinned-border: var(--lm-pinned-border);
             --toolbar-bg: var(--lm-toolbar-bg); --toolbar-button-hover: var(--lm-toolbar-button-hover);
             --tooltip-bg: var(--lm-tooltip-bg); --tooltip-text: var(--lm-tooltip-text);
             --error-msg-bg: var(--lm-error-msg-bg); --error-msg-border: var(--lm-error-msg-border);
             --error-msg-text: var(--lm-error-msg-text);
             --search-highlight-bg: var(--lm-search-highlight-bg);
             /* Assign all other LM vars */
             --header-bg: var(--lm-header-bg); --header-bg-image: var(--lm-header-bg-gradient); --header-text: var(--lm-header-text); --header-icon-fill: var(--lm-header-icon-fill); --user-msg-bg: var(--lm-user-msg-bg); --ai-msg-bg: var(--lm-ai-msg-bg); --msg-text: var(--lm-msg-text); --avatar-user-bg: var(--lm-avatar-user-bg); --avatar-ai-bg: var(--lm-avatar-ai-bg); --input-area-bg: var(--lm-input-area-bg); --input-bg: var(--lm-input-bg); --input-text: var(--lm-input-text); --input-border: var(--lm-input-border); --input-border-focus: var(--lm-input-border-focus); --button-bg: var(--lm-button-bg); --button-hover-bg: var(--lm-button-hover-bg); --button-active-bg: var(--lm-button-active-bg); --button-icon-fill: var(--lm-button-icon-fill); --timestamp-color: var(--lm-timestamp-color); --model-indicator-color: var(--lm-model-indicator-color); --border-color: var(--lm-border-color); --icon-button-hover-bg: var(--lm-icon-button-hover-bg); --msg-action-icon-fill: var(--lm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--lm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--lm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--lm-scrollbar-thumb); --scrollbar-track: var(--lm-scrollbar-track); --link-color: var(--lm-link-color); --code-bg: var(--lm-code-bg); --code-text: var(--lm-code-text); --code-border: var(--lm-code-border); --code-copy-btn-bg: var(--lm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--lm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--lm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--lm-code-copy-btn-copied-text); --loading-spinner-color1: var(--lm-loading-spinner-color1); --loading-spinner-color2: var(--lm-loading-spinner-color2); --shadow-light: var(--lm-shadow-light); --shadow-medium: var(--lm-shadow-medium); --scroll-btn-bg: var(--lm-scroll-btn-bg); --scroll-btn-icon: var(--lm-scroll-btn-icon); --scroll-btn-hover-bg: var(--lm-scroll-btn-hover-bg); --date-separator-bg: var(--lm-date-separator-bg); --date-separator-text: var(--lm-date-separator-text); --focus-outline-color: var(--lm-focus-outline);
             --select-bg: rgba(255, 255, 255, 0.15); --select-border: rgba(255, 255, 255, 0.3); --select-text: var(--lm-header-text); --select-arrow: var(--lm-header-icon-fill); --stop-button-fill: var(--lm-msg-action-icon-fill); --stop-button-hover-fill: var(--lm-msg-action-icon-hover-fill);

        }
        body.dark-mode {
             /* Assign all DM vars */
             --bg-default: var(--dm-bg-default); --chat-bg: var(--dm-chat-bg); /* ... other dark vars ... */
             --accent-color: var(--dm-accent-color); --reply-bg: var(--dm-reply-bg);
             --modal-bg: var(--dm-modal-bg); --modal-shadow: var(--dm-modal-shadow);
             --pinned-bg: var(--dm-pinned-bg); --pinned-border: var(--dm-pinned-border);
             --toolbar-bg: var(--dm-toolbar-bg); --toolbar-button-hover: var(--dm-toolbar-button-hover);
             --tooltip-bg: var(--dm-tooltip-bg); --tooltip-text: var(--dm-tooltip-text);
             --error-msg-bg: var(--dm-error-msg-bg); --error-msg-border: var(--dm-error-msg-border);
             --error-msg-text: var(--dm-error-msg-text);
             --search-highlight-bg: var(--dm-search-highlight-bg);
             /* Assign all other DM vars */
             --header-bg: var(--dm-header-bg); --header-bg-image: var(--dm-header-bg-gradient); --header-text: var(--dm-header-text); --header-icon-fill: var(--dm-header-icon-fill); --user-msg-bg: var(--dm-user-msg-bg); --ai-msg-bg: var(--dm-ai-msg-bg); --msg-text: var(--dm-msg-text); --avatar-user-bg: var(--dm-avatar-user-bg); --avatar-ai-bg: var(--dm-avatar-ai-bg); --input-area-bg: var(--dm-input-area-bg); --input-bg: var(--dm-input-bg); --input-text: var(--dm-input-text); --input-border: var(--dm-input-border); --input-border-focus: var(--dm-input-border-focus); --button-bg: var(--dm-button-bg); --button-hover-bg: var(--dm-button-hover-bg); --button-active-bg: var(--dm-button-active-bg); --button-icon-fill: var(--dm-button-icon-fill); --timestamp-color: var(--dm-timestamp-color); --model-indicator-color: var(--dm-model-indicator-color); --border-color: var(--dm-border-color); --icon-button-hover-bg: var(--dm-icon-button-hover-bg); --msg-action-icon-fill: var(--dm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--dm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--dm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--dm-scrollbar-thumb); --scrollbar-track: var(--dm-scrollbar-track); --link-color: var(--dm-link-color); --code-bg: var(--dm-code-bg); --code-text: var(--dm-code-text); --code-border: var(--dm-code-border); --code-copy-btn-bg: var(--dm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--dm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--dm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--dm-code-copy-btn-copied-text); --loading-spinner-color1: var(--dm-loading-spinner-color1); --loading-spinner-color2: var(--dm-loading-spinner-color2); --shadow-light: var(--dm-shadow-light); --shadow-medium: var(--dm-shadow-medium); --scroll-btn-bg: var(--dm-scroll-btn-bg); --scroll-btn-icon: var(--dm-scroll-btn-icon); --scroll-btn-hover-bg: var(--dm-scroll-btn-hover-bg); --date-separator-bg: var(--dm-date-separator-bg); --date-separator-text: var(--dm-date-separator-text); --focus-outline-color: var(--dm-focus-outline);
             --select-bg: rgba(255, 255, 255, 0.08); --select-border: rgba(255, 255, 255, 0.15); --select-text: var(--dm-header-text); --select-arrow: var(--dm-header-icon-fill); --stop-button-fill: var(--dm-msg-action-icon-fill); --stop-button-hover-fill: var(--dm-msg-action-icon-hover-fill);
        }

        /* --- Base & Layout --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: var(--font-main); background-color: var(--bg-default); color: var(--msg-text); display: flex; flex-direction: column; transition: background-color var(--transition-medium), color var(--transition-medium); font-size: 14.5px; }
        * { box-sizing: border-box; scroll-behavior: smooth; /* Base smooth scroll */ }
        #chat-container { width: 100%; max-width: 950px; /* Even wider */ height: calc(100vh - 20px); margin: 10px auto; background-color: var(--chat-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; transition: background-color var(--transition-medium), box-shadow var(--transition-medium); box-shadow: var(--shadow-medium); border-radius: var(--border-radius-medium); }

        /* Compact Mode */
        body.compact-mode { font-size: 13.5px; }
        body.compact-mode #chat-container { max-width: 1100px; }
        body.compact-mode .message { padding: 6px 12px; line-height: 1.45; }
        body.compact-mode .message-wrapper { --message-spacing: 6px; --message-spacing-grouped: 2px; }
        body.compact-mode .avatar-placeholder { --avatar-size: 26px; }
        body.compact-mode #chat-input-area { padding: 8px 12px; --input-area-min-height: 56px; }
        body.compact-mode #user-input { padding: 9px 15px; min-height: 38px; }
        body.compact-mode #send-button { width: 38px; height: 38px; }
        body.compact-mode #send-button::before { width: 20px; height: 20px; }

        /* Rounded Mode */
        body.rounded-mode { --border-radius-medium: 16px; --border-radius-large: 24px; }
        body.rounded-mode .avatar-placeholder { border-radius: 40%; } /* Squircle */
        body.rounded-mode #user-input { border-radius: 22px; }
        body.rounded-mode #send-button { border-radius: 22px; }
        body.rounded-mode .date-separator { border-radius: 20px; }
        body.rounded-mode #pinned-message { border-radius: 12px; }


        /* --- Header --- */
        #chat-header {
            /* ... existing styles ... */
            height: var(--header-height);
            padding: 0 16px; /* Adjusted padding for vertical centering */
            background-color: var(--header-bg);
            background-image: var(--header-bg-image);
            z-index: 10; /* Ensure header is above pinned message */
            position: relative; /* Needed for z-index */
        }
        #chat-header h1 { /* ... existing styles ... */ cursor: pointer; } /* Indicate title is editable */
        #chat-header h1:hover { opacity: 0.8; }

        /* NEW: Search Bar in Header */
        .header-search-container { display: none; /* Hidden by default */ align-items: center; background-color: var(--chat-bg); padding: 5px 10px; position: absolute; top: 0; left: 0; right: 0; height: 100%; z-index: 11; animation: slideDownFadeIn 0.3s ease; }
        .header-search-container.active { display: flex; }
        @keyframes slideDownFadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        #chat-search-input { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-large); background-color: var(--input-bg); color: var(--input-text); outline: none; font-size: 14px; }
        #search-results-count { font-size: 12px; color: var(--timestamp-color); margin: 0 8px; white-space: nowrap; }
        #search-prev-button, #search-next-button, #search-close-button { /* Use icon-button styling */ }

        /* NEW: Pinned Message Area */
        #pinned-message {
            display: none; /* Hidden by default */
            flex-shrink: 0; height: var(--pinned-message-height);
            background-color: var(--pinned-bg); border-bottom: 1px solid var(--pinned-border);
            padding: 0 16px; align-items: center; font-size: 13px;
            color: var(--msg-text); cursor: pointer; overflow: hidden;
            position: relative; /* For close button */
            transition: background-color var(--transition-medium), border-color var(--transition-medium), color var(--transition-medium);
        }
        #pinned-message.visible { display: flex; }
        #pinned-message:hover { background-color: color-mix(in srgb, var(--pinned-bg) 90%, var(--border-color)); }
        #pinned-message .pinned-icon { margin-left: 8px; font-size: 14px; color: var(--timestamp-color); }
        #pinned-message .pinned-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        #unpin-button { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; padding: 5px; cursor: pointer; border-radius: 50%; line-height: 0; }
        #unpin-button:hover { background-color: rgba(0,0,0,0.1); }
        #unpin-button svg { width: 16px; height: 16px; fill: var(--timestamp-color); }

        /* --- Chat Output --- */
        #chat-output {
            /* ... existing styles ... */
             height: calc(100% - var(--header-height) - var(--input-area-min-height)); /* Adjust height calculation */
             transition: height var(--transition-fast); /* Smooth resize for reply/toolbar */
        }
        #chat-output.has-pinned { height: calc(100% - var(--header-height) - var(--input-area-min-height) - var(--pinned-message-height)); }
        #chat-output.has-reply { height: calc(100% - var(--header-height) - var(--input-area-min-height) - var(--reply-preview-height)); /* Adjust later */}
        #chat-output.has-toolbar { height: calc(100% - var(--header-height) - var(--input-area-min-height) - var(--toolbar-height)); /* Adjust later */ }
        #chat-output.has-pinned.has-reply { /* Combine heights */}
        #chat-output.has-pinned.has-toolbar { /* Combine heights */}
        #chat-output.has-reply.has-toolbar { /* Combine heights */}
        #chat-output.has-pinned.has-reply.has-toolbar { /* Combine heights */}


        /* --- Messages --- */
        /* ... existing message, wrapper, avatar styles ... */
        .message.highlighted { /* For Search */
             background-color: var(--search-highlight-bg) !important; /* Force highlight */
             border: 1px dashed var(--accent-color);
             transition: background-color 0.5s ease;
        }
        .message.error-message { background-color: var(--error-msg-bg); border: 1px solid var(--error-msg-border); color: var(--error-msg-text); }
        .message.error-message .model-indicator { color: var(--error-msg-text) !important; opacity: 0.8; }
        .message-content img { max-width: 100%; height: auto; border-radius: var(--border-radius-medium); margin-top: 5px; cursor: pointer; /* For lightbox */ }
        /* Basic Table Styling */
        .message-content table { width: 100%; border-collapse: collapse; margin: 10px 0; direction: rtl; text-align: right; } /* Ensure RTL table */
        .message-content th, .message-content td { border: 1px solid var(--border-color); padding: 6px 10px; }
        .message-content th { background-color: var(--input-area-bg); font-weight: 600; }
        /* Read receipts (Visual Only) */
        .message-footer .read-receipts { margin-right: 5px; font-size: 14px; color: var(--timestamp-color); line-height: 1; }
        .message-footer .read-receipts.sent::before { content: 'âœ“'; }
        .message-footer .read-receipts.delivered::before { content: 'âœ“âœ“'; }
        .message-footer .read-receipts.read::before { content: 'âœ“âœ“'; color: #4fc3f7; } /* Blue ticks */
        /* Hide for AI messages */
        .ai-message .message-footer .read-receipts { display: none; }


        /* --- Message Actions --- */
        .message-actions { /* ... existing ... */ gap: 6px; } /* Slightly more space */
        /* NEW Actions: Pin, Star, Reply, Edit, Delete */
        .msg-action-button.pin-button::before { font-family: "Font Awesome 6 Free"; content: "\f08d"; font-weight: 900; }
        .msg-action-button.star-button::before { font-family: "Font Awesome 6 Free"; content: "\f005"; font-weight: 400; } /* Regular star */
        .message.starred .msg-action-button.star-button::before { font-weight: 900; color: gold; } /* Solid star when starred */
        .msg-action-button.reply-button::before { font-family: "Font Awesome 6 Free"; content: "\f112"; font-weight: 900; } /* Reply icon */
        /* Add Edit/Delete for user messages only later in JS */
        .msg-action-button.edit-button::before { font-family: "Font Awesome 6 Free"; content: "\f044"; font-weight: 900; } /* Edit icon */
        .msg-action-button.delete-button::before { font-family: "Font Awesome 6 Free"; content: "\f2ed"; font-weight: 900; } /* Trash icon */

        /* Tooltip for Actions */
        .msg-action-button[title]::after { /* Basic tooltip */
            content: attr(title); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background-color: var(--tooltip-bg); color: var(--tooltip-text); padding: 4px 8px; border-radius: var(--border-radius-small);
            font-size: 11px; white-space: nowrap; z-index: 10; pointer-events: none;
            opacity: 0; transition: opacity var(--transition-fast); box-shadow: var(--shadow-light);
        }
        .msg-action-button[title]:hover::after { opacity: 1; transition-delay: 0.5s; /* Delay showing tooltip */ }


        /* --- Collapsible Code Blocks --- */
        .message-content pre.collapsible { max-height: 200px; /* Limit height */ overflow: hidden; position: relative; transition: max-height var(--transition-medium); }
        .message-content pre.collapsible::after { /* Fade out effect */
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
            background: linear-gradient(to bottom, transparent, var(--code-bg)); pointer-events: none;
        }
        .message-content pre.collapsible.expanded { max-height: 1000px; /* Or large enough value */ }
        .message-content pre.collapsible.expanded::after { display: none; }
        .expand-code-button {
            position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            background-color: var(--code-copy-btn-hover-bg); color: var(--code-text); border: none;
            border-radius: var(--border-radius-small); padding: 3px 8px; font-size: 10px;
            cursor: pointer; z-index: 3; opacity: 0.7;
            transition: opacity var(--transition-fast), background-color var(--transition-fast);
        }
        .expand-code-button:hover { opacity: 1; }
        .message-content pre.collapsible.expanded .expand-code-button { display: none; }


        /* --- Input Area --- */
        /* NEW: Reply Preview */
        #reply-preview {
            display: none; /* Hidden by default */
            height: var(--reply-preview-height, 50px); /* Define height */
            background-color: var(--reply-bg); padding: 8px 14px;
            border-top: 1px solid var(--border-color); flex-shrink: 0;
            align-items: center; font-size: 13px; color: var(--msg-text);
            position: relative; overflow: hidden;
        }
        #reply-preview.visible { display: flex; }
        #reply-preview .reply-icon { margin-left: 8px; color: var(--accent-color); }
        #reply-preview .reply-content { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #reply-preview .reply-sender { font-weight: 600; margin-right: 5px; }
        #cancel-reply-button { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); /* Similar to unpin */ background: none; border: none; padding: 5px; cursor: pointer; border-radius: 50%; line-height: 0; }
        #cancel-reply-button:hover { background-color: rgba(0,0,0,0.1); }
        #cancel-reply-button svg { width: 16px; height: 16px; fill: var(--timestamp-color); }

        /* NEW: Input Toolbar */
        #input-toolbar {
            display: none; /* Hidden by default */
            height: var(--toolbar-height);
            background-color: var(--toolbar-bg); padding: 0 10px;
            border-top: 1px solid var(--border-color); flex-shrink: 0;
            align-items: center; gap: 5px;
        }
        #input-toolbar.visible { display: flex; }
        .toolbar-button { background: none; border: none; padding: 6px; cursor: pointer; border-radius: var(--border-radius-small); color: var(--msg-action-icon-fill); }
        .toolbar-button:hover { background-color: var(--toolbar-button-hover); color: var(--msg-action-icon-hover-fill); }
        .toolbar-button i { font-size: 16px; } /* Font Awesome icon size */

        #chat-input-area {
            /* ... existing styles ... */
            min-height: var(--input-area-min-height); /* Ensure min height */
             transition: background-color var(--transition-medium), border-color var(--transition-medium), min-height var(--transition-fast);
        }
        /* Input area main content (textarea + buttons) */
        .input-main-row { display: flex; align-items: flex-end; gap: 10px; width: 100%; padding-top: 5px; /* Space from toolbar/reply */ }

        /* NEW: Attachment/Emoji Buttons */
        .input-prefix-buttons { display: flex; align-items: center; gap: 5px; align-self: flex-end; margin-bottom: 5px; /* Align with bottom of initial textarea */ }
        .input-prefix-buttons .icon-button { padding: 6px; } /* Smaller padding */
        .input-prefix-buttons .icon-button svg, .input-prefix-buttons .icon-button i { width: 20px; height: 20px; fill: var(--timestamp-color); color: var(--timestamp-color); } /* Use secondary color */
        .input-prefix-buttons .icon-button:hover svg, .input-prefix-buttons .icon-button:hover i { fill: var(--msg-action-icon-hover-fill); color: var(--msg-action-icon-hover-fill); }

        #user-input { /* ... existing ... */ transition: height var(--transition-fast); /* Ensure height transition exists */}
        /* NEW: Character Counter */
        #char-counter { font-size: 11px; color: var(--timestamp-color); text-align: left; padding: 0 5px 2px 0; height: 15px; }

        #send-button { /* ... existing ... */ }
         /* Animation for send icon */
        #send-button.sending::before { animation: pulse-send-icon 0.5s ease-out; }
        @keyframes pulse-send-icon { 0% { transform: scale(1); } 50% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1); } }


        /* --- Modals (Settings, Confirmation) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 100; display: none; /* Hidden */ align-items: center; justify-content: center; opacity: 0; transition: opacity var(--transition-medium); }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background-color: var(--modal-bg); color: var(--msg-text); padding: 25px 30px; border-radius: var(--border-radius-medium); box-shadow: var(--modal-shadow); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform var(--transition-medium); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.3em; color: var(--msg-text); }
        .modal-close-button { position: absolute; top: 10px; left: 10px; background: none; border: none; font-size: 24px; color: var(--timestamp-color); cursor: pointer; padding: 5px; line-height: 1; border-radius: 50%; }
        .modal-close-button:hover { background-color: var(--icon-button-hover-bg); color: var(--msg-action-icon-hover-fill); }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-button { padding: 8px 16px; border-radius: var(--border-radius-medium); cursor: pointer; font-weight: 500; transition: background-color var(--transition-fast), color var(--transition-fast); }
        .modal-button.primary { background-color: var(--button-bg); color: var(--button-icon-fill); border: none; }
        .modal-button.primary:hover { background-color: var(--button-hover-bg); }
        .modal-button.secondary { background-color: transparent; color: var(--button-bg); border: 1px solid var(--button-bg); }
        .modal-button.secondary:hover { background-color: color-mix(in srgb, var(--button-bg) 10%, transparent); }
        .modal-button.danger { background-color: #dc3545; color: white; border: none; }
        .modal-button.danger:hover { background-color: #c82333; }
        /* Settings Modal Specifics */
        .settings-section { margin-bottom: 20px; }
        .settings-section label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; }
        .settings-section select, .settings-section input[type="text"], .settings-section input[type="number"], .settings-section input[type="range"], .settings-section textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--input-border); border-radius: var(--border-radius-medium); background-color: var(--input-bg); color: var(--input-text); font-size: 1em; margin-bottom: 5px; }
        .settings-section input[type="range"] { padding: 0; }
        .settings-section .range-value { font-size: 0.9em; color: var(--timestamp-color); margin-left: 10px; }
        .settings-section textarea { min-height: 80px; resize: vertical; }
        .setting-toggle { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }


    </style>
</head>
<body > <!-- Add classes dynamically: compact-mode, rounded-mode -->

<div id="chat-container">
    <div id="chat-header">
        <!-- NEW Search container -->
        <div class="header-search-container" id="header-search-area">
             <input type="text" id="chat-search-input" placeholder="×—×¤×© ×‘×”×•×“×¢×•×ª...">
             <span id="search-results-count">0/0</span>
             <button class="icon-button" id="search-prev-button" title="×”×ª×•×¦××” ×”×§×•×“××ª" aria-label="×”×ª×•×¦××” ×”×§×•×“××ª"><i class="fas fa-chevron-up"></i></button>
             <button class="icon-button" id="search-next-button" title="×”×ª×•×¦××” ×”×‘××”" aria-label="×”×ª×•×¦××” ×”×‘××”"><i class="fas fa-chevron-down"></i></button>
             <button class="icon-button" id="search-close-button" title="×¡×’×•×¨ ×—×™×¤×•×©" aria-label="×¡×’×•×¨ ×—×™×¤×•×©"><i class="fas fa-times"></i></button>
        </div>
        <!-- Original Header Content -->
        <h1 id="chat-title" title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×”×©×™×—×”">×¦'××˜ AI ××•×œ×˜×™××˜×™×‘×™</h1>
        <div class="header-controls">
            <button class="icon-button" id="search-open-button" title="×—×¤×© ×‘×©×™×—×”" aria-label="×—×¤×© ×‘×©×™×—×”"><i class="fas fa-search"></i></button>
            <select id="model-select" aria-label="×‘×—×¨ ××•×“×œ AI">
                <!-- Options -->
                 <option value="main-ai.php">Gemini 1.5 Flash</option>
                 <option value="gemini25.php">Gemini 1.5 Pro</option>
            </select>
            <button class="icon-button" id="settings-button" title="×”×’×“×¨×•×ª" aria-label="×”×’×“×¨×•×ª"><i class="fas fa-cog"></i></button> <!-- Settings Icon -->
            <button class="icon-button" id="dark-mode-toggle" title="×©× ×” ×¢×¨×›×ª × ×•×©×" aria-label="×©× ×” ×¢×¨×›×ª × ×•×©×">
                <svg id="theme-icon-light" ...></svg>
                <svg id="sun-icon" ...></svg>
            </button>
            <button class="icon-button" id="download-chat" title="×”×•×¨×“ ×¦'××˜" aria-label="×”×•×¨×“ ×¦'××˜">
                 <svg ...></svg>
            </button>
            <button class="icon-button" id="clear-chat" title="× ×§×” ×¦'××˜" aria-label="× ×§×” ×¦'××˜">
                <svg ...></svg>
            </button>
        </div>
    </div>

    <!-- NEW Pinned Message -->
    <div id="pinned-message">
        <i class="fas fa-thumbtack pinned-icon"></i>
        <span class="pinned-text">×–×•×”×™ ×”×•×“×¢×” × ×¢×•×¦×” ×œ×“×•×’××”...</span>
        <button id="unpin-button" title="×‘×˜×œ × ×¢×™×¦×”" aria-label="×‘×˜×œ × ×¢×™×¦×”">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 9V4h2V2H6v2h2v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg> <!-- Placeholder unpin icon -->
        </button>
    </div>


    <div id="chat-output" aria-live="polite" role="log">
         <!-- Initial Message -->
         <div class="message-wrapper ai-message-wrapper" data-sender="ai">
             <div class="avatar-placeholder"></div>
             <div class="message ai-message" data-message-id="initial-0" tabindex="0"> <!-- Add tabindex -->
                 <div class="message-content"><span>ğŸ‘‹ ×©×œ×•×! ×× ×™ ××•×›×Ÿ ×œ×¢×–×•×¨. ×‘×—×¨ ××•×“×œ AI ×•×”×ª×—×œ ×œ×©×•×—×—. ×”×©×ª××© ×‘-Shift+Enter ×œ×©×•×¨×” ×—×“×©×”.</span></div>
                 <div class="message-footer"><span class="timestamp">×”×ª×—×œ</span></div>
             </div>
         </div>
         <!-- Messages will be added here -->
         <button id="scroll-to-bottom" title="×’×œ×•×œ ×œ×ª×—×ª×™×ª" aria-label="×’×œ×•×œ ×œ×ª×—×ª×™×ª">...</button>
         <button id="scroll-to-top" title="×’×œ×•×œ ×œ×¨××© ×”×©×™×—×”" aria-label="×’×œ×•×œ ×œ×¨××© ×”×©×™×—×”" style="display: none; /* NEW */ position: absolute; top: 70px; left: 20px; /* Mirror bottom button */ z-index: 20; /* etc. */ "><i class="fas fa-arrow-up"></i></button>
    </div>

    <!-- NEW Reply Preview Area -->
    <div id="reply-preview">
         <i class="fas fa-reply reply-icon"></i>
         <span class="reply-sender">××ª×”:</span>
         <span class="reply-content">×˜×§×¡×˜ ×”×”×•×“×¢×” ×”××¦×•×˜×˜×ª ×™×•×¤×™×¢ ×›××Ÿ...</span>
         <button id="cancel-reply-button" title="×‘×˜×œ ×ª×’×•×‘×”" aria-label="×‘×˜×œ ×ª×’×•×‘×”"><i class="fas fa-times"></i></button>
    </div>

    <!-- NEW Input Toolbar -->
    <div id="input-toolbar">
         <button class="toolbar-button" data-format="bold" title="××•×“×’×© (Ctrl+B)"><i class="fas fa-bold"></i></button>
         <button class="toolbar-button" data-format="italic" title="× ×˜×•×™ (Ctrl+I)"><i class="fas fa-italic"></i></button>
         <button class="toolbar-button" data-format="code" title="×§×•×“ ××•×˜×‘×¢"><i class="fas fa-code"></i></button>
         <button class="toolbar-button" data-format="ul" title="×¨×©×™××”"><i class="fas fa-list-ul"></i></button>
         <button class="toolbar-button" data-format="link" title="×§×™×©×•×¨"><i class="fas fa-link"></i></button>
         <!-- Add more formatting buttons as needed -->
    </div>

    <div id="chat-input-area">
        <div class="input-main-row">
            <!-- NEW Prefix Buttons -->
            <div class="input-prefix-buttons">
                 <button class="icon-button" id="emoji-picker-button" title="×‘×—×¨ ××™××•×’'×™" aria-label="×‘×—×¨ ××™××•×’'×™"><i class="far fa-smile"></i></button>
                 <button class="icon-button" id="attachment-button" title="×¦×¨×£ ×§×•×‘×¥ (UI)" aria-label="×¦×¨×£ ×§×•×‘×¥"><i class="fas fa-paperclip"></i></button>
            </div>
            <textarea id="user-input" placeholder="×”×§×œ×“/×™ ×”×•×“×¢×”..." rows="1" aria-label="×”×•×“×¢×ª ××©×ª××©"></textarea>
            <button id="send-button" aria-label="×©×œ×—" disabled></button>
        </div>
         <!-- NEW Character Counter -->
        <div id="char-counter">0</div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
        <button class="modal-close-button" aria-label="×¡×’×•×¨ ×”×’×“×¨×•×ª">&times;</button>
        <h2>×”×’×“×¨×•×ª ×©×™×—×”</h2>

        <div class="settings-section">
            <label for="system-prompt">×”× ×—×™×™×ª ××¢×¨×›×ª (System Prompt)</label>
            <textarea id="system-prompt" rows="3" placeholder="×œ×“×•×’××”: ×ª××™×“ ×ª×¢× ×” ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª ×•××¤×•×¨×˜×ª."></textarea>
        </div>

        <div class="settings-section">
            <label for="temperature-slider">×˜××¤×¨×˜×•×¨×” (×™×¦×™×¨×ª×™×•×ª)</label>
            <div style="display: flex; align-items: center;">
                 <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.7">
                 <span class="range-value" id="temperature-value">0.7</span>
            </div>
        </div>

         <div class="settings-section">
             <label>××¦×‘ ×ª×¦×•×’×”</label>
             <div class="setting-toggle">
                 <span>××¦×‘ ×§×•××¤×§×˜×™</span>
                 <input type="checkbox" id="compact-mode-toggle">
             </div>
             <div class="setting-toggle">
                 <span>×¤×™× ×•×ª ××¢×•×’×œ×•×ª</span>
                 <input type="checkbox" id="rounded-mode-toggle">
             </div>
             <div class="setting-toggle">
                <span>×¦×œ×™×œ×™ ×”×ª×¨××•×ª (××•×©×‘×ª)</span>
                <input type="checkbox" id="sound-toggle" disabled>
            </div>
         </div>

        <div class="settings-section">
            <label for="accent-color-picker">×¦×‘×¢ ×”×“×’×©×”</label>
            <input type="color" id="accent-color-picker" value="#008069"> <!-- Default Light -->
        </div>


        <div class="modal-actions">
            <button class="modal-button secondary" id="settings-cancel-button">×‘×™×˜×•×œ</button>
            <button class="modal-button primary" id="settings-save-button">×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="confirmation-modal">
     <div class="modal-content">
         <h2 id="confirmation-title">××™×©×•×¨ ×¤×¢×•×œ×”</h2>
         <p id="confirmation-message">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•?</p>
         <div class="modal-actions">
             <button class="modal-button secondary" id="confirmation-cancel-button">×‘×™×˜×•×œ</button>
             <button class="modal-button danger" id="confirmation-confirm-button">××™×©×•×¨</button> <!-- Default to danger -->
         </div>
     </div>
</div>

<!-- Image Lightbox (Very Basic) -->
<div class="modal-overlay" id="image-lightbox">
    <div class="modal-content" style="background:none; box-shadow:none; padding:10px; max-width: 90vw; max-height: 90vh;">
         <button class="modal-close-button" style="color:white; background:rgba(0,0,0,0.5);">&times;</button>
        <img id="lightbox-image" src="" alt="×ª×¦×•×’×” ××§×“×™××”" style="max-width:100%; max-height:100%; object-fit: contain; display:block;">
    </div>
</div>


<!-- Include Libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Optional: Load specific languages for highlight.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<!-- ... other languages ... -->
<!-- KaTeX JS (Optional) -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>


<script>
    // --- V3.0 Code + MANY Enhancements ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References (Many NEW ones) ---
        const body = document.body;
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const chatTitle = document.getElementById('chat-title');
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');
        const scrollToTopButton = document.getElementById('scroll-to-top'); // NEW
        const pinnedMessageArea = document.getElementById('pinned-message'); // NEW
        const unpinButton = document.getElementById('unpin-button'); // NEW
        const replyPreviewArea = document.getElementById('reply-preview'); // NEW
        const cancelReplyButton = document.getElementById('cancel-reply-button'); // NEW
        const inputToolbar = document.getElementById('input-toolbar'); // NEW
        const emojiPickerButton = document.getElementById('emoji-picker-button'); // NEW
        const attachmentButton = document.getElementById('attachment-button'); // NEW
        const charCounter = document.getElementById('char-counter'); // NEW
        const settingsButton = document.getElementById('settings-button'); // NEW
        const settingsModal = document.getElementById('settings-modal'); // NEW
        const settingsCancelButton = document.getElementById('settings-cancel-button'); // NEW
        const settingsSaveButton = document.getElementById('settings-save-button'); // NEW
        const systemPromptInput = document.getElementById('system-prompt'); // NEW
        const temperatureSlider = document.getElementById('temperature-slider'); // NEW
        const temperatureValue = document.getElementById('temperature-value'); // NEW
        const compactModeToggle = document.getElementById('compact-mode-toggle'); // NEW
        const roundedModeToggle = document.getElementById('rounded-mode-toggle'); // NEW
        const accentColorPicker = document.getElementById('accent-color-picker'); // NEW
        const confirmationModal = document.getElementById('confirmation-modal'); // NEW
        const confirmationTitle = document.getElementById('confirmation-title'); // NEW
        const confirmationMessage = document.getElementById('confirmation-message'); // NEW
        const confirmationCancelButton = document.getElementById('confirmation-cancel-button'); // NEW
        const confirmationConfirmButton = document.getElementById('confirmation-confirm-button'); // NEW
        const imageLightbox = document.getElementById('image-lightbox'); // NEW
        const lightboxImage = document.getElementById('lightbox-image'); // NEW
        const searchOpenButton = document.getElementById('search-open-button'); // NEW
        const searchArea = document.getElementById('header-search-area'); // NEW
        const searchInput = document.getElementById('chat-search-input'); // NEW
        const searchResultsCount = document.getElementById('search-results-count'); // NEW
        const searchPrevButton = document.getElementById('search-prev-button'); // NEW
        const searchNextButton = document.getElementById('search-next-button'); // NEW
        const searchCloseButton = document.getElementById('search-close-button'); // NEW

        // --- State Variables (More Added) ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/';
        let messageCounter = 0;
        let currentAbortController = null;
        let typingTimeout = null;
        let lastMessageSender = null;
        let lastMessageTimestamp = null;
        let isAutoScrolling = true;
        let userScrolledUp = false;
        // let clearChatConfirmNeeded = false; // Replaced by modal
        let currentReplyMessageId = null; // NEW
        let inputHistory = JSON.parse(localStorage.getItem('inputHistory') || '[]'); // NEW
        let inputHistoryIndex = inputHistory.length; // NEW
        let draftMessage = localStorage.getItem('draftMessage') || ''; // NEW
        let pinnedMessageId = localStorage.getItem('pinnedMessageId'); // NEW
        let currentSearchTerm = ''; // NEW
        let searchResults = []; // NEW
        let currentSearchIndex = -1; // NEW
        let confirmationCallback = null; // NEW For modal confirmation

        const TYPING_SPEED = 8;
        const SCROLL_THRESHOLD = 150;
        const SCROLL_LOCK_THRESHOLD = 50;
        const MAX_INPUT_HISTORY = 50; // NEW
        const MAX_CHAR_COUNT = 4000; // Example limit

        // --- Utility Functions ---
        function getCurrentTimestamp() { /* ... */ }
        function getCurrentDateString(date = new Date()) { /* ... */ }
        function generateMessageId() { /* ... */ }
        function sanitizeHtml(html) { /* Implement robust sanitization if needed */ return html; }
        function formatDateSeparator(dateStr) { /* ... */ }

        function scrollToBottom(behavior = 'smooth', force = false) { /* ... existing ... */ }
        function scrollToTop(behavior = 'smooth') { chatOutput.scrollTo({ top: 0, behavior }); } // NEW

        // --- Debounce Function ---
        function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         };

         // --- Show/Hide Modal ---
         function showModal(modalElement) {
             modalElement.classList.add('visible');
             // Trap focus (basic example)
             // Find focusable elements, handle Tab/Shift+Tab
         }
         function hideModal(modalElement) {
             modalElement.classList.remove('visible');
             if (confirmationCallback) { // Reset confirmation state
                confirmationCallback = null;
             }
         }

         // --- Show Confirmation Modal ---
         function showConfirmation(title, message, confirmText = '××™×©×•×¨', confirmClass = 'danger', callback) {
             confirmationTitle.textContent = title;
             confirmationMessage.textContent = message;
             confirmationConfirmButton.textContent = confirmText;
             // Reset classes and add the specified one
             confirmationConfirmButton.classList.remove('primary', 'secondary', 'danger');
             confirmationConfirmButton.classList.add(confirmClass);
             confirmationCallback = callback;
             showModal(confirmationModal);
         }

        // --- Add Date Separator ---
        function addDateSeparatorIfNeeded(messageTimestamp) { /* ... existing ... */ }

        // --- Get Chat History ---
        function getChatHistory(currentUserMessage, forRegeneration = false, regenerationTargetMsgId = null) { /* ... existing, ensure it handles Markdown well ... */ }

        // --- Add Message to Chat Function (Enhanced) ---
        function addMessageToChat(text, sender, options = {}) {
             const { isLoading = false, isError = false, timestamp: providedTimestamp = null, modelNameUsed = null, userQuery = null, modelValue = null, rawMarkdown = null, messageId: providedId = null, isPinned = false, isStarred = false, // NEW
                     replyToId = null // NEW
                 } = options;

             const messageTimestamp = Date.now();
             const displayTimestamp = providedTimestamp || getCurrentTimestamp();
             const dateSeparatorAdded = addDateSeparatorIfNeeded(messageTimestamp);

             const messageId = providedId || generateMessageId();
             const messageWrapper = document.createElement('div');
             // ... existing wrapper setup ...
             messageWrapper.dataset.messageId = messageId; // Add ID to wrapper too for easier selection

             const avatarDiv = document.createElement('div');
             avatarDiv.classList.add('avatar-placeholder');

             const messageDiv = document.createElement('div');
             messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
             if (isError) messageDiv.classList.add('error-message'); // Error styling
             if (isStarred) messageDiv.classList.add('starred'); // Starred styling
             messageDiv.dataset.messageId = messageId;
             messageDiv.dataset.timestamp = displayTimestamp;
             messageDiv.setAttribute('tabindex', '0'); // Make message focusable

             // Grouping Logic
             // ... existing grouping logic ...

             // NEW: Add Reply Context if applicable
             if (replyToId) {
                 const repliedMsgElement = chatOutput.querySelector(`.message[data-message-id="${replyToId}"]`);
                 if (repliedMsgElement) {
                    const replyContextDiv = document.createElement('div');
                    replyContextDiv.classList.add('reply-context'); // Add CSS for this
                    const repliedSender = repliedMsgElement.closest('.message-wrapper')?.dataset.sender === 'user' ? '××ª×”' : 'AI';
                    const repliedText = repliedMsgElement.querySelector('.message-content')?.textContent.substring(0, 50) + '...'; // Snippet
                    replyContextDiv.innerHTML = `<i class="fas fa-reply"></i> <strong>${repliedSender}:</strong> ${repliedText}`;
                    replyContextDiv.addEventListener('click', () => {
                        repliedMsgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        repliedMsgElement.classList.add('highlighted');
                        setTimeout(() => repliedMsgElement.classList.remove('highlighted'), 1500);
                    });
                    messageDiv.appendChild(replyContextDiv); // Add before content
                 }
             }


             const contentDiv = document.createElement('div');
             contentDiv.classList.add('message-content');

             if (isLoading) {
                // ... existing loading indicator ...
             } else {
                 // ... existing content rendering (Text, Markdown) ...
                 // NEW: Render Math (after Markdown)
                 if (typeof renderMathInElement === 'function') {
                    try {
                        renderMathInElement(contentDiv, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\(', right: '\\)', display: false},
                                {left: '\\[', right: '\\]', display: true}
                            ],
                            throwOnError : false
                        });
                    } catch (e) { console.error("KaTeX rendering error:", e); }
                 }

                 // Render Images (basic)
                 contentDiv.querySelectorAll('a').forEach(link => {
                    if (/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(link.href)) {
                        const img = document.createElement('img');
                        img.src = link.href;
                        img.alt = "×ª××•× ×” ×©×¡×•×¤×§×” ×¢×œ ×™×“×™ AI";
                        img.loading = 'lazy'; // Lazy load images
                        img.addEventListener('click', () => showImageLightbox(img.src));
                        link.parentNode.replaceChild(img, link); // Replace link with image
                    }
                    // Add target blank to external links
                    if (!link.href.startsWith(window.location.origin) && !link.href.startsWith('mailto:')) {
                       link.target = '_blank';
                       link.rel = 'noopener noreferrer'; // Security
                    }
                 });


                 messageDiv.appendChild(contentDiv);

                 // Footer (with Read Receipts)
                 const footerDiv = document.createElement('div');
                 // ... existing footer content (model, timestamp) ...

                  // Read Receipts (Mockup for user messages)
                  if(sender === 'user') {
                     const receiptsSpan = document.createElement('span');
                     receiptsSpan.classList.add('read-receipts', 'sent'); // Start as 'sent'
                     receiptsSpan.setAttribute('aria-label', '× ×©×œ×—');
                     footerDiv.appendChild(receiptsSpan);
                     // Simulate delivered/read later (conceptual)
                     // setTimeout(() => { receiptsSpan.classList.remove('sent'); receiptsSpan.classList.add('delivered'); receiptsSpan.setAttribute('aria-label', '× ××¡×¨'); }, 1500);
                     // setTimeout(() => { receiptsSpan.classList.remove('delivered'); receiptsSpan.classList.add('read'); receiptsSpan.setAttribute('aria-label', '× ×§×¨×'); }, 3000);
                  }

                 footerDiv.appendChild(timestampSpan);
                 messageDiv.appendChild(footerDiv);

                 // Actions (More added)
                 if (displayTimestamp !== '×”×ª×—×œ') {
                     const actionsDiv = document.createElement('div');
                     actionsDiv.classList.add('message-actions');

                     // Always add Copy
                     // ... copy button ...

                     // Add Reply
                     const replyButton = createActionButton('reply-button', '×”×’×‘', 'fas fa-reply', handleReplyClick);
                     actionsDiv.appendChild(replyButton);

                     // AI Message Actions
                     if (sender === 'ai' && !isError) {
                         const regenerateButton = createActionButton('regenerate-button', '×¦×•×¨ ×ª×’×•×‘×” ××—×“×©', 'fas fa-sync-alt', handleRegenerateClick);
                         // Add loading spinner placeholder to regenerate button
                         const regenSpinner = document.createElement('div');
                         regenSpinner.className = 'action-spinner'; // Style this spinner
                         regenerateButton.appendChild(regenSpinner);
                         actionsDiv.appendChild(regenerateButton);
                     }

                     // User Message Actions (Edit/Delete UI)
                     if (sender === 'user') {
                         const editButton = createActionButton('edit-button', '×¢×¨×•×š (UI)', 'fas fa-pencil-alt', handleEditClick);
                         actionsDiv.appendChild(editButton);
                         const deleteButton = createActionButton('delete-button', '××—×§ (UI)', 'fas fa-trash-alt', handleDeleteClick);
                         actionsDiv.appendChild(deleteButton);
                     }

                     // Pin/Unpin Action
                     const pinButton = createActionButton('pin-button', isPinned ? '×‘×˜×œ × ×¢×™×¦×”' : '× ×¢×œ ×”×•×“×¢×”', 'fas fa-thumbtack', handlePinClick);
                     if (isPinned) pinButton.classList.add('active'); // Style active state
                     actionsDiv.appendChild(pinButton);

                     // Star/Unstar Action
                     const starButton = createActionButton('star-button', isStarred ? '×‘×˜×œ ×¡×™××•×Ÿ ×›×•×›×‘' : '×¡××Ÿ ×‘×›×•×›×‘', 'far fa-star', handleStarClick); // Use far for outline
                     if (isStarred) starButton.querySelector('i').classList.replace('far','fas'); // Solid star if starred
                      actionsDiv.appendChild(starButton);


                     messageDiv.appendChild(actionsDiv);
                     finalizeMessageRendering(contentDiv);
                 }
             }

             messageWrapper.appendChild(avatarDiv);
             messageWrapper.appendChild(messageDiv);
             chatOutput.insertBefore(messageWrapper, scrollToBottomButton);

              // Scroll logic
              // ... existing scroll logic ...

             return messageDiv;
         }

         // --- Helper to Create Action Buttons ---
         function createActionButton(className, title, iconClass, clickHandler) {
             const button = document.createElement('button');
             button.classList.add('msg-action-button', className);
             button.title = title;
             button.setAttribute('aria-label', title);
             button.innerHTML = `<i class="${iconClass}"></i>`; // Using Font Awesome
             button.addEventListener('click', clickHandler);
             return button;
         }

         // --- AI Typing Effect (Render instantly after parsing) ---
         function typeAiResponse(messageElement, fullMarkdownText) {
             const contentDiv = messageElement.querySelector('.message-content');
             if (!contentDiv) return;

             messageElement.dataset.rawMarkdown = fullMarkdownText;
             messageElement.classList.add('typing-cursor');

             marked.setOptions({ breaks: true, gfm: true /*, sanitize: true */ });
             let htmlContent = '';
             try {
                 htmlContent = marked.parse(fullMarkdownText || '');
             } catch (e) { htmlContent = fullMarkdownText; }

             // Render immediately, remove cursor after short delay
             contentDiv.innerHTML = htmlContent;
             finalizeMessageRendering(contentDiv); // Add copy buttons, highlight, math

             clearTimeout(typingTimeout);
             typingTimeout = setTimeout(() => {
                 finalizeAiMessage(messageElement); // Remove cursor, enable input etc.
             }, 150); // Short delay before removing cursor

             scrollToBottom('auto');
         }

        // --- Finalize Rendering (Highlighting, Copy Buttons, Math, Code Collapse) ---
        function finalizeMessageRendering(contentDiv) {
             if (!contentDiv) return;
             // Add copy buttons & Ensure code tags
             contentDiv.querySelectorAll('pre').forEach(pre => {
                 if (!pre.querySelector('code')) { /* ... add code tag ... */ }
                 addCopyButtonToCodeBlock(pre);

                 // NEW: Make long code blocks collapsible
                 if (pre.scrollHeight > 210 && !pre.querySelector('.expand-code-button')) { // Check height and if button exists
                    pre.classList.add('collapsible');
                    const expandButton = document.createElement('button');
                    expandButton.className = 'expand-code-button';
                    expandButton.textContent = '×”×¦×’ ×™×•×ª×¨';
                    expandButton.onclick = (e) => {
                        e.stopPropagation();
                        pre.classList.toggle('expanded');
                        expandButton.textContent = pre.classList.contains('expanded') ? '×”×¦×’ ×¤×—×•×ª' : '×”×¦×’ ×™×•×ª×¨';
                    };
                    pre.appendChild(expandButton);
                 }
             });

             // Apply Syntax Highlighting
             contentDiv.querySelectorAll('pre code').forEach((block) => { /* ... highlight ... */ });

             // Render MathML (if using MathJax/KaTeX)
             // Already called in addMessageToChat after Markdown parsing for KaTeX auto-render
        }

        // --- Finalize AI Message ---
        function finalizeAiMessage(messageElement) { /* ... existing ... */ }

        // --- Stop Typing and Fetch Request ---
        function stopTypingAndGeneration() { /* ... existing ... */ }

        // --- Add Copy Button to Code Block ---
        function addCopyButtonToCodeBlock(preElement) { /* ... existing ... */ }

        // --- Disable/Enable Input ---
        function disableInput() { /* ... existing ... */ }
        function enableInput() { /* ... existing ... */ }

        // --- Send Message (Enhanced for Reply Context, History, Drafts) ---
        async function sendMessage(textToSend, options = {}, skipResponse = false) {
             const { isRegeneration = false, /* ... other options ... */ } = options;
             let currentText = textToSend !== undefined ? textToSend.trim() : userInput.value.trim();

             if (currentText === '' || currentAbortController || typingTimeout) return;

             disableInput();
             isAutoScrolling = true; // Ensure auto-scroll

             // Add to input history
             if (currentText !== inputHistory[inputHistory.length - 1]) { // Avoid duplicates
                 inputHistory.push(currentText);
                 if (inputHistory.length > MAX_INPUT_HISTORY) {
                     inputHistory.shift(); // Keep history bounded
                 }
                 localStorage.setItem('inputHistory', JSON.stringify(inputHistory));
             }
             inputHistoryIndex = inputHistory.length; // Reset history index

             // Clear draft
             draftMessage = '';
             localStorage.removeItem('draftMessage');

             // Prepare message options (including reply)
             const messageOptions = {
                 replyToId: currentReplyMessageId // Include if replying
             };

             if (!isRegeneration) {
                 addMessageToChat(currentText, 'user', messageOptions);
                 userInput.value = '';
                 adjustTextareaHeight();
                 sendButton.disabled = true;
                 charCounter.textContent = '0'; // Reset counter
                 // Clear reply state
                 if (currentReplyMessageId) {
                     hideReplyPreview();
                 }
             }
             // ... rest of regeneration logic ...

             if (skipResponse && !isRegeneration) { /* ... */ return; }

             // --- Fetch Logic ---
             // Modify API request to potentially include System Prompt, Temperature, Reply Context
             const historyArray = getChatHistory(/* ... */);
             let historyStringPart = ""; /* ... */
             const systemPrompt = localStorage.getItem('systemPrompt') || ''; // Get system prompt
             const temperature = parseFloat(localStorage.getItem('temperature') || '0.7'); // Get temperature

             // Construct payload - backend needs to handle these
             const requestPayload = {
                text: currentText, // Send only the current text
                history: historyArray, // Send history separately
                system_prompt: systemPrompt,
                temperature: temperature,
                // Optionally send reply context if backend uses it
                // reply_context: currentReplyMessageId ? getMessageContent(currentReplyMessageId) : null
             };

             // ... existing fetch setup ...

             try {
                 console.log(`Sending to ${currentApiUrl} with model ${modelName}`);
                 // Send new payload structure
                 const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestPayload), signal });

                 // ... existing response handling ...

                 if (data && data.text) {
                      const aiMessageElement = addMessageToChat(data.text, 'ai', {
                         // ... existing options ...
                         rawMarkdown: data.text
                     });
                      // typeAiResponse(aiMessageElement, data.text); // Handled by addMessageToChat now
                 } else {
                     // ... handle missing text ...
                 }

             } catch (error) {
                 // ... existing error handling ...
             }
         }

        // --- Format Error for User ---
        function formatErrorForUser(error) { /* ... existing ... */ }

        // --- UI Interaction Functions (Many NEW or Updated) ---
        function toggleDarkMode(forceMode) { /* ... existing + updateHighlightTheme ... */ }
        function updateHighlightTheme(isDark) { /* ... existing ... */ }
        function updateSelectArrowColor() { /* ... existing ... */ }
        function downloadChat() { /* Add options later: JSON, MD */ /* ... existing text download ... */ }

        // --- Confirmation Modal for Clear Chat ---
        function handleClearChatClick() {
            showConfirmation(
                '××™×©×•×¨ ××—×™×§×ª ×©×™×—×”',
                '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×œ×¦××™×ª×•×ª ××ª ×›×œ ×”×”×•×“×¢×•×ª ×‘×©×™×—×” ×–×•?',
                '××—×§ ×”×›×œ',
                'danger',
                () => { // This is the callback executed on confirm
                    clearChat();
                    hideModal(confirmationModal);
                }
            );
        }
        function clearChat() { /* ... existing ... */ }
        function resetClearChatButton() { /* No longer needed */ }

        // --- Handle URL Parameters ---
        function handleUrlParameter() { /* ... existing ... */ }

        // --- Adjust Textarea Height & Counter ---
        function adjustTextareaHeight() {
             userInput.style.height = 'auto'; const scrollHeight = userInput.scrollHeight; const maxHeight = parseInt(window.getComputedStyle(userInput).maxHeight, 10);
             // ... height adjustment logic ...
             sendButton.disabled = userInput.value.trim().length === 0 || currentAbortController !== null || typingTimeout !== null;
             // Update character counter
             const currentLength = userInput.value.length;
             charCounter.textContent = `${currentLength}${MAX_CHAR_COUNT ? `/${MAX_CHAR_COUNT}` : ''}`;
             charCounter.style.color = (MAX_CHAR_COUNT && currentLength > MAX_CHAR_COUNT) ? 'red' : 'var(--timestamp-color)';
        }
        const debouncedAdjustHeight = debounce(adjustTextareaHeight, 50); // Debounce for performance

        // --- Handle Copy Click ---
        function handleCopyClick(event) { /* ... existing ... */ }

        // --- Handle Regenerate Click (with Loading State) ---
        function handleRegenerateClick(event) {
             if (currentAbortController || typingTimeout) return;
             const button = event.currentTarget;
             const spinner = button.querySelector('.action-spinner');
             // ... get message data ...
             if (!userQuery || !modelValue || !modelName || !messageId) return;

             button.disabled = true; // Disable button
             spinner.style.display = 'inline-block'; // Show spinner

             sendMessage(userQuery, { /* ... regen options ... */ })
                 .finally(() => {
                     // Re-enable button and hide spinner regardless of success/failure
                     // Need to find the button again as the original element might be removed
                     const newButton = chatOutput.querySelector(`.message[data-message-id$="-${messageId.split('-').pop()}"] .regenerate-button`); // Find based on likely new ID or re-query DOM
                     if (newButton) {
                        newButton.disabled = false;
                        const newSpinner = newButton.querySelector('.action-spinner');
                        if (newSpinner) newSpinner.style.display = 'none';
                     } else {
                         // Fallback: Enable general input if button not found
                         enableInput();
                     }
                 });
        }

        // --- Handle Reply Click ---
        function handleReplyClick(event) {
            const button = event.currentTarget;
            const messageElement = button.closest('.message');
            if (!messageElement) return;
            currentReplyMessageId = messageElement.dataset.messageId;
            showReplyPreview(messageElement);
            userInput.focus();
        }

        // --- Show/Hide Reply Preview ---
        function showReplyPreview(messageElement) {
            const sender = messageElement.closest('.message-wrapper')?.dataset.sender === 'user' ? '××ª×”' : 'AI';
            const content = messageElement.querySelector('.message-content')?.textContent.substring(0, 70) + '...';
            replyPreviewArea.querySelector('.reply-sender').textContent = `${sender}:`;
            replyPreviewArea.querySelector('.reply-content').textContent = content;
            replyPreviewArea.classList.add('visible');
            // Adjust chat output height
            chatOutput.style.height = `calc(${getComputedStyle(chatOutput).height} - ${getComputedStyle(replyPreviewArea).height})`;
        }
        function hideReplyPreview() {
            if (!replyPreviewArea.classList.contains('visible')) return;
             replyPreviewArea.classList.remove('visible');
             currentReplyMessageId = null;
             // Restore chat output height
             chatOutput.style.height = `calc(${getComputedStyle(chatOutput).height} + ${getComputedStyle(replyPreviewArea).height})`;
        }

        // --- Handle Pin Click ---
        function handlePinClick(event) {
            const button = event.currentTarget;
            const messageElement = button.closest('.message');
            const messageId = messageElement?.dataset.messageId;
            if (!messageId) return;

            if (pinnedMessageId === messageId) { // Currently pinned, so unpin
                pinnedMessageId = null;
                localStorage.removeItem('pinnedMessageId');
                updatePinnedMessageDisplay();
                button.classList.remove('active');
                button.title = '× ×¢×œ ×”×•×“×¢×”';
                 button.querySelector('i').className = 'fas fa-thumbtack'; // Update icon if needed
            } else { // Pin this message
                const oldPinnedMessageId = pinnedMessageId;
                pinnedMessageId = messageId;
                localStorage.setItem('pinnedMessageId', messageId);
                updatePinnedMessageDisplay();
                 button.classList.add('active');
                 button.title = '×‘×˜×œ × ×¢×™×¦×”';
                 // Deactivate the old pin button if it exists
                 if (oldPinnedMessageId) {
                     const oldPinButton = chatOutput.querySelector(`.message[data-message-id="${oldPinnedMessageId}"] .pin-button`);
                     oldPinButton?.classList.remove('active');
                      if(oldPinButton) oldPinButton.title = '× ×¢×œ ×”×•×“×¢×”';
                 }
            }
        }
        // --- Update Pinned Message Bar ---
        function updatePinnedMessageDisplay() {
            if (pinnedMessageId) {
                const pinnedMsgElement = chatOutput.querySelector(`.message[data-message-id="${pinnedMessageId}"]`);
                if (pinnedMsgElement) {
                    const content = pinnedMsgElement.querySelector('.message-content')?.textContent.substring(0, 100) + '...';
                    pinnedMessageArea.querySelector('.pinned-text').textContent = content;
                    pinnedMessageArea.classList.add('visible');
                    chatOutput.classList.add('has-pinned'); // Adjust height class
                     pinnedMessageArea.onclick = () => { // Click to scroll to message
                         pinnedMsgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         pinnedMsgElement.classList.add('highlighted');
                         setTimeout(() => pinnedMsgElement.classList.remove('highlighted'), 1500);
                     };
                } else { // Pinned message not found (cleared?), so unpin
                    pinnedMessageId = null;
                    localStorage.removeItem('pinnedMessageId');
                    pinnedMessageArea.classList.remove('visible');
                     chatOutput.classList.remove('has-pinned');
                     pinnedMessageArea.onclick = null;
                }
            } else {
                pinnedMessageArea.classList.remove('visible');
                 chatOutput.classList.remove('has-pinned');
                 pinnedMessageArea.onclick = null;
            }
        }


        // --- Handle Star Click ---
        function handleStarClick(event) {
            const button = event.currentTarget;
            const messageElement = button.closest('.message');
            if (!messageElement) return;
            const messageId = messageElement.dataset.messageId;
            // In a real app, save starred status to backend/localStorage array
            messageElement.classList.toggle('starred');
            const isStarred = messageElement.classList.contains('starred');
            button.title = isStarred ? '×‘×˜×œ ×¡×™××•×Ÿ ×›×•×›×‘' : '×¡××Ÿ ×‘×›×•×›×‘';
             button.querySelector('i').classList.toggle('far', !isStarred); // Toggle between far/fas
             button.querySelector('i').classList.toggle('fas', isStarred);
            console.log(`Message ${messageId} starred: ${isStarred}`);
        }

        // --- Placeholder Handlers for Edit/Delete ---
        function handleEditClick(event) {
             const messageElement = event.currentTarget.closest('.message');
             console.log("Edit clicked for:", messageElement?.dataset.messageId);
             alert("×¤×•× ×§×¦×™×™×ª ×¢×¨×™×›×” - ×œ×”×˜××¢×”");
             // Implementation: Replace message content with textarea, save on blur/enter
        }
        function handleDeleteClick(event) {
            const messageElement = event.currentTarget.closest('.message');
            const messageId = messageElement?.dataset.messageId;
            if (!messageId) return;
            showConfirmation(
                '××™×©×•×¨ ××—×™×§×ª ×”×•×“×¢×”',
                '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×•×“×¢×” ×–×•?',
                '××—×§',
                'danger',
                () => {
                    console.log("Delete confirmed for:", messageId);
                    messageElement?.closest('.message-wrapper')?.remove(); // Remove wrapper
                    // Update grouping for the message before the removed one
                    hideModal(confirmationModal);
                }
            );
        }

        // --- Handle Scroll ---
        function handleScroll() {
            // ... existing scroll logic ...
             // NEW: Show/hide scroll-to-top button
             scrollToTopButton.style.display = chatOutput.scrollTop > chatOutput.clientHeight ? 'flex' : 'none';

             // Update isAutoScrolling based on scroll position
              if (!isAutoScrolling && isScrolledToVeryBottom) {
                 isAutoScrolling = true; // Re-enable if scrolled back to bottom
                 userScrolledUp = false;
             }
         }


         // --- Update Grouping ---
         function updateGrouping(messageWrapper) { /* ... existing ... */ }

         // --- Input History Navigation ---
         function navigateInputHistory(direction) {
             if (inputHistory.length === 0) return;
             if (inputHistoryIndex === inputHistory.length && userInput.value.trim() !== '') {
                 // Store current input as draft before navigating
                 draftMessage = userInput.value;
             }

             if (direction === 'up') {
                 if (inputHistoryIndex > 0) {
                     inputHistoryIndex--;
                     userInput.value = inputHistory[inputHistoryIndex];
                 }
             } else { // down
                 if (inputHistoryIndex < inputHistory.length - 1) {
                     inputHistoryIndex++;
                     userInput.value = inputHistory[inputHistoryIndex];
                 } else if (inputHistoryIndex === inputHistory.length - 1) {
                     // Reached end of history, restore draft if exists
                     inputHistoryIndex = inputHistory.length;
                     userInput.value = draftMessage;
                 }
             }
             userInput.focus(); // Keep focus
             userInput.selectionStart = userInput.selectionEnd = userInput.value.length; // Move cursor to end
             adjustTextareaHeight();
         }

         // --- Apply Formatting to Input ---
         function applyInputFormatting(format) {
            const start = userInput.selectionStart;
            const end = userInput.selectionEnd;
            const selectedText = userInput.value.substring(start, end);
            let replacement = '';
            let cursorPos = start;

            switch(format) {
                case 'bold':
                    replacement = `**${selectedText}**`;
                    cursorPos = start + 2;
                    break;
                case 'italic':
                    replacement = `*${selectedText}*`;
                     cursorPos = start + 1;
                    break;
                case 'code':
                    replacement = `\`${selectedText}\``;
                     cursorPos = start + 1;
                    break;
                case 'ul':
                    // Add bullet point at the beginning of the line or selection
                    const lines = userInput.value.substring(0, start).split('\n');
                    const currentLineStart = start - lines[lines.length - 1].length;
                    const prefix = (start === 0 || userInput.value[start - 1] === '\n') ? '- ' : '\n- ';
                    replacement = prefix + selectedText;
                    cursorPos = start + prefix.length;
                    break;
                 case 'link':
                     const url = prompt("×”×›× ×¡ ××ª ×›×ª×•×‘×ª ×”-URL:", "https://");
                     if (url) {
                         replacement = `[${selectedText || '×˜×§×¡×˜ ×”×§×™×©×•×¨'}](${url})`;
                         cursorPos = start + 1; // Position inside []
                     } else {
                         return; // Cancelled prompt
                     }
                     break;
                default: return;
            }

            userInput.value = userInput.value.substring(0, start) + replacement + userInput.value.substring(end);
            userInput.focus();
            userInput.selectionStart = userInput.selectionEnd = (selectedText ? start + replacement.length : cursorPos);
            adjustTextareaHeight();
         }

        // --- Show Image Lightbox ---
        function showImageLightbox(src) {
            lightboxImage.src = src;
            showModal(imageLightbox);
        }


        // --- Chat Search Functionality ---
        const debouncedSearch = debounce(performSearch, 300);

        function openSearch() { searchArea.classList.add('active'); searchInput.focus(); }
        function closeSearch() {
            searchArea.classList.remove('active');
            currentSearchTerm = '';
            searchResults = [];
            currentSearchIndex = -1;
            clearSearchHighlights();
            searchResultsCount.textContent = '0/0';
        }

        function performSearch() {
            const term = searchInput.value.trim().toLowerCase();
             clearSearchHighlights(); // Clear previous highlights
            if (term === currentSearchTerm || term.length < 2) {
                if(term.length === 0) {
                    searchResults = [];
                    currentSearchIndex = -1;
                    searchResultsCount.textContent = '0/0';
                }
                // Update count if term hasn't changed but results might exist
                 searchResultsCount.textContent = `${currentSearchIndex + 1}/${searchResults.length}`;
                return;
            }

            currentSearchTerm = term;
            searchResults = [];
            currentSearchIndex = -1;

            if (term === '') {
                searchResultsCount.textContent = '0/0';
                return;
            }

            const messageContents = chatOutput.querySelectorAll('.message .message-content');
            messageContents.forEach((content, index) => {
                const text = content.textContent.toLowerCase();
                if (text.includes(term)) {
                    searchResults.push(content.closest('.message')); // Store the message element
                    // Highlight directly (simple version)
                    // More robust: highlight only the term using <mark> tags
                    highlightTermInNode(content, term);
                }
            });

             searchResultsCount.textContent = `0/${searchResults.length}`;
            if (searchResults.length > 0) {
                navigateToSearchResult(0); // Go to first result
            }
        }

        function highlightTermInNode(node, term) {
            const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT);
            let textNode;
            while(textNode = walker.nextNode()) {
                const text = textNode.nodeValue.toLowerCase();
                let startIndex = 0;
                let index = text.indexOf(term, startIndex);
                if (index !== -1) {
                     const originalText = textNode.nodeValue;
                     const parent = textNode.parentNode;
                     const mark = document.createElement('mark');
                     mark.className = 'search-highlight'; // Style this class
                     mark.textContent = originalText.substring(index, index + term.length);

                     const before = document.createTextNode(originalText.substring(0, index));
                     const after = document.createTextNode(originalText.substring(index + term.length));

                     parent.insertBefore(before, textNode);
                     parent.insertBefore(mark, textNode);
                     parent.insertBefore(after, textNode);
                     parent.removeChild(textNode);
                     // Restart search in the 'after' node potentially
                }
            }
        }

        function clearSearchHighlights() {
            chatOutput.querySelectorAll('mark.search-highlight').forEach(mark => {
                 const parent = mark.parentNode;
                 parent.replaceChild(document.createTextNode(mark.textContent), mark);
                 parent.normalize(); // Merge adjacent text nodes
            });
            chatOutput.querySelectorAll('.message.highlighted').forEach(msg => {
                msg.classList.remove('highlighted');
            });
        }


        function navigateToSearchResult(index) {
            if (index < 0 || index >= searchResults.length) return;

            // Remove highlight from previous
            if (currentSearchIndex !== -1 && searchResults[currentSearchIndex]) {
                searchResults[currentSearchIndex].classList.remove('highlighted');
            }

            currentSearchIndex = index;
            const targetMessage = searchResults[currentSearchIndex];
            if (targetMessage) {
                targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetMessage.classList.add('highlighted');
                 searchResultsCount.textContent = `${currentSearchIndex + 1}/${searchResults.length}`;
            }
        }


        // --- Settings Management ---
        function loadSettings() {
            // Load saved settings from localStorage
             systemPromptInput.value = localStorage.getItem('systemPrompt') || '';
             const savedTemp = localStorage.getItem('temperature');
             temperatureSlider.value = savedTemp !== null ? savedTemp : '0.7';
             temperatureValue.textContent = temperatureSlider.value;
             compactModeToggle.checked = body.classList.contains('compact-mode');
             roundedModeToggle.checked = body.classList.contains('rounded-mode');
             const savedAccent = localStorage.getItem('accentColor');
             if (savedAccent) {
                 accentColorPicker.value = savedAccent;
                 applyAccentColor(savedAccent);
             } else {
                 // Set picker to current computed default
                 const isDark = body.classList.contains('dark-mode');
                 accentColorPicker.value = getComputedStyle(body).getPropertyValue(isDark ? '--dm-accent-color' : '--lm-accent-color').trim();
             }

        }
        function saveSettings() {
            localStorage.setItem('systemPrompt', systemPromptInput.value);
            localStorage.setItem('temperature', temperatureSlider.value);
            localStorage.setItem('compactMode', compactModeToggle.checked);
            localStorage.setItem('roundedMode', roundedModeToggle.checked);
            localStorage.setItem('accentColor', accentColorPicker.value);

            body.classList.toggle('compact-mode', compactModeToggle.checked);
            body.classList.toggle('rounded-mode', roundedModeToggle.checked);
             applyAccentColor(accentColorPicker.value);

            hideModal(settingsModal);
            console.log("Settings saved.");
        }

        function applyAccentColor(color) {
             const isDark = body.classList.contains('dark-mode');
             const accentVar = isDark ? '--dm-accent-color' : '--lm-accent-color';
             document.documentElement.style.setProperty(accentVar, color);
              document.documentElement.style.setProperty('--accent-color', color); // Update generic one too
             updateSelectArrowColor(); // Arrow color might depend on accent in some themes
        }

         // --- Edit Chat Title ---
         function enableTitleEditing() {
             chatTitle.contentEditable = 'true';
             chatTitle.focus();
             const range = document.createRange();
             range.selectNodeContents(chatTitle);
             const sel = window.getSelection();
             sel.removeAllRanges();
             sel.addRange(range);
             chatTitle.addEventListener('blur', saveTitle);
             chatTitle.addEventListener('keydown', handleTitleKeydown);
         }
         function saveTitle() {
             chatTitle.contentEditable = 'false';
             const newTitle = chatTitle.textContent.trim() || "×¦'××˜ AI"; // Fallback
             chatTitle.textContent = newTitle;
             document.title = newTitle; // Update page title too
             localStorage.setItem('chatTitle', newTitle); // Save title
             chatTitle.removeEventListener('blur', saveTitle);
             chatTitle.removeEventListener('keydown', handleTitleKeydown);
         }
         function handleTitleKeydown(e) {
             if (e.key === 'Enter') {
                 e.preventDefault(); // Prevent newline
                 saveTitle();
             } else if (e.key === 'Escape') {
                 chatTitle.textContent = localStorage.getItem('chatTitle') || "×¦'××˜ AI ××•×œ×˜×™××˜×™×‘×™"; // Revert
                 saveTitle(); // Will remove listeners
             }
         }


        // --- Event Listeners Setup (Many NEW) ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
        userInput.addEventListener('input', debouncedAdjustHeight); // Use debounced handler
        // Input History & Draft Saving
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' && userInput.selectionStart === 0) { // Arrow up at start
                e.preventDefault();
                navigateInputHistory('up');
            } else if (e.key === 'ArrowDown' && userInput.selectionEnd === userInput.value.length) { // Arrow down at end
                 e.preventDefault();
                 navigateInputHistory('down');
            }
        });
         userInput.addEventListener('input', () => { // Save draft on input
             if (inputHistoryIndex === inputHistory.length) { // Only save if not browsing history
                 draftMessage = userInput.value;
                 localStorage.setItem('draftMessage', draftMessage);
             }
         });

        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', handleClearChatClick); // Use confirmation modal
        modelSelect.addEventListener('change', () => { /* ... existing model change feedback ... */ });

        // Scroll listeners
        let scrollTimeout;
        chatOutput.addEventListener('scroll', () => { chatOutput.dataset.userScrolling = 'true'; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(handleScroll, 50); });
        scrollToBottomButton.addEventListener('click', () => { /* ... existing ... */ });
        scrollToTopButton.addEventListener('click', () => scrollToTop('smooth')); // NEW

        // Reply listeners
        cancelReplyButton.addEventListener('click', hideReplyPreview);

        // Pinned message listeners
        unpinButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click on pinned area itself
            pinnedMessageId = null; localStorage.removeItem('pinnedMessageId'); updatePinnedMessageDisplay();
             // Deactivate the pin button on the message itself
             const pinButton = chatOutput.querySelector(`.message[data-message-id="${pinnedMessageId}"] .pin-button`);
             pinButton?.classList.remove('active');
             if(pinButton) pinButton.title = '× ×¢×œ ×”×•×“×¢×”';
        });

        // Toolbar listeners
        inputToolbar.addEventListener('click', (e) => {
            const button = e.target.closest('.toolbar-button');
            if (button && button.dataset.format) {
                applyInputFormatting(button.dataset.format);
            }
        });
        // Toggle Toolbar (example: focus input shows it)
        userInput.addEventListener('focus', () => inputToolbar.classList.add('visible'));
        // userInput.addEventListener('blur', () => { /* Hide toolbar conditionally */ }); // Might be annoying

        // Modal listeners
        settingsButton.addEventListener('click', () => { loadSettings(); showModal(settingsModal); });
        settingsCancelButton.addEventListener('click', () => hideModal(settingsModal));
        settingsSaveButton.addEventListener('click', saveSettings);
        temperatureSlider.addEventListener('input', () => temperatureValue.textContent = temperatureSlider.value);
        accentColorPicker.addEventListener('input', () => applyAccentColor(accentColorPicker.value)); // Live preview
        // Close modals on overlay click
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) hideModal(settingsModal); });
        confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) hideModal(confirmationModal); });
        imageLightbox.addEventListener('click', (e) => { if (e.target === imageLightbox || e.target.closest('.modal-close-button')) hideModal(imageLightbox); });
        // Confirmation buttons
        confirmationCancelButton.addEventListener('click', () => hideModal(confirmationModal));
        confirmationConfirmButton.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback(); // Execute the stored callback
            }
            // hideModal(confirmationModal); // Callback should hide if needed
        });

        // Search listeners
        searchOpenButton.addEventListener('click', openSearch);
        searchCloseButton.addEventListener('click', closeSearch);
        searchInput.addEventListener('input', debouncedSearch);
        searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') {e.preventDefault(); navigateToSearchResult(currentSearchIndex + 1); } else if (e.key === 'Escape') { closeSearch(); } });
        searchNextButton.addEventListener('click', () => navigateToSearchResult(currentSearchIndex + 1));
        searchPrevButton.addEventListener('click', () => navigateToSearchResult(currentSearchIndex - 1));

        // Edit Title listener
        chatTitle.addEventListener('click', enableTitleEditing);


        // --- Initialization ---
        // Load settings first to apply themes/modes before rendering messages
        body.classList.toggle('compact-mode', localStorage.getItem('compactMode') === 'true');
        body.classList.toggle('rounded-mode', localStorage.getItem('roundedMode') === 'true');
        const savedDarkMode = localStorage.getItem('darkMode'); if (savedDarkMode === 'enabled') toggleDarkMode('dark'); else toggleDarkMode('light');
        const savedAccent = localStorage.getItem('accentColor'); if(savedAccent) applyAccentColor(savedAccent);

        const savedTitle = localStorage.getItem('chatTitle');
        if (savedTitle) { chatTitle.textContent = savedTitle; document.title = savedTitle; }

        // Load Model & Dark Mode (after theme vars are set)
        const savedModel = localStorage.getItem('selectedModel'); /* ... load model ... */
        userInput.value = draftMessage; // Restore draft

        // Initial Render (Clear & Add Welcome)
        while (chatOutput.firstChild && chatOutput.firstChild !== scrollToBottomButton && chatOutput.firstChild !== scrollToTopButton) { chatOutput.removeChild(chatOutput.firstChild); }
        addMessageToChat(/* ... initial welcome message ... */);

        handleUrlParameter();
        adjustTextareaHeight();
        updatePinnedMessageDisplay(); // Show pinned message if exists

        // Restore scroll position
        // ... existing scroll restore logic ...

        enableInput();
        console.log("Ultimate AI Chat V4.0 Initialized.");

    });
</script>

<!-- PHP code remains the same -->
<?php /* ... existing PHP ... */ ?>

</body>
</html>
