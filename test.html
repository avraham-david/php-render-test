```html
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TITLE: Updated Title -->
    <title>AI Chat V9.3 - Quantum Core</title>
    <!-- FONTS: Using Google Fonts - Replace placeholders if needed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <style>
        /* --- CSS V9.3 - Quantum Core Enhancements --- */
        :root {
            /* CORE THEME */
            --font-main: 'Rubik', sans-serif; /* 1. Font Stack Update */
            --font-code: 'Fira Code', monospace, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; /* 2. Code Font */
            --border-radius-small: 4px; /* 3. Sharper Radius */
            --border-radius-medium: 10px; /* 4. Medium Radius */
            --border-radius-large: 24px; /* 5. Larger Radius */
            --border-radius-round: 50%;
            --bezier-elegant: cubic-bezier(0.65, 0, 0.35, 1);
            --bezier-overshoot: cubic-bezier(0.34, 1.56, 0.64, 1);
            --bezier-snappy: cubic-bezier(0.16, 1, 0.3, 1); /* 6. Snappy Bezier */
            --transition-fast: 0.2s var(--bezier-elegant);
            --transition-medium: 0.4s var(--bezier-elegant);
            --transition-slow: 0.6s var(--bezier-elegant);
            --transition-snap: 0.3s var(--bezier-snappy); /* 7. Snap Transition */
            --avatar-size: 38px; /* 8. Slightly Smaller Avatar */
            --hue-rotation-speed: 12s;
            --splash-hue-rotation-speed: 8s;
            --accent-1: #00e5ff; --accent-2: #8e44ad; --accent-3: #ff4757; --link-color: #00aaff;
            --glow-color: color-mix(in srgb, var(--accent-1) 40%, transparent);
            --button-glow-color-lm: color-mix(in srgb, var(--accent-2) 30%, transparent);
            --button-glow-color-dm: color-mix(in srgb, var(--accent-1) 40%, transparent); /* 9. Brighter DM Glow */
            --lm-whatsapp-bg-color: #f0f2f5; /* 10. Slightly Cooler LM BG */
            --dm-whatsapp-bg-color: #0f1317; /* 11. Slightly Darker DM BG */
            --lm-whatsapp-bg-image: none;
            --dm-whatsapp-bg-image: none;

            /* --- Light Mode --- */
            --lm-bg-default: #e9edf1; --lm-chat-bg: #ffffff; --lm-header-bg: linear-gradient(120deg, var(--accent-2) 0%, #a560e4 100%); --lm-header-text: #ffffff; --lm-header-icon-fill: #ffffff; --lm-header-status-text: rgba(255, 255, 255, 0.9); --lm-user-msg-bg: #e0f7ca; --lm-ai-msg-bg: #ffffff; --lm-msg-text: #1c1e21; --lm-input-area-bg: #f5f7fa; --lm-input-bg: #ffffff; --lm-input-text: #1c1e21; --lm-input-border: #d1d7e0; --lm-input-border-focus: var(--accent-2); --lm-input-shadow-focus: 0 0 0 3.5px color-mix(in srgb, var(--accent-2) 15%, transparent); --lm-input-glow: 0 0 12px color-mix(in srgb, var(--accent-2) 18%, transparent); --lm-button-bg: #008069; --lm-button-hover-bg: #00a884; --lm-button-active-bg: #005c4b; --lm-button-icon-fill: #ffffff; --lm-button-secondary-text: color-mix(in srgb, var(--accent-2) 95%, black); --lm-button-secondary-border: color-mix(in srgb, var(--accent-2) 40%, transparent); --lm-button-secondary-hover-bg: color-mix(in srgb, var(--accent-2) 10%, transparent); --lm-timestamp-color: rgba(0, 0, 0, 0.65); --lm-model-indicator-color: rgba(0, 0, 0, 0.6); --lm-border-color: #dfe3e8; --lm-icon-button-hover-bg: rgba(0, 0, 0, 0.08); --lm-msg-action-icon-fill: rgba(0, 0, 0, 0.65); --lm-msg-action-icon-hover-fill: #000000; --lm-msg-action-icon-hover-bg: rgba(0, 0, 0, 0.1); --lm-scrollbar-thumb: #b8c0c9; --lm-scrollbar-track: transparent; --lm-code-bg: #f8f9fa; --lm-code-text: #212529; --lm-code-border: #e9ecef; --lm-code-copy-btn-bg: rgba(0, 0, 0, 0.06); --lm-code-copy-btn-hover-bg: rgba(0, 0, 0, 0.12); --lm-code-copy-btn-copied-bg: var(--accent-1); --lm-code-copy-btn-copied-text: #111; --lm-loading-dot-color: var(--lm-timestamp-color); --lm-shadow-light: 0 1px 2px rgba(0, 0, 0, 0.06); --lm-shadow-medium: 0 3px 6px rgba(0, 0, 0, 0.09); --lm-shadow-high: 0 5px 15px rgba(0, 0, 0, 0.12); --lm-scroll-btn-bg: rgba(255, 255, 255, 0.94); --lm-scroll-btn-icon: #343a40; --lm-scroll-btn-hover-bg: #ffffff; --lm-popover-bg: rgba(255, 255, 255, 0.98); --lm-popover-backdrop-filter: blur(10px) saturate(120%); --lm-popover-shadow: var(--lm-shadow-high); --lm-popover-border: rgba(0, 0, 0, 0.07); --lm-menu-item-hover-bg: #f0f3f6; --lm-counter-bg: var(--accent-3); --lm-counter-text: #ffffff; --lm-avatar-text: #ffffff; --lm-dialog-bg: var(--lm-popover-bg); --lm-dialog-text: var(--lm-msg-text); --lm-dialog-shadow: var(--lm-popover-shadow); --lm-dialog-overlay-bg: rgba(0, 0, 0, 0.45); --lm-dialog-button-bg: var(--lm-button-bg); --lm-dialog-button-text: var(--lm-button-icon-fill); --lm-dialog-cancel-button-bg: #e9edf1; --lm-dialog-cancel-button-text: var(--lm-msg-text); --lm-kbd-bg: #e9edf1; --lm-kbd-border: #ced4da; --lm-kbd-text: #495057; --lm-message-hover-bg: rgba(0, 0, 0, 0.025); --lm-group-separator-color: rgba(0, 0, 0, 0.08); --stop-button-fill: var(--lm-msg-action-icon-fill); --stop-button-hover-fill: var(--lm-msg-action-icon-hover-fill); --lm-thinking-text-bg: linear-gradient(90deg, var(--accent-2), var(--accent-1), var(--accent-3), var(--accent-2)); --lm-thinking-border-color: color-mix(in srgb, var(--accent-2) 45%, transparent); --lm-external-link-icon-color: rgba(0, 0, 0, 0.55); --lm-table-border: #e9ecef; --lm-table-header-bg: #f8f9fa; --lm-thinking-bubble-bg-pulse: rgba(142, 68, 173, 0.06); --lm-msg-border-radius: 18px 18px 18px 5px; --lm-user-msg-border-radius: 18px 18px 5px 18px; /* 12. New Bubble Shape LM */

            /* --- Dark Mode --- */
            --dm-bg-default: #0a0d10; --dm-chat-bg: #101418; --dm-header-bg: linear-gradient(120deg, #1a222a 0%, #25313b 100%); --dm-header-text: #e8edf3; --dm-header-icon-fill: #b0bac3; --dm-header-status-text: rgba(232, 237, 243, 0.8); --dm-user-msg-bg: #005c4b; --dm-ai-msg-bg: #202c33; --dm-msg-text: #d9e1e8; --dm-input-area-bg: #0a0d10; --dm-input-bg: #1a222a; --dm-input-text: #d9e1e8; --dm-input-border: #303a43; --dm-input-border-focus: var(--accent-1); --dm-input-shadow-focus: 0 0 0 4px color-mix(in srgb, var(--accent-1) 18%, transparent); --dm-input-glow: 0 0 14px color-mix(in srgb, var(--accent-1) 20%, transparent); --dm-button-bg: #00a884; --dm-button-hover-bg: #008069; --dm-button-active-bg: #00b38f; --dm-button-icon-fill: #111b21; --dm-button-secondary-text: var(--accent-1); --dm-button-secondary-border: color-mix(in srgb, var(--accent-1) 40%, transparent); --dm-button-secondary-hover-bg: color-mix(in srgb, var(--accent-1) 12%, transparent); --dm-timestamp-color: rgba(255, 255, 255, 0.6); --dm-model-indicator-color: rgba(255, 255, 255, 0.55); --dm-border-color: #303a43; --dm-icon-button-hover-bg: rgba(255, 255, 255, 0.09); --dm-msg-action-icon-fill: rgba(255, 255, 255, 0.7); --dm-msg-action-icon-hover-fill: #ffffff; --dm-msg-action-icon-hover-bg: rgba(255, 255, 255, 0.12); --dm-scrollbar-thumb: #3a4752; --dm-scrollbar-track: transparent; --dm-code-bg: #1a222a; --dm-code-text: #bac4cf; --dm-code-border: #303a43; --dm-code-copy-btn-bg: rgba(255, 255, 255, 0.09); --dm-code-copy-btn-hover-bg: rgba(255, 255, 255, 0.14); --dm-code-copy-btn-copied-bg: var(--accent-1); --dm-code-copy-btn-copied-text: #111; --dm-loading-dot-color: var(--dm-timestamp-color); --dm-shadow-light: 0 1px 2px rgba(0, 0, 0, 0.35); --dm-shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.45); --dm-shadow-high: 0 8px 24px rgba(0, 0, 0, 0.5); --dm-scroll-btn-bg: rgba(26, 34, 42, 0.95); --dm-scroll-btn-icon: #b0bac3; --dm-scroll-btn-hover-bg: #202c33; --dm-popover-bg: rgba(26, 34, 42, 0.97); --dm-popover-backdrop-filter: blur(12px) saturate(130%); --dm-popover-shadow: var(--dm-shadow-high); --dm-popover-border: rgba(255, 255, 255, 0.08); --dm-menu-item-hover-bg: #2a343c; --dm-counter-bg: var(--accent-3); --dm-counter-text: #ffffff; --dm-avatar-text: #e8edf3; --dm-dialog-bg: var(--dm-popover-bg); --dm-dialog-text: var(--dm-msg-text); --dm-dialog-shadow: var(--dm-popover-shadow); --dm-dialog-overlay-bg: rgba(0, 0, 0, 0.65); --dm-dialog-button-bg: var(--dm-button-bg); --dm-dialog-button-text: var(--dm-button-icon-fill); --dm-dialog-cancel-button-bg: #3a4752; --dm-dialog-cancel-button-text: var(--dm-msg-text); --dm-kbd-bg: #2a343c; --dm-kbd-border: #404d59; --dm-kbd-text: #bac4cf; --dm-message-hover-bg: rgba(255, 255, 255, 0.035); --dm-group-separator-color: rgba(255, 255, 255, 0.09); --stop-button-fill: var(--dm-msg-action-icon-fill); --stop-button-hover-fill: var(--dm-msg-action-icon-hover-fill); --dm-thinking-text-bg: linear-gradient(90deg, var(--accent-1), var(--accent-2), #45a3e5, var(--accent-1)); --dm-thinking-border-color: color-mix(in srgb, var(--accent-1) 45%, transparent); --dm-external-link-icon-color: rgba(255, 255, 255, 0.6); --dm-table-border: #404d59; --dm-table-header-bg: #2a343c; --dm-thinking-bubble-bg-pulse: rgba(0, 229, 255, 0.08); /* 13. Brighter Thinking Pulse DM */ --dm-msg-border-radius: 18px 18px 18px 5px; --dm-user-msg-border-radius: 18px 18px 5px 18px; /* 14. New Bubble Shape DM */

            /* Apply Defaults */
             --bg-default: var(--lm-bg-default); --chat-bg: var(--lm-chat-bg); --header-bg: var(--lm-header-bg); --header-text: var(--lm-header-text); --header-icon-fill: var(--lm-header-icon-fill); --header-status-text: var(--lm-header-status-text); --user-msg-bg: var(--lm-user-msg-bg); --ai-msg-bg: var(--lm-ai-msg-bg); --msg-text: var(--lm-msg-text); --input-area-bg: var(--lm-input-area-bg); --input-bg: var(--lm-input-bg); --input-text: var(--lm-input-text); --input-border: var(--lm-input-border); --input-border-focus: var(--lm-input-border-focus); --input-shadow-focus: var(--lm-input-shadow-focus); --input-glow: var(--lm-input-glow); --button-bg: var(--lm-button-bg); --button-hover-bg: var(--lm-button-hover-bg); --button-active-bg: var(--lm-button-active-bg); --button-icon-fill: var(--lm-button-icon-fill); --button-secondary-text: var(--lm-button-secondary-text); --button-secondary-border: var(--lm-button-secondary-border); --button-secondary-hover-bg: var(--lm-button-secondary-hover-bg); --timestamp-color: var(--lm-timestamp-color); --model-indicator-color: var(--lm-model-indicator-color); --border-color: var(--lm-border-color); --icon-button-hover-bg: var(--lm-icon-button-hover-bg); --msg-action-icon-fill: var(--lm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--lm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--lm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--lm-scrollbar-thumb); --scrollbar-track: transparent; --code-bg: var(--lm-code-bg); --code-text: var(--lm-code-text); --code-border: var(--lm-code-border); --code-copy-btn-bg: var(--lm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--lm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--lm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--lm-code-copy-btn-copied-text); --loading-dot-color: var(--lm-loading-dot-color); --shadow-light: var(--lm-shadow-light); --shadow-medium: var(--lm-shadow-medium); --shadow-high: var(--lm-shadow-high); --scroll-btn-bg: var(--lm-scroll-btn-bg); --scroll-btn-icon: var(--lm-scroll-btn-icon); --scroll-btn-hover-bg: var(--lm-scroll-btn-hover-bg); --popover-bg: var(--lm-popover-bg); --popover-backdrop-filter: var(--lm-popover-backdrop-filter); --popover-shadow: var(--lm-popover-shadow); --popover-border: var(--lm-popover-border); --menu-item-hover-bg: var(--lm-menu-item-hover-bg); --counter-bg: var(--lm-counter-bg); --counter-text: var(--lm-counter-text); --avatar-text: var(--lm-avatar-text); --dialog-bg: var(--lm-dialog-bg); --dialog-text: var(--lm-dialog-text); --dialog-shadow: var(--lm-dialog-shadow); --dialog-overlay-bg: var(--lm-dialog-overlay-bg); --dialog-button-bg: var(--lm-dialog-button-bg); --dialog-button-text: var(--lm-dialog-button-text); --dialog-cancel-button-bg: var(--lm-dialog-cancel-button-bg); --dialog-cancel-button-text: var(--lm-dialog-cancel-button-text); --kbd-bg: var(--lm-kbd-bg); --kbd-border: var(--lm-kbd-border); --kbd-text: var(--lm-kbd-text); --message-hover-bg: var(--lm-message-hover-bg); --group-separator-color: var(--lm-group-separator-color); --stop-button-fill: var(--lm-msg-action-icon-fill); --stop-button-hover-fill: var(--lm-msg-action-icon-hover-fill);
             --whatsapp-bg-color: var(--lm-whatsapp-bg-color); --whatsapp-bg-image: var(--lm-whatsapp-bg-image);
             --thinking-text-bg: var(--lm-thinking-text-bg); --thinking-border-color: var(--lm-thinking-border-color);
             --external-link-icon-color: var(--lm-external-link-icon-color); --table-border: var(--lm-table-border); --table-header-bg: var(--lm-table-header-bg);
             --thinking-bubble-bg-pulse: var(--lm-thinking-bubble-bg-pulse);
             --msg-border-radius: var(--lm-msg-border-radius); --user-msg-border-radius: var(--lm-user-msg-border-radius);
        }
        body.dark-mode {
             --bg-default: var(--dm-bg-default); --chat-bg: var(--dm-chat-bg); --header-bg: var(--dm-header-bg); --header-text: var(--dm-header-text); --header-icon-fill: var(--dm-header-icon-fill); --header-status-text: var(--dm-header-status-text); --user-msg-bg: var(--dm-user-msg-bg); --ai-msg-bg: var(--dm-ai-msg-bg); --msg-text: var(--dm-msg-text); --input-area-bg: var(--dm-input-area-bg); --input-bg: var(--dm-input-bg); --input-text: var(--dm-input-text); --input-border: var(--dm-input-border); --input-border-focus: var(--dm-input-border-focus); --input-shadow-focus: var(--dm-input-shadow-focus); --input-glow: var(--dm-input-glow); --button-bg: var(--dm-button-bg); --button-hover-bg: var(--dm-button-hover-bg); --button-active-bg: var(--dm-button-active-bg); --button-icon-fill: var(--dm-button-icon-fill); --button-secondary-text: var(--dm-button-secondary-text); --button-secondary-border: var(--dm-button-secondary-border); --button-secondary-hover-bg: var(--dm-button-secondary-hover-bg); --timestamp-color: var(--dm-timestamp-color); --model-indicator-color: var(--dm-model-indicator-color); --border-color: var(--dm-border-color); --icon-button-hover-bg: var(--dm-icon-button-hover-bg); --msg-action-icon-fill: var(--dm-msg-action-icon-fill); --msg-action-icon-hover-fill: var(--dm-msg-action-icon-hover-fill); --msg-action-icon-hover-bg: var(--dm-msg-action-icon-hover-bg); --scrollbar-thumb: var(--dm-scrollbar-thumb); --scrollbar-track: transparent; --code-bg: var(--dm-code-bg); --code-text: var(--dm-code-text); --code-border: var(--dm-code-border); --code-copy-btn-bg: var(--dm-code-copy-btn-bg); --code-copy-btn-hover-bg: var(--dm-code-copy-btn-hover-bg); --code-copy-btn-copied-bg: var(--dm-code-copy-btn-copied-bg); --code-copy-btn-copied-text: var(--dm-code-copy-btn-copied-text); --loading-dot-color: var(--dm-loading-dot-color); --shadow-light: var(--dm-shadow-light); --shadow-medium: var(--dm-shadow-medium); --shadow-high: var(--dm-shadow-high); --scroll-btn-bg: var(--dm-scroll-btn-bg); --scroll-btn-icon: var(--dm-scroll-btn-icon); --scroll-btn-hover-bg: var(--dm-scroll-btn-hover-bg); --popover-bg: var(--dm-popover-bg); --popover-backdrop-filter: var(--dm-popover-backdrop-filter); --popover-shadow: var(--dm-popover-shadow); --popover-border: var(--dm-popover-border); --menu-item-hover-bg: var(--dm-menu-item-hover-bg); --counter-bg: var(--dm-counter-bg); --counter-text: var(--dm-counter-text); --avatar-text: var(--dm-avatar-text); --dialog-bg: var(--dm-dialog-bg); --dialog-text: var(--dm-msg-text); --dialog-shadow: var(--dm-popover-shadow); --dialog-overlay-bg: var(--dm-dialog-overlay-bg); --dialog-button-bg: var(--dm-dialog-button-bg); --dialog-button-text: var(--dm-button-icon-fill); --dialog-cancel-button-bg: var(--dm-dialog-cancel-button-bg); --dialog-cancel-button-text: var(--dm-msg-text); --kbd-bg: var(--dm-kbd-bg); --kbd-border: var(--dm-kbd-border); --kbd-text: var(--dm-kbd-text); --message-hover-bg: var(--dm-message-hover-bg); --group-separator-color: var(--dm-group-separator-color);
             --stop-button-fill: var(--dm-msg-action-icon-fill); --stop-button-hover-fill: var(--dm-msg-action-icon-hover-fill);
             --whatsapp-bg-color: var(--dm-whatsapp-bg-color); --whatsapp-bg-image: var(--dm-whatsapp-bg-image);
              --thinking-text-bg: var(--dm-thinking-text-bg); --thinking-border-color: var(--dm-thinking-border-color);
             --external-link-icon-color: var(--dm-external-link-icon-color); --table-border: var(--dm-table-border); --table-header-bg: var(--dm-table-header-bg);
             --thinking-bubble-bg-pulse: var(--dm-thinking-bubble-bg-pulse);
             --msg-border-radius: var(--dm-msg-border-radius); --user-msg-border-radius: var(--dm-user-msg-border-radius);
        }
        /* --- BASE & UTILITIES --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: var(--font-main); background-color: var(--bg-default); color: var(--msg-text); display: flex; flex-direction: column; transition: background-color var(--transition-medium), color var(--transition-medium); /* 15. Theme Change Transition */ font-size: 15px; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        * { box-sizing: border-box; }
        /* 16. Refined Focus Outline */
        *:focus-visible { outline: 2px solid var(--accent-1); outline-offset: 2px; border-radius: var(--border-radius-small); box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent-1) 25%, transparent); }
        #user-input:focus-visible { outline: none; } /* Handled by input style */
        a { color: var(--link-color); text-decoration: none; font-weight: 500; /* 17. Bolder Links */ transition: color var(--transition-fast), text-decoration var(--transition-fast); }
        a:hover { color: color-mix(in srgb, var(--link-color) 75%, var(--msg-text)); text-decoration: underline; text-decoration-thickness: 1.5px; /* 18. Thicker Underline */ }
        /* 19. Improved Selection Color */
        ::selection { background-color: color-mix(in srgb, var(--accent-1) 45%, transparent); color: var(--msg-text); }
        body.dark-mode ::selection { background-color: color-mix(in srgb, var(--accent-1) 40%, transparent); color: var(--dm-msg-text); }

        /* --- SPLASH SCREEN - Quantum Core Style --- */ /* 20. Splash Screen Overhaul */
        #splash-screen {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(ellipse at bottom, #0f0c29 0%, #1c173a 50%, #24243e 100%);
            background-size: 200% 200%;
            animation: splash-gradient-pulse 12s ease infinite, splash-hue-rotate var(--splash-hue-rotation-speed) linear infinite alternate;
            opacity: 1; transition: opacity 0.6s ease-out, visibility 0s 0.6s; /* 21. Slower Fade Out */
            pointer-events: auto;
            overflow: hidden;
        }
        #splash-screen::before { /* Subtle Grid Overlay */
            content: ''; position: absolute; inset: 0;
            background-image:
                linear-gradient(rgba(0, 229, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.5;
            animation: grid-pan 20s linear infinite;
            pointer-events: none;
        }
         #splash-screen::after { /* Noise/Scanlines Overlay */
            content: ''; position: absolute; inset: 0;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
            opacity: 0.02;
            animation: noise-animation 0.3s steps(2) infinite;
            pointer-events: none;
         }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        @keyframes splash-gradient-pulse { 0%, 100% { background-position: 50% 100%; } 50% { background-position: 50% 0%; } }
        @keyframes splash-hue-rotate { from { filter: hue-rotate(-8deg) brightness(1); } to { filter: hue-rotate(8deg) brightness(1.15); } }
        @keyframes grid-pan { from { background-position: 0 0; } to { background-position: -80px -80px; } }
        @keyframes noise-animation { 0% { transform: translate(0, 0); } 25% { transform: translate(-1px, 1px); } 50% { transform: translate(1px, -1px); } 75% { transform: translate(-0.5px, 0.5px); } 100% { transform: translate(0, 0); } }

        #splash-logo { /* 22. New Logo Animation */
            width: 100px; height: 100px; position: relative; margin-bottom: 40px;
            perspective: 800px; /* Add perspective for 3D effect */
        }
        .logo-element { /* Base for logo parts */
            position: absolute; width: 100%; height: 100%;
            border: 2px solid var(--accent-1);
            box-shadow: 0 0 10px 2px color-mix(in srgb, var(--accent-1) 50%, transparent),
                        inset 0 0 6px 0px color-mix(in srgb, var(--accent-1) 30%, transparent);
            border-radius: var(--border-radius-small);
            background: transparent;
            transform-style: preserve-3d;
        }
        .logo-element.cube-face { /* Rotating Cube Faces */
            animation: cube-rotate 8s linear infinite;
        }
        .logo-element.face-1 { transform: rotateY(0deg) translateZ(50px); }
        .logo-element.face-2 { transform: rotateY(90deg) translateZ(50px); border-color: var(--accent-2); box-shadow: 0 0 10px 2px color-mix(in srgb, var(--accent-2) 50%, transparent), inset 0 0 6px 0px color-mix(in srgb, var(--accent-2) 30%, transparent); }
        .logo-element.face-3 { transform: rotateY(180deg) translateZ(50px); }
        .logo-element.face-4 { transform: rotateY(-90deg) translateZ(50px); border-color: var(--accent-3); box-shadow: 0 0 10px 2px color-mix(in srgb, var(--accent-3) 50%, transparent), inset 0 0 6px 0px color-mix(in srgb, var(--accent-3) 30%, transparent); }

        .logo-element.core-glow { /* Pulsing Core */
             width: 30%; height: 30%; top: 35%; left: 35%;
             border: none;
             background-color: color-mix(in srgb, var(--accent-1) 80%, #fff);
             border-radius: 50%;
             filter: blur(8px);
             animation: core-pulse 2s infinite alternate ease-in-out;
             box-shadow: 0 0 20px 5px var(--accent-1), 0 0 35px 15px color-mix(in srgb, var(--accent-1) 50%, transparent);
        }

        @keyframes cube-rotate { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }
        @keyframes core-pulse { from { transform: scale(0.8); opacity: 0.7; } to { transform: scale(1.1); opacity: 1; } }

        #splash-text { /* 23. Enhanced Loading Text */
            font-family: var(--font-code); font-size: 14px; color: var(--accent-1);
            font-weight: 400; text-shadow: 0 0 6px color-mix(in srgb, var(--accent-1) 50%, transparent);
            white-space: nowrap; letter-spacing: .12em;
            padding: 5px 0; position: relative;
            overflow: hidden; /* Required for scanline */
        }
        #splash-text::after { /* Scanline effect */
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-1), transparent);
            animation: scanline 2.5s linear infinite;
            opacity: 0.8;
        }
        #splash-text span { /* For dynamic text */
            display: inline-block;
            animation: text-flicker 3s linear infinite alternate;
        }
        @keyframes scanline { 0% { left: -100%; } 50% { left: 100%; } 100% { left: 100%; } }
        @keyframes text-flicker { 0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; text-shadow: 0 0 6px color-mix(in srgb, var(--accent-1) 50%, transparent); } 20%, 24%, 55% { opacity: 0.6; text-shadow: none; } }
        /* --- END SPLASH SCREEN --- */

        /* --- MAIN LAYOUT --- */
        #chat-container { width: 100%; max-width: 950px; height: calc(100dvh - 16px); margin: 8px auto; background-color: transparent; display: flex; flex-direction: column; overflow: hidden; position: relative; transition: box-shadow var(--transition-medium), transform var(--transition-medium) var(--bezier-elegant), opacity 0.6s ease-in; box-shadow: var(--shadow-high); border-radius: var(--border-radius-medium); border: 1px solid var(--border-color); opacity: 0; transform: scale(0.98); /* 24. Subtle Scale-in */ }
        body.dark-mode #chat-container { border-color: var(--dm-border-color); }
        #chat-container.loaded { opacity: 1; transform: scale(1); }

        /* --- HEADER --- */
        #chat-header { background: var(--header-bg); color: var(--header-text); padding: 10px 18px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); z-index: 10; transition: background var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-medium); gap: 15px; flex-shrink: 0; border-top-left-radius: var(--border-radius-medium); border-top-right-radius: var(--border-radius-medium); animation: header-gradient-animation var(--hue-rotation-speed) linear infinite alternate; border-bottom: 1px solid transparent; /* 25. Animated Header Gradient */ }
        body.dark-mode #chat-header { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35); border-bottom-color: rgba(255,255,255,0.06); }
        @keyframes header-gradient-animation { from { filter: hue-rotate(-6deg) saturate(100%) brightness(1); } to { filter: hue-rotate(8deg) saturate(120%) brightness(1.05); } }
        .header-avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; color: var(--avatar-text); background: linear-gradient(140deg, var(--accent-1), color-mix(in srgb, var(--accent-1) 55%, black)); box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-left: 8px; border: 1px solid rgba(255, 255, 255, 0.2); /* 26. Avatar Border */ transition: transform var(--transition-snap), box-shadow var(--transition-medium); }
        body.dark-mode .header-avatar { background: linear-gradient(140deg, var(--accent-1), color-mix(in srgb, var(--accent-1) 65%, #000)); color: var(--dm-avatar-text); border-color: rgba(255, 255, 255, 0.1); }
        .header-avatar:hover { transform: scale(1.1) rotate(-3deg); box-shadow: var(--shadow-medium); } /* 27. Avatar Hover */
        #chat-title { margin: 0; font-size: 17px; font-weight: 600; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--header-text); text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* 28. Title Shadow */ }
        .header-controls-trigger { margin-left: auto; }
        .icon-button { background: none; border: none; padding: 8px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-snap); } /* 29. Snappier Icon Button Transition */
        .icon-button:hover { background-color: var(--icon-button-hover-bg); transform: scale(1.12) rotate(-8deg); } /* 30. More Icon Rotation */
        .icon-button:active { transform: scale(0.95); }
        .icon-button svg { width: 22px; height: 22px; fill: var(--header-icon-fill); transition: fill var(--transition-medium); }
        body.dark-mode .icon-button svg { fill: var(--dm-header-icon-fill); }

        /* --- SETTINGS POPOVER --- */
        #settings-popover { position: absolute; top: calc(100% + 8px); left: 18px; background-color: var(--popover-bg); backdrop-filter: var(--popover-backdrop-filter); border: 1px solid var(--popover-border); border-radius: var(--border-radius-medium); box-shadow: var(--popover-shadow); z-index: 100; padding: 12px 15px; /* 31. Popover Padding */ min-width: 320px; opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.97); transition: opacity 0.25s var(--bezier-elegant), transform 0.25s var(--bezier-elegant), visibility 0s 0.25s; /* 32. Faster Popover Animation */ pointer-events: none; max-height: calc(100dvh - 90px); overflow-y: auto; }
        #settings-popover.visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; transition-delay: 0s; }
        .popover-section { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); } /* 33. More Popover Section Space */
        body.dark-mode .popover-section { border-bottom-color: var(--dm-border-color); }
        .popover-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .popover-section label { display: block; font-size: 13.5px; /* 34. Slightly Larger Label */ font-weight: 600; margin-bottom: 8px; color: var(--msg-text); opacity: 0.9; }
        .popover-section select, .popover-section input[type="checkbox"] { margin-top: 4px; }
        .popover-section select { width: 100%; padding: 9px 12px; border: 1px solid var(--input-border); border-radius: var(--border-radius-small); background-color: var(--input-bg); color: var(--input-text); font-size: 13.5px; cursor: pointer; transition: border-color var(--transition-fast), box-shadow var(--transition-fast); font-family: var(--font-main); }
        .popover-section select:focus { border-color: var(--input-border-focus); box-shadow: var(--input-shadow-focus); }
        .popover-checkbox { display: flex; align-items: center; cursor: pointer; padding: 8px 10px; border-radius: var(--border-radius-small); transition: background-color var(--transition-fast); margin: -8px -10px; } /* 35. Larger Checkbox Click Area */
        .popover-checkbox:hover { background-color: var(--menu-item-hover-bg); }
        .popover-checkbox input[type="checkbox"] { margin-left: 10px; margin-right: 0; width: 16px; height: 16px; accent-color: var(--accent-2); cursor: pointer; flex-shrink: 0; }
        .popover-checkbox label { margin-bottom: 0; font-weight: 400; font-size: 14px; flex-grow: 1; cursor: pointer; }
        #theme-icon-placeholder { color: var(--msg-action-icon-fill); margin-right: auto; display: flex; align-items: center; }
        .popover-section.shortcuts label { font-weight: 600; margin-bottom: 10px; font-size: 13.5px; }
        .popover-section.shortcuts ul { list-style: none; padding: 0; margin: 0; }
        .popover-section.shortcuts li { display: flex; justify-content: space-between; font-size: 13px; /* 36. Larger Shortcut Font */ color: var(--timestamp-color); margin-bottom: 6px; }
        /* 37. Refined KBD Style */
        .popover-section.shortcuts kbd { font-family: var(--font-code); font-size: 11px; padding: 3px 6px; background-color: var(--kbd-bg); border: 1px solid var(--kbd-border); border-radius: var(--border-radius-small); color: var(--kbd-text); box-shadow: inset 0 -1.5px 0 var(--kbd-border); margin: 0 2px; font-weight: 500; }
        .popover-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        body.dark-mode .popover-actions { border-top-color: var(--dm-border-color); }
        .popover-button { padding: 8px 16px; border-radius: var(--border-radius-medium); border: none; font-size: 13.5px; font-weight: 500; cursor: pointer; transition: background-color var(--transition-fast), transform var(--transition-snap), box-shadow var(--transition-medium); display: flex; align-items: center; gap: 7px; background-color: transparent; color: var(--button-secondary-text); border: 1px solid var(--button-secondary-border); } /* 38. Enhanced Popover Button */
        .popover-button:hover { transform: translateY(-2px) scale(1.03); box-shadow: var(--shadow-medium); background-color: var(--button-secondary-hover-bg); }
        .popover-button:active { transform: translateY(0px) scale(1); box-shadow: none; }
        .popover-button svg { width: 16px; height: 16px; fill: currentColor; transition: transform 0.2s ease-out; } /* 39. Icon Animation on Hover */
        .popover-button:hover svg { transform: scale(1.1) rotate(-5deg); }

        /* --- CHAT OUTPUT --- */
        #chat-output { flex-grow: 1; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; position: relative; padding: 0 8px; background-color: var(--whatsapp-bg-color); background-image: var(--whatsapp-bg-image); background-repeat: repeat; background-size: auto; transition: background-color var(--transition-medium); }
        #chat-output-inner { display: flex; flex-direction: column; padding: 15px 8px; width: 100%; margin-top: auto; }
        /* 40. Refined Scrollbar */
        #chat-output::-webkit-scrollbar { width: 9px; }
        #chat-output::-webkit-scrollbar-track { background: transparent; }
        #chat-output::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 5px; border: 2px solid transparent; background-clip: padding-box; transition: background-color var(--transition-fast); }
        #chat-output::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--scrollbar-thumb) 75%, black); }
        #chat-output { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) transparent; }

        /* --- SCROLL BUTTON --- */
        #scroll-to-bottom { position: absolute; bottom: 25px; left: 25px; background-color: var(--scroll-btn-bg); backdrop-filter: blur(12px) saturate(110%); border: 1px solid var(--border-color); border-radius: var(--border-radius-round); width: 42px; height: 42px; padding: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-medium); opacity: 0; visibility: hidden; transition: opacity var(--transition-fast), transform var(--transition-snap), visibility 0s var(--transition-fast), background-color var(--transition-fast), box-shadow var(--transition-medium); z-index: 20; transform: scale(0.8) translateY(10px); pointer-events: none; } /* 41. Improved Scroll Btn Animation */
        #scroll-to-bottom.visible { opacity: 1; visibility: visible; transform: scale(1) translateY(0); pointer-events: auto; transition-delay: 0s; }
        #scroll-to-bottom:hover { background-color: var(--scroll-btn-hover-bg); transform: scale(1.1) rotate(5deg); box-shadow: var(--shadow-high); }
        #scroll-to-bottom svg { width: 22px; height: 22px; fill: var(--scroll-btn-icon); transition: transform var(--transition-fast); }
        #scroll-to-bottom:hover svg { transform: translateY(3px); } /* 42. More SVG movement */

        /* --- MESSAGES --- */ /* 43. Message Grouping Styling */
        .message-wrapper { display: flex; max-width: 80%; margin-bottom: 2px; /* Reduced bottom margin */ align-items: flex-end; position: relative; opacity: 0; transform: translateY(15px) scale(0.98); transition: opacity 0.45s var(--bezier-elegant), transform 0.45s var(--bezier-elegant); margin-top: 6px; /* Added top margin for spacing */ }
        .message-wrapper.animate-in { opacity: 1; transform: translateY(0) scale(1); }
        .user-message-wrapper { align-self: flex-end; flex-direction: row-reverse; margin-left: auto; }
        .ai-message-wrapper { align-self: flex-start; flex-direction: row; margin-right: auto; }
        /* Grouping Logic */
        .message-wrapper.grouped + .message-wrapper.grouped { margin-top: 2px; } /* Tighter spacing for grouped */
        .message-wrapper.grouped .avatar { visibility: hidden; width: 0; margin: 0; } /* Hide avatar in group */
        .message-wrapper.grouped .message { margin-right: calc(var(--avatar-size) + 16px); /* Indent AI grouped */ }
        .user-message-wrapper.grouped .message { margin-left: calc(var(--avatar-size) + 16px); /* Indent User grouped */ }

        .avatar { width: var(--avatar-size); height: var(--avatar-size); border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; color: var(--lm-avatar-text); margin: 0 8px; box-shadow: var(--shadow-light); transition: transform var(--transition-snap), box-shadow var(--transition-medium), visibility 0s, width 0.2s ease, margin 0.2s ease; /* 44. Avatar Transition for Grouping */ }
        .ai-message-wrapper .avatar { background: linear-gradient(140deg, var(--accent-1), color-mix(in srgb, var(--accent-1) 60%, black)); }
        .user-message-wrapper .avatar { background: linear-gradient(140deg, var(--accent-2), color-mix(in srgb, var(--accent-2) 60%, #000)); }
        body.dark-mode .ai-message-wrapper .avatar { background: linear-gradient(140deg, var(--accent-1), color-mix(in srgb, var(--accent-1) 70%, #000)); color: var(--dm-avatar-text); }
        body.dark-mode .user-message-wrapper .avatar { background: linear-gradient(140deg, var(--accent-2), color-mix(in srgb, var(--accent-2) 70%, #000)); color: var(--dm-avatar-text); }
        .avatar:hover { transform: scale(1.15) rotate(6deg); box-shadow: var(--shadow-high); } /* 45. More Avatar Hover Effect */

        /* 46. New Message Bubble Shape */
        .message { padding: 9px 15px; /* Adjusted padding */ word-wrap: break-word; line-height: 1.6; color: var(--msg-text); box-shadow: var(--shadow-light); transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-medium), transform var(--transition-fast), border-radius var(--transition-medium); /* Slower radius transition */ position: relative; z-index: 1; min-width: 50px; font-size: 15px; border: 1px solid transparent; }
        .user-message { background-color: var(--user-msg-bg); border-radius: var(--user-msg-border-radius); }
        .ai-message { background-color: var(--ai-msg-bg); border-radius: var(--msg-border-radius); }
        body.dark-mode .ai-message { background-color: var(--dm-ai-msg-bg); }
        /* Grouping Shape Adjustments */
        .message-wrapper.grouped .user-message { border-radius: 18px 5px 5px 18px; } /* Grouped user */
        .message-wrapper.grouped .ai-message { border-radius: 5px 18px 18px 5px; } /* Grouped AI */
        .message-wrapper.group-start .user-message { border-radius: 18px 18px 5px 18px; } /* Start user */
        .message-wrapper.group-start .ai-message { border-radius: 18px 18px 18px 5px; } /* Start AI */
        .message-wrapper.group-end .user-message { border-radius: 18px 5px 18px 18px; } /* End user */
        .message-wrapper.group-end .ai-message { border-radius: 5px 18px 18px 18px; } /* End AI */

        .message-wrapper:hover .message { transform: translateY(-1.5px); box-shadow: var(--shadow-medium); } /* 47. Slightly More Lift on Hover */
        .message-tail { display: none; } /* 48. Removed Message Tail */

        /* Message Content & Footer */
        .message-content { padding-bottom: 0; min-height: 1.6em; }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        .message-footer { display: flex; align-items: center; justify-content: flex-end; font-size: 11.5px; /* 49. Slightly Larger Timestamp */ margin-top: 6px; gap: 7px; transition: color var(--transition-medium); flex-wrap: wrap; opacity: 0.8; /* 50. Slightly More Visible Footer */ color: var(--timestamp-color); padding: 0 2px; }
        .ai-message .message-footer { justify-content: flex-start; }
        .model-indicator { white-space: nowrap; font-weight: 500; color: var(--model-indicator-color); font-style: italic; } /* 51. Italic Model Indicator */
        .timestamp { white-space: nowrap; }

        /* Message Actions */ /* 52. Enhanced Message Actions */
        .message-actions { position: absolute; top: -15px; display: flex; gap: 5px; opacity: 0; visibility: hidden; transition: opacity var(--transition-fast), transform var(--transition-snap), visibility 0s var(--transition-fast); background-color: color-mix(in srgb, var(--chat-bg, #fff) 85%, transparent); backdrop-filter: blur(5px); border: 1px solid var(--border-color); border-radius: var(--border-radius-large); padding: 5px 8px; z-index: 2; pointer-events: none; transform: translateY(6px) scale(0.95); }
        .user-message-wrapper .message-actions { left: -12px; }
        .ai-message-wrapper .message-actions { right: -12px; }
        .message-wrapper:hover .message-actions { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; transition-delay: 0.05s; /* Slight delay */ }
        .msg-action-button { background: none; border: none; padding: 5px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-fast), transform var(--transition-snap), opacity var(--transition-fast); }
        .msg-action-button svg { width: 17px; height: 17px; /* Slightly larger */ fill: var(--msg-action-icon-fill); transition: fill var(--transition-fast); }
        .msg-action-button:hover { background-color: var(--msg-action-icon-hover-bg); transform: scale(1.2); /* More pop */ }
        .msg-action-button:hover svg { fill: var(--msg-action-icon-hover-fill); }
        .msg-action-button:active { transform: scale(1); }
        .msg-action-button.copied { animation: copied-feedback 0.6s var(--bezier-overshoot); } /* 53. Enhanced Copied Animation */
        .msg-action-button.copied svg { fill: var(--accent-1); }
        @keyframes copied-feedback { 0% { transform: scale(1); } 30% { transform: scale(1.3) rotate(-10deg); } 60% { transform: scale(0.9) rotate(5deg); } 100% { transform: scale(1); } }

        /* --- MARKDOWN & CODE BLOCKS --- */
        .message-content p { margin: 0.6em 0; } /* 54. More Paragraph Spacing */
        .message-content pre { padding: 1.1em; /* 55. More Code Padding */ border-radius: var(--border-radius-medium); overflow-x: auto; font-family: var(--font-code); font-size: 13.8px; /* 56. Larger Code Font */ margin: 12px 0; direction: ltr; text-align: left; white-space: pre; border: 1px solid var(--code-border); position: relative; box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* 57. Deeper Code Shadow */ line-height: 1.55; }
        body.dark-mode .message-content pre { box-shadow: inset 0 1px 4px rgba(0,0,0,0.25); }
        .message-content pre[class*="language-"], .message-content code[class*="language-"] { font-family: var(--font-code); }
        .message-content pre .copy-code-button { position: absolute; top: 10px; left: 10px; background-color: var(--code-copy-btn-bg); color: var(--msg-text); border: none; border-radius: var(--border-radius-small); padding: 5px 9px; font-size: 11.5px; font-family: var(--font-main); cursor: pointer; opacity: 0; transition: opacity var(--transition-fast), background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-snap); z-index: 2; backdrop-filter: blur(3px); } /* 58. Improved Copy Button */
        .message-content pre:hover .copy-code-button { opacity: 1; transform: scale(1); }
        .message-content pre .copy-code-button:hover { opacity: 1; background-color: var(--code-copy-btn-hover-bg); transform: scale(1.05); }
        .message-content pre .copy-code-button.copied { background-color: var(--code-copy-btn-copied-bg); color: var(--code-copy-btn-copied-text); opacity: 1; transform: scale(1.05); }
        .message-content code:not(pre > code) { background-color: color-mix(in srgb, var(--code-bg) 90%, transparent); color: var(--code-text); padding: 0.2em 0.5em; margin: 0 0.1em; font-size: 88%; /* 59. Larger Inline Code */ border-radius: var(--border-radius-small); font-family: var(--font-code); direction: ltr; text-align: left; border: 1px solid var(--code-border); vertical-align: baseline; /* Better alignment */ white-space: nowrap; }
        /* 60. Enhanced Markdown Elements */
        .message-content ul, .message-content ol { padding-right: 25px; margin: 0.8em 0; }
        .message-content li { margin-bottom: 0.4em; }
        .message-content li::marker { color: var(--accent-2); font-weight: bold; } /* Styled markers */
        body.dark-mode .message-content li::marker { color: var(--accent-1); }
        .message-content blockquote { border-right: 4px solid var(--border-color); padding-right: 12px; margin: 1em 0; margin-left: 5px; color: var(--timestamp-color); font-style: italic; }
        body.dark-mode .message-content blockquote { border-right-color: var(--dm-border-color); }
        .message-content hr { border: none; border-top: 2px dashed var(--border-color); margin: 1.5em 0; opacity: 0.7; } /* Dashed HR */
        body.dark-mode .message-content hr { border-top-color: var(--dm-border-color); }
        .message-content strong { font-weight: 600; color: color-mix(in srgb, var(--msg-text) 90%, black); } /* Styled Strong */
        .message-content em { font-style: italic; color: color-mix(in srgb, var(--msg-text) 85%, black); } /* Styled Em */

        /* 61. Improved Table Styles */
        .message-content table { border-collapse: collapse; margin: 1.2em 0; width: auto; max-width: 100%; /* Prevent overflow */ direction: ltr; text-align: left; border: 1px solid var(--table-border); box-shadow: var(--shadow-medium); border-radius: var(--border-radius-medium); /* Use medium radius */ overflow: hidden; }
        .message-content th, .message-content td { border: 1px solid var(--table-border); padding: 10px 14px; /* More padding */ }
        .message-content th { background-color: var(--table-header-bg); font-weight: 600; text-align: inherit; }
        .message-content tr:nth-child(even) { background-color: color-mix(in srgb, var(--chat-bg) 96%, transparent); }
        .message-content tr:hover { background-color: color-mix(in srgb, var(--accent-1) 5%, transparent) !important; } /* Row hover */
        body.dark-mode .message-content th, body.dark-mode .message-content td { border-color: var(--dm-table-border); }
        body.dark-mode .message-content th { background-color: var(--dm-table-header-bg); }
        body.dark-mode .message-content tr:nth-child(even) { background-color: color-mix(in srgb, var(--dm-chat-bg) 96%, transparent); }
        body.dark-mode .message-content tr:hover { background-color: color-mix(in srgb, var(--accent-1) 8%, transparent) !important; }

        /* --- INPUT AREA --- */
        #chat-input-area { display: flex; align-items: flex-end; padding: 12px 18px; border-top: 1px solid var(--border-color); background-color: var(--input-area-bg); flex-shrink: 0; transition: background-color var(--transition-medium), border-color var(--transition-medium), opacity var(--transition-fast); gap: 12px; border-bottom-left-radius: var(--border-radius-medium); border-bottom-right-radius: var(--border-radius-medium); } /* 62. Input Area Padding */
        body.dark-mode #chat-input-area { border-top-color: var(--dm-border-color); }
        .input-wrapper { flex-grow: 1; position: relative; display: flex; }
        #user-input { flex-grow: 1; padding: 12px 45px 12px 18px; /* 63. Input Padding */ border: 1px solid var(--input-border); border-radius: var(--border-radius-large); font-size: 15.5px; background-color: var(--input-bg); color: var(--input-text); outline: none; transition: background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-fast), height 0.2s var(--bezier-snappy), border-color var(--transition-fast); /* 64. Snappy Height Transition */ resize: none; overflow-y: hidden; min-height: 50px; /* 65. Taller Min Height */ max-height: 180px; /* 66. Taller Max Height */ line-height: 1.6; box-sizing: border-box; font-family: var(--font-main); }
        #user-input::placeholder { color: var(--timestamp-color); opacity: 0.75; transition: opacity var(--transition-fast); }
        #user-input:focus::placeholder { opacity: 0.5; }
        #user-input:focus { border-color: var(--input-border-focus); box-shadow: var(--input-shadow-focus), var(--input-glow); /* 67. Combined Focus Shadow/Glow */ }
        /* 68. Clear Button Enhancements */
        #clear-input-button { position: absolute; left: 12px; top: 50%; transform: translateY(-50%) scale(0.8); background: none; border: none; padding: 6px; cursor: pointer; border-radius: var(--border-radius-round); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity var(--transition-fast), background-color var(--transition-fast), transform var(--transition-snap); z-index: 2; pointer-events: none; }
        #clear-input-button.visible { opacity: 0.7; transform: translateY(-50%) scale(1); pointer-events: auto; }
        #clear-input-button svg { width: 18px; height: 18px; fill: var(--msg-action-icon-fill); }
        #clear-input-button:hover { opacity: 1; background-color: var(--icon-button-hover-bg); transform: translateY(-50%) scale(1.2) rotate(10deg); }
        #clear-input-button:active { transform: translateY(-50%) scale(1); }

        /* --- SEND BUTTON --- */ /* 69. Send Button Overhaul */
        #send-button { width: 50px; height: 50px; padding: 0; background: linear-gradient(135deg, var(--button-bg), color-mix(in srgb, var(--button-bg) 70%, black)); border: none; border-radius: var(--border-radius-round); cursor: pointer; font-size: 0; display: flex; justify-content: center; align-items: center; transition: background var(--transition-medium), transform 0.3s var(--bezier-overshoot), opacity var(--transition-fast), box-shadow var(--transition-medium); flex-shrink: 0; align-self: flex-end; box-shadow: var(--shadow-medium); }
        #send-button::before { content: ''; display: block; width: 24px; height: 24px; background-color: var(--button-icon-fill); mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M3.4 20.4l17.45-7.48a1 1 0 0 0 0-1.84L3.4 3.6a1 1 0 0 0-1.39 1.04l1.56 6.01-1.56 6.01a1 1 0 0 0 1.39 1.04zM5.12 14.01l.95-3.68h6.54l-.95 3.68-6.54-.01zm0-8l.95 3.68h6.54l-.95-3.68-6.54-.01z"/%3E%3C/svg%3E'); -webkit-mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M3.4 20.4l17.45-7.48a1 1 0 0 0 0-1.84L3.4 3.6a1 1 0 0 0-1.39 1.04l1.56 6.01-1.56 6.01a1 1 0 0 0 1.39 1.04zM5.12 14.01l.95-3.68h6.54l-.95 3.68-6.54-.01zm0-8l.95 3.68h6.54l-.95-3.68-6.54-.01z"/%3E%3C/svg%3E'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; transition: background-color var(--transition-medium), transform 0.2s var(--bezier-elegant); }
        #send-button.has-text { animation: pulse-send-button 1.6s infinite ease-in-out; } /* Faster pulse */
        @keyframes pulse-send-button { 0%, 100% { box-shadow: var(--shadow-medium), 0 0 10px transparent; transform: scale(1); } 50% { box-shadow: var(--shadow-high), 0 0 20px var(--button-glow-color-lm); transform: scale(1.05); } }
        body.dark-mode #send-button.has-text { animation-name: pulse-send-button-dark; }
        @keyframes pulse-send-button-dark { 0%, 100% { box-shadow: var(--dm-shadow-medium), 0 0 10px transparent; transform: scale(1); } 50% { box-shadow: var(--dm-shadow-high), 0 0 22px var(--button-glow-color-dm); transform: scale(1.05); } }
        #send-button:hover:not(:disabled) { transform: scale(1.12); box-shadow: var(--shadow-high), 0 0 22px var(--button-glow-color-lm); background: linear-gradient(135deg, var(--button-hover-bg), color-mix(in srgb, var(--button-hover-bg) 65%, black)); }
        body.dark-mode #send-button:hover:not(:disabled) { box-shadow: var(--dm-shadow-high), 0 0 25px var(--button-glow-color-dm); background: linear-gradient(135deg, var(--button-hover-bg), color-mix(in srgb, var(--button-hover-bg) 60%, black)); }
        #send-button:hover:not(:disabled)::before { transform: translateX(-1px) rotate(-8deg) scale(1.05); }
        #send-button:active:not(:disabled) { background: linear-gradient(135deg, var(--button-active-bg), color-mix(in srgb, var(--button-active-bg) 75%, black)); transform: scale(0.98); box-shadow: none; animation: none; }
        #send-button:disabled { opacity: 0.5; cursor: not-allowed; background: color-mix(in srgb, var(--button-bg) 50%, var(--input-area-bg)); transform: scale(1); box-shadow: none; animation: none; }
        #send-button.sending { transform: scale(1) !important; box-shadow: none !important; opacity: 0.7; cursor: default; animation: sending-pulse 1.2s infinite ease-in-out; }
        @keyframes sending-pulse { 0%, 100% { opacity: 0.65; } 50% { opacity: 0.9; } }

        /* --- LOADING INDICATOR --- */ /* 70. Enhanced Loading */
        .ai-message.typing-indicator { animation: pulse-thinking-bubble 1.6s infinite ease-in-out; }
        @keyframes pulse-thinking-bubble { 0%, 100% { background-color: var(--ai-msg-bg); } 50% { background-color: var(--thinking-bubble-bg-pulse); } }
        .typing-indicator .message-content { display: flex; align-items: center; gap: 12px; color: var(--timestamp-color); padding: 0; min-height: 38px; justify-content: space-between; position: relative; overflow: hidden; border: 1px dashed transparent; /* Dashed border */ border-radius: var(--border-radius-small); animation: pulse-thinking-border 1.6s ease-in-out infinite; }
        @keyframes pulse-thinking-border { 0%, 100% { border-color: transparent; box-shadow: none; } 50% { border-color: var(--thinking-border-color); box-shadow: 0 0 10px -1px var(--thinking-border-color); } }
        .ai-thinking-text { font-weight: 500; font-size: 14.5px; background: var(--thinking-text-bg); background-size: 350% 100%; /* Faster gradient */ -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: text-gradient-wave 2s linear infinite; white-space: nowrap; margin-right: 5px; }
        @keyframes text-gradient-wave { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        /* 71. Improved Stop Button */
        .stop-button { border: 1px solid var(--button-secondary-border); width: 30px; height: 30px; margin-left: 10px; flex-shrink: 0; background: none; transition: background-color var(--transition-fast), transform var(--transition-snap), border-color var(--transition-fast); border-radius: var(--border-radius-round); }
        .stop-button svg { width: 13px; height: 13px; fill: var(--stop-button-fill); }
        .stop-button:hover { background-color: var(--button-secondary-hover-bg); border-color: var(--accent-2); transform: scale(1.15) rotate(10deg); }
        body.dark-mode .stop-button:hover { border-color: var(--accent-1); }
        .stop-button:active { transform: scale(0.95) rotate(0); }

        /* --- DIALOG --- */ /* 72. Dialog Enhancements */
        #dialog-overlay { position: fixed; inset: 0; background-color: var(--dialog-overlay-bg); backdrop-filter: blur(10px) saturate(110%); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity var(--transition-medium), visibility 0s var(--transition-medium); padding: 20px; }
        #dialog-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        #dialog-box { background-color: var(--dialog-bg); padding: 25px 30px; border-radius: var(--border-radius-medium); box-shadow: var(--dialog-shadow); max-width: 450px; width: 100%; text-align: center; transform: scale(0.9) translateY(20px); transition: transform 0.3s var(--bezier-overshoot), opacity var(--transition-fast); border: 1px solid var(--popover-border); opacity: 0; }
        #dialog-overlay.visible #dialog-box { transform: scale(1) translateY(0); opacity: 1; }
        #dialog-title { font-size: 18px; font-weight: 600; margin: 0 0 10px; color: var(--dialog-text); }
        #dialog-message { font-size: 14.5px; margin: 0 0 22px; color: var(--dialog-text); opacity: 0.9; line-height: 1.65; text-align: right; }
        #dialog-message ul { padding-right: 22px; margin-top: 10px; }
        #dialog-message li { margin-bottom: 5px; }
        #dialog-buttons { display: flex; justify-content: center; gap: 15px; }
        .dialog-button { padding: 10px 22px; border-radius: var(--border-radius-medium); border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color var(--transition-fast), transform var(--transition-snap), box-shadow var(--transition-medium); }
        .dialog-button:hover { transform: translateY(-2px) scale(1.03); box-shadow: var(--shadow-medium); }
        .dialog-button:active { transform: translateY(0) scale(1); box-shadow: none; }
        .dialog-button.confirm { background-color: var(--dialog-button-bg); color: var(--dialog-button-text); }
        .dialog-button.confirm:hover { background-color: color-mix(in srgb, var(--dialog-button-bg) 80%, black); }
        .dialog-button.cancel { background-color: var(--dialog-cancel-button-bg); color: var(--dialog-cancel-button-text); }
        .dialog-button.cancel:hover { background-color: color-mix(in srgb, var(--dialog-cancel-button-bg) 80%, black); }

        /* --- PRISM LINE NUMBERS (If used) --- */
        /* 73. Better Line Number Styling */
        pre[class*="language-"].line-numbers { padding-left: 4em; }
        .line-numbers-rows > span::before { color: var(--timestamp-color) !important; opacity: 0.6; font-size: 0.9em; }

        /* --- MISC --- */
        /* 74. External Link Icon Enhancement */
        .message-content a[href^="http"] { position: relative; margin-left: 18px; /* More space */ }
        .message-content a[href^="http"]::after { content: ''; display: inline-block; width: 13px; height: 13px; background-color: var(--external-link-icon-color); mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/%3E%3C/svg%3E'); -webkit-mask-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"%3E%3Cpath d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/%3E%3C/svg%3E'); mask-size: contain; mask-repeat: no-repeat; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); opacity: 0.8; transition: opacity var(--transition-fast), transform var(--transition-fast); }
        .message-content a[href^="http"]:hover::after { opacity: 1; transform: translateY(-50%) scale(1.1) rotate(5deg); }

        /* 75. Add a subtle separator between message groups */
        .message-wrapper.group-end + .message-wrapper:not(.grouped) {
            margin-top: 15px; /* Increase space between different sender groups */
            position: relative;
        }
        .message-wrapper.group-end + .message-wrapper:not(.grouped)::before {
            content: '';
            position: absolute;
            top: -8px; /* Position above the next message */
            left: 5%; /* Indent slightly */
            right: 5%;
            height: 1px;
            background-color: var(--group-separator-color);
            opacity: 0.8;
        }

    </style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash-screen">
    <div id="splash-logo">
        <!-- Rotating Cube -->
        <div class="logo-element cube-face face-1"></div>
        <div class="logo-element cube-face face-2"></div>
        <div class="logo-element cube-face face-3"></div>
        <div class="logo-element cube-face face-4"></div>
        <!-- Pulsing Core -->
        <div class="logo-element core-glow"></div>
    </div>
    <div id="splash-text"><span id="splash-loading-text">  AI...</span></div>
</div>

<!-- Chat Container -->
<div id="chat-container" aria-live="polite">
    <!-- Header -->
    <div id="chat-header">
        <div class="header-avatar" aria-hidden="true">AI</div>
        <h1 id="chat-title">AI Chat</h1>
        <div class="header-controls-trigger">
            <button class="icon-button" id="settings-button" title=" (Alt+S)" aria-label="" aria-haspopup="true" aria-controls="settings-popover" aria-expanded="false">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
        <!-- Settings Popover -->
         <div id="settings-popover" role="menu" aria-labelledby="settings-button">
             <div class="popover-section">
                 <label for="model-select" title="      "> AI:</label>
                 <select id="model-select" role="menuitem">
                     <option value="main-ai.php">Gemini 1.5 Flash</option>
                     <option value="gemini25.php">Gemini 1.5 Pro</option>
                 </select>
             </div>
             <div class="popover-section">
                  <label for="style-select" title="      "> :</label>
                  <select id="style-select" role="menuitem">
                      <!-- Options populated by JS -->
                  </select>
             </div>
              <div class="popover-section"> <label>:</label> <div class="popover-checkbox" role="menuitemcheckbox" aria-checked="true" tabindex="0" id="send-on-enter-container" title=" ,  Enter   . Shift+Enter    ."> <input type="checkbox" id="send-on-enter-checkbox" tabindex="-1" checked> <label for="send-on-enter-checkbox">   Enter</label> </div> </div>
              <div class="popover-section"> <label>:</label> <div class="popover-checkbox" role="menuitemcheckbox" aria-checked="false" tabindex="0" id="dark-mode-container" title="     "> <input type="checkbox" id="dark-mode-checkbox" tabindex="-1"> <label for="dark-mode-checkbox" id="theme-toggle-text">  </label> <span id="theme-icon-placeholder" style="margin-right: auto; display: flex; align-items: center;"></span> </div> </div>

              <div class="popover-section shortcuts"> <label> :</label> <ul> <li><span>:</span> <span><kbd>Alt</kbd> + <kbd>S</kbd></span></li> <li><span> :</span> <span><kbd>Alt</kbd> + <kbd>I</kbd></span></li> <li><span>:</span> <span><kbd>Ctrl</kbd> + <kbd>Enter</kbd></span></li> <li><span> :</span> <span><kbd>Shift</kbd> + <kbd>Enter</kbd></span></li> <li><span> :</span> <span><kbd>Alt</kbd> + <kbd>X</kbd></span></li> <li><span> :</span> <span><kbd>End</kbd></span></li> <li><span> :</span> <span><kbd>Home</kbd></span></li> </ul> </div>
              <div class="popover-actions"> <button type="button" class="popover-button" id="download-chat-txt" title="    "> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>  TXT </button> <button type="button" class="popover-button" id="clear-chat-settings" title="      "> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>   </button> </div>
        </div>
    </div>

    <!-- Chat Output Area -->
    <div id="chat-output"> <div id="chat-output-inner" aria-live="polite" aria-relevant="additions"> <!-- Messages dynamically added here --> </div> <button type="button" id="scroll-to-bottom" title="  (End)" aria-label=" "> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/><path fill="none" d="M0 0h24v24H0V0z"/></svg> </button> </div>

    <!-- Input Area -->
    <div id="chat-input-area"> <div class="input-wrapper"> <textarea id="user-input" placeholder="/  ... (Alt+I )" rows="1" aria-label=" "></textarea> <button type="button" id="clear-input-button" title="  (Alt+X)" aria-label=" "> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </div> <button type="button" id="send-button" aria-label=" (Ctrl+Enter)"></button> </div>

    <!-- Templates (Hidden) - Dialog Only -->
    <div id="custom-dialog-template" style="display: none;"> <div id="dialog-overlay"> <div id="dialog-box" role="alertdialog" aria-labelledby="dialog-title" aria-describedby="dialog-message"> <h2 id="dialog-title"></h2> <p id="dialog-message"></p> <div id="dialog-buttons"> <button type="button" class="dialog-button confirm"></button> <button type="button" class="dialog-button cancel"></button> </div> </div> </div> </div>

</div>

<script>
    // Wrap entire script in a self-executing function
    (function() {
        // --- Constants ---
        const BASE_API_URL = '                                     '; // Keep placeholder
        const TYPING_SPEED = 6; /* 76. Slightly Faster Typing */ const SCROLL_THRESHOLD = 250; /* 77. Larger Scroll Threshold */ const DEBOUNCE_DELAY = 120;
        const MAX_HISTORY_LENGTH = 15;
        const SPLASH_DURATION = 1500; /* 78. Longer Splash for new animation */
        const SPLASH_TEXT_OPTIONS = [ /* 79. Dynamic Splash Text */
            "  AI...", "  ...", "  ...",
            "  ...", " ...", "  ..."
        ];

        // Theme Icons
        const moonIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.91-.1-1.36a5.5 5.5 0 0 1-9.8-5.54A9.01 9.01 0 0 0 12 3z"/></svg>`;
        const sunIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zM7.05 18.36c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>`;

        // Conversation Styles & Prefixes (Unchanged)
        const conversationStyles = { "default": { name: " " }, "creative": { name: "" }, "formal": { name: "" }, "concise": { name: "" }, "humorous": { name: "" }, "technical": { name: "" }, "empathetic": { name: "" }, "storyteller": { name: " " }, "skeptic": { name: "" }, "optimistic": { name: "" }, "teacher": { name: " ()" }, "pirate": { name: "" } };
        const conversationStylePrefixes = { "creative": "   : ", "formal": "    : ", "concise": "   ,  : ", "humorous": "  ,   : ", "technical": "     : ", "empathetic": "  : ", "storyteller": "       : ", "skeptic": "  ,     : ", "optimistic": "   : ", "teacher": "     ,  : ", "pirate": "  , !: " };

        // State Variables
        let messageCounterId = 0, currentAbortController = null, typingTimeout = null;
        let sendOnEnter = true, userInteracted = false, originalDocumentTitle = "AI Chat";
        let currentStyle = "default", isDarkMode = false, isScrolledToBottom = true;
        let lastSender = null; // 80. State for message grouping

        // Element References (Using safe access function)
        let chatContainer, chatOutput, chatOutputInner, userInput, sendButton, chatInputArea, settingsButton, settingsPopover, modelSelect, styleSelect, sendOnEnterCheckbox, sendOnEnterContainer, darkModeCheckbox, darkModeContainer, themeToggleText, themeIconPlaceholder, downloadChatButtonTxt, clearChatButtonSettings, scrollToBottomButton, clearInputButton, customDialogTemplate, chatTitle, splashScreen, splashLoadingText;

        // Safe Element Access & Initialization
        function getElement(id) { const el = document.getElementById(id); if (!el) console.error(`Elem Error: #${id} not found!`); return el; }
        // querySelectorSafe not strictly needed with getElement checks
        function initializeElements() {
            splashScreen = getElement('splash-screen'); splashLoadingText = getElement('splash-loading-text'); chatContainer = getElement('chat-container'); chatOutput = getElement('chat-output'); chatOutputInner = getElement('chat-output-inner'); userInput = getElement('user-input'); sendButton = getElement('send-button'); chatInputArea = getElement('chat-input-area'); settingsButton = getElement('settings-button'); settingsPopover = getElement('settings-popover'); modelSelect = getElement('model-select'); styleSelect = getElement('style-select'); sendOnEnterCheckbox = getElement('send-on-enter-checkbox'); sendOnEnterContainer = getElement('send-on-enter-container'); darkModeCheckbox = getElement('dark-mode-checkbox'); darkModeContainer = getElement('dark-mode-container'); themeToggleText = getElement('theme-toggle-text'); themeIconPlaceholder = getElement('theme-icon-placeholder'); downloadChatButtonTxt = getElement('download-chat-txt'); clearChatButtonSettings = getElement('clear-chat-settings'); scrollToBottomButton = getElement('scroll-to-bottom'); clearInputButton = getElement('clear-input-button'); customDialogTemplate = getElement('custom-dialog-template'); chatTitle = getElement('chat-title');

            // Check critical elements
            const criticalElements = [splashScreen, chatContainer, chatOutput, chatOutputInner, userInput, sendButton, settingsButton, settingsPopover, modelSelect, styleSelect, customDialogTemplate, clearChatButtonSettings, downloadChatButtonTxt, splashLoadingText];
            if (criticalElements.some(el => !el)) {
                throw new Error(`Critical chat elements missing. Check console for details.`);
             }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                initializeElements();
                originalDocumentTitle = document.title || "AI Chat";

                // --- Utility Functions ---
                const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; };
                const getCurrentTimestamp = (iso = false) => { const n = new Date(); return iso ? n.toISOString() : `${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`; };
                const generateMessageId = () => `msg-${Date.now()}-${messageCounterId++}`;
                const focusElement = (el) => { if(el && !userInteracted) setTimeout(() => el.focus(), 50); };
                const escapeHtml = (unsafe) => (typeof unsafe === 'string' ? unsafe.replace(/</g, "&lt;").replace(/>/g, "&gt;") : unsafe);
                const generateAvatarContent = (name) => name ? name.substring(0, 2).toUpperCase() : '??';
                const scrollToBottom = (b='smooth') => { setTimeout(() => { if(chatOutput) chatOutput.scrollTo({top: chatOutput.scrollHeight, behavior: b}); }, 50); };
                const instantScrollToBottom = () => scrollToBottom('auto');
                const smoothScrollToBottom = () => scrollToBottom('smooth');

                // --- Marked.js & Prism.js Setup ---
                if (typeof marked !== 'undefined' && typeof Prism !== 'undefined') {
                    marked.setOptions({
                        breaks: true, gfm: true, sanitize: false,
                        highlight: function(code, lang) {
                            const language = lang && Prism.languages[lang] ? lang : 'clike';
                            // Ensure autoloader has loaded the language
                            if (!Prism.languages[language] && Prism.plugins && Prism.plugins.autoloader) {
                                Prism.plugins.autoloader.loadLanguages(language, () => {}); // Async, might not highlight immediately on first load
                            }
                            if (Prism.languages[language]) {
                                try { return Prism.highlight(code, Prism.languages[language], language); }
                                catch (e) { console.warn("Prism highlighting failed:", e); return escapeHtml(code); }
                            }
                            return escapeHtml(code);
                        }
                    });
                 } else {
                     console.warn("Marked.js or Prism.js not loaded. Using basic formatting.");
                     window.marked = { parse: (text) => '<p>' + escapeHtml(text).replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>') + '</p>' };
                 }

                // --- Splash Screen ---
                const updateSplashText = () => { /* 81. Update Splash Text Periodically */
                     if (splashLoadingText && !splashScreen.classList.contains('hidden')) {
                         const randomIndex = Math.floor(Math.random() * SPLASH_TEXT_OPTIONS.length);
                         splashLoadingText.textContent = SPLASH_TEXT_OPTIONS[randomIndex];
                         setTimeout(updateSplashText, 1800 + Math.random() * 500); // Update every 1.8-2.3 seconds
                     }
                 };
                const hideSplashScreen = () => {
                    if (splashScreen && chatContainer) {
                        splashScreen.classList.add('hidden');
                        chatContainer.classList.add('loaded');
                        focusElement(userInput);
                        instantScrollToBottom();
                        updateScrollState();
                    } else { console.error("Could not hide splash screen - elements missing?"); }
                };
                setTimeout(hideSplashScreen, SPLASH_DURATION);
                updateSplashText(); // Start dynamic text updates

                // --- Settings ---
                const saveSettings = () => { try { const s={model:modelSelect?.value, style:styleSelect?.value, sendOnEnter:sendOnEnterCheckbox?.checked, darkMode:darkModeCheckbox?.checked}; localStorage.setItem('aiChatSettings_v9.3_quantum', JSON.stringify(s)); } catch(e){console.warn("Save settings failed:",e)} }; /* 82. Updated Settings Key */
                const loadSettings = () => { try { const s=localStorage.getItem('aiChatSettings_v9.3_quantum'); let sets=s?JSON.parse(s):{}; if(typeof sets!=='object'||sets===null) sets={}; if(modelSelect) modelSelect.value=(sets.model&&Array.from(modelSelect.options).some(o=>o.value===sets.model))?sets.model:modelSelect.options[0]?.value; currentStyle=(sets.style&&conversationStyles[sets.style])?sets.style:'default'; if(styleSelect) styleSelect.value=currentStyle; if(sendOnEnterCheckbox) sendOnEnterCheckbox.checked=sets.sendOnEnter!==false; sendOnEnter=sendOnEnterCheckbox?.checked!==false; if(darkModeCheckbox) darkModeCheckbox.checked=sets.darkMode===true; applyDarkMode(darkModeCheckbox?.checked===true,false); } catch(e){console.error("Load settings failed:",e); if(sendOnEnterCheckbox)sendOnEnterCheckbox.checked=true; sendOnEnter=true; currentStyle='default'; if(styleSelect)styleSelect.value='default'; applyDarkMode(false,false); console.log("Applied default settings due to load error.")} };
                const applyDarkMode = (isDark, save = true) => { isDarkMode = isDark; document.body.classList.toggle('dark-mode', isDark); if(themeToggleText) themeToggleText.textContent = isDark ? '  ' : '  '; if(themeIconPlaceholder) themeIconPlaceholder.innerHTML = isDark ? sunIconSvg : moonIconSvg; if(darkModeCheckbox) darkModeCheckbox.checked = isDark; if (save) saveSettings(); };
                const toggleSettingsPopover = (show) => { if(settingsPopover && settingsButton) { const isVisible = settingsPopover.classList.contains('visible'); if (show === undefined) show = !isVisible; settingsPopover.classList.toggle('visible', show); settingsButton.setAttribute('aria-expanded', String(show)); }};
                const populateStyleSelect = () => { if (styleSelect) { styleSelect.innerHTML = ''; for (const key in conversationStyles) { const option = document.createElement('option'); option.value = key; option.textContent = conversationStyles[key].name; styleSelect.appendChild(option); } }};
                const showCustomDialog = (opts) => { if (!customDialogTemplate) return; const dialogOverlay = customDialogTemplate.firstElementChild.cloneNode(true); const dialogBox=dialogOverlay.querySelector('#dialog-box'), titleEl=dialogOverlay.querySelector('#dialog-title'), msgEl=dialogOverlay.querySelector('#dialog-message'), confirmBtn=dialogOverlay.querySelector('.confirm'), cancelBtn=dialogOverlay.querySelector('.cancel'); if (!dialogBox || !titleEl || !msgEl || !confirmBtn || !cancelBtn) return; titleEl.textContent=opts.title||''; msgEl.innerHTML=opts.message||''; confirmBtn.textContent=opts.confirmText||''; cancelBtn.textContent=opts.cancelText||''; const close=()=>{ dialogOverlay.classList.remove('visible'); setTimeout(()=>dialogOverlay.remove(),350); /* Slightly longer close transition */ }; confirmBtn.onclick=()=>{ if(opts.onConfirm) opts.onConfirm(); close(); }; cancelBtn.onclick=()=>{ if(opts.onCancel) opts.onCancel(); close(); }; dialogOverlay.onclick=(e)=>{ if(e.target === dialogOverlay) close(); }; document.body.appendChild(dialogOverlay); requestAnimationFrame(()=>dialogOverlay.classList.add('visible')); };

                // --- Scroll & Update State ---
                const updateScrollState = () => { if(chatOutput && scrollToBottomButton) { const isNearBottom = chatOutput.scrollHeight - chatOutput.scrollTop - chatOutput.clientHeight < SCROLL_THRESHOLD; isScrolledToBottom = isNearBottom; scrollToBottomButton.classList.toggle('visible', !isNearBottom); }};
                const debouncedUpdateScrollState = debounce(updateScrollState, DEBOUNCE_DELAY);

                 // --- Chat History ---
                 const getChatHistory = (forRegeneration = false, regenerationTargetMsgId = null) => { const history = []; if (!chatOutputInner) return history; const wrappers = chatOutputInner.querySelectorAll('.message-wrapper:not(.initial-message)'); wrappers.forEach((wrapper) => { const msgDiv = wrapper.querySelector('.message'); if (!msgDiv) return; const sender = msgDiv.dataset.sender, msgId = wrapper.dataset.messageId; if (forRegeneration && msgId === regenerationTargetMsgId && sender === 'ai') return; const contentEl = msgDiv.querySelector('.message-content'); let content = contentEl?.dataset.rawText || contentEl?.textContent?.trim() || ''; if (sender === 'user' && msgDiv.dataset.originalUserQuery) { content = msgDiv.dataset.originalUserQuery; } if (content) history.push({ role: sender === 'user' ? 'user' : 'model', content: content }); }); return history.slice(-MAX_HISTORY_LENGTH); };

                // --- Enable/Disable Input ---
                const enableInput = (focus = true) => { if(userInput && sendButton && chatInputArea) { userInput.disabled = false; sendButton.disabled = false; sendButton.classList.remove('sending'); userInput.style.opacity = '1'; chatInputArea.style.opacity = '1'; if (focus && !userInteracted && document.body.clientWidth > 600) focusElement(userInput); /* 83. Focus only on wider screens */ }};
                const disableInput = () => { if(userInput && sendButton && chatInputArea) { userInput.disabled = true; sendButton.disabled = true; sendButton.classList.add('sending'); userInput.style.opacity = '0.6'; /* 84. Dim more when disabled */ chatInputArea.style.opacity = '0.8'; }};

                // --- Add/Manage Messages ---
                const addMessageToChat = (text, sender, options = {}) => {
                    if (!chatOutputInner) return null;
                    const { isLoading = false, timestamp = null, modelNameUsed = null, userQuery = null, modelValue = null, messageIdOverride = null, originalUserQueryForDisplay = null } = options;
                    const messageId = messageIdOverride || generateMessageId();
                    const tsValue = timestamp || getCurrentTimestamp(false);
                    const isInitial = tsValue === '';

                    // --- Message Grouping Logic --- START --- // 85. Grouping Logic
                    const isGrouped = !isLoading && !isInitial && sender === lastSender;
                    const previousWrapper = chatOutputInner.lastElementChild;
                    if (previousWrapper && previousWrapper.classList.contains('message-wrapper')) {
                        previousWrapper.classList.remove('group-end'); // Remove end from previous if new one is added
                        if (isGrouped) {
                            previousWrapper.classList.add('grouped'); // Mark previous as grouped
                        } else {
                             previousWrapper.classList.add('group-end'); // Mark previous as end of its group
                        }
                    }
                    // --- Message Grouping Logic --- END ---

                    const messageWrapper = document.createElement('div');
                    messageWrapper.classList.add('message-wrapper', sender === 'user' ? 'user-message-wrapper' : 'ai-message-wrapper');
                    if (isInitial) messageWrapper.classList.add('initial-message');
                    else if (isGrouped) messageWrapper.classList.add('grouped'); // Add grouped class to new wrapper
                    else messageWrapper.classList.add('group-start'); // If not grouped, it's a start
                    messageWrapper.dataset.messageId = messageId;

                    // Update last sender *after* processing grouping for the current message
                    if (!isLoading && !isInitial) { lastSender = sender; } else if (isLoading) { lastSender = 'ai_typing'; } else { lastSender = null; } // Reset if initial or loading

                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar';
                    avatarDiv.setAttribute('aria-hidden', 'true');
                    avatarDiv.textContent = generateAvatarContent(sender === 'user' ? 'Me' : 'AI');

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
                    messageDiv.dataset.sender = sender;
                    messageDiv.dataset.timestamp = tsValue;

                    if (sender === 'user' && originalUserQueryForDisplay) { messageDiv.dataset.originalUserQuery = originalUserQueryForDisplay; }
                    if (sender === 'ai' && !isLoading && !isInitial) { if (modelNameUsed) messageDiv.dataset.modelName = modelNameUsed; if (userQuery) messageDiv.dataset.userQuery = userQuery; if (modelValue) messageDiv.dataset.modelValue = modelValue; }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    if (!isLoading && text) contentDiv.dataset.rawText = text; // Store raw text

                    if (isLoading) {
                        messageDiv.classList.add('typing-indicator');
                        const stopButtonId = `stop-generation-button-${messageId}`;
                        contentDiv.innerHTML = `<span class="ai-thinking-text">AI ...</span><button type="button" id="${stopButtonId}" class="stop-button msg-action-button" title=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 7h10v10H7z"/></svg></button>`;
                        messageDiv.appendChild(contentDiv);
                        const stopBtn = contentDiv.querySelector(`#${stopButtonId}`);
                        if (stopBtn) stopBtn.onclick = stopTypingAndGeneration;
                    } else {
                        if (text) {
                             try {
                                contentDiv.innerHTML = marked.parse(text);
                                // Apply Prism highlighting after content is added
                                if (typeof Prism !== 'undefined') {
                                    contentDiv.querySelectorAll('pre code').forEach(block => Prism.highlightElement(block, true)); // Async highlight
                                }
                             } catch (e) { console.error("Markdown/Prism render err:", e); contentDiv.textContent = text; }
                         } else { contentDiv.textContent = " "; } // Ensure div isn't empty for layout
                        messageDiv.appendChild(contentDiv);

                        if (!isInitial) {
                            const footerDiv = document.createElement('div'); footerDiv.className = 'message-footer';
                            if (sender === 'ai' && modelNameUsed) { const modelSpan = document.createElement('span'); modelSpan.className = 'model-indicator'; modelSpan.textContent = `(${modelNameUsed})`; footerDiv.appendChild(modelSpan); }
                            const tsSpan = document.createElement('span'); tsSpan.className = 'timestamp'; tsSpan.textContent = tsValue; tsSpan.dataset.timestampAbs = getCurrentTimestamp(true); footerDiv.appendChild(tsSpan);
                            messageDiv.appendChild(footerDiv);

                            // Add message actions (Copy, Regenerate)
                            const actionsDiv = document.createElement('div'); actionsDiv.classList.add('message-actions');
                            const copyBtn = document.createElement('button'); copyBtn.type = 'button'; copyBtn.className = 'msg-action-button copy-button'; copyBtn.title = ' '; copyBtn.setAttribute('aria-label', ' '); copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; copyBtn.onclick = handleCopyClick; actionsDiv.appendChild(copyBtn);
                            if (sender === 'ai') {
                                const regenBtn = document.createElement('button'); regenBtn.type = 'button'; regenBtn.className = 'msg-action-button regenerate-button'; regenBtn.title = '   '; regenBtn.setAttribute('aria-label', '   '); regenBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>'; regenBtn.onclick = handleRegenerateClick; actionsDiv.appendChild(regenBtn);
                            }
                            messageWrapper.appendChild(actionsDiv); // Append actions to wrapper, not message div
                        }
                        // Add copy buttons to code blocks after initial render
                        contentDiv.querySelectorAll('pre').forEach(addCopyButtonToCodeBlock);
                    }

                    // Message Tail is removed via CSS

                    // Append Avatar and Message Div in correct order
                    if (sender === 'user') { messageWrapper.appendChild(messageDiv); messageWrapper.appendChild(avatarDiv); }
                    else { messageWrapper.appendChild(avatarDiv); messageWrapper.appendChild(messageDiv); }

                    chatOutputInner.appendChild(messageWrapper);

                    // Add slight delay for animation calculation to work properly
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                             messageWrapper.classList.add('animate-in');
                        });
                    });

                    scrollToBottom(isLoading ? 'auto' : 'smooth');
                    return messageWrapper;
                };


                const typeAiResponse = (messageWrapper, fullText) => {
                    const messageElement = messageWrapper?.querySelector('.message');
                    const contentDiv = messageElement?.querySelector('.message-content');
                    if (!contentDiv || !messageElement) { finalizeAiMessage(messageWrapper, contentDiv, fullText); return; } // Finalize even if elements missing
                    messageElement.classList.remove('typing-indicator');
                    contentDiv.innerHTML = ''; // Clear loading state
                    contentDiv.dataset.rawText = fullText; // Store raw text early
                    let charIndex = 0;
                    clearTimeout(typingTimeout); typingTimeout = null;

                    function typeChar() {
                        if (currentAbortController?.signal.aborted) { finalizeAiMessage(messageWrapper, contentDiv, contentDiv.textContent); return; } // Finalize with current text on abort
                        if (charIndex < fullText.length) {
                            contentDiv.textContent += fullText[charIndex];
                            charIndex++;
                            if(isScrolledToBottom && charIndex % 5 === 0) instantScrollToBottom(); // 86. Scroll less frequently during typing
                            typingTimeout = setTimeout(typeChar, TYPING_SPEED);
                        } else {
                            finalizeAiMessage(messageWrapper, contentDiv, fullText); // Finalize with full text
                        }
                    };
                    typeChar();
                };

                const finalizeAiMessage = (messageWrapper, contentDiv, textToParse) => {
                    clearTimeout(typingTimeout); typingTimeout = null;
                    if (!messageWrapper || !contentDiv) { enableInput(); return; }

                    messageWrapper.querySelector('.message')?.classList.remove('typing-indicator'); // Ensure pulse class removed
                    // Ensure the final raw text is stored
                    contentDiv.dataset.rawText = textToParse;

                    // Re-parse and highlight the final content
                     try {
                        contentDiv.innerHTML = marked.parse(textToParse || " "); // Use space if empty to prevent collapse
                        if (typeof Prism !== 'undefined') {
                            contentDiv.querySelectorAll('pre code[class*="language-"]').forEach(block => Prism.highlightElement(block, true)); // Async highlight
                        }
                         contentDiv.querySelectorAll('pre').forEach(addCopyButtonToCodeBlock); // Add copy buttons again
                    } catch(e) {
                        console.error("Markdown/Prism finalize err:", e);
                        contentDiv.textContent = textToParse || " "; // Fallback to text
                    }

                    if (chatOutputInner) chatOutputInner.removeAttribute('aria-busy');

                    // Re-evaluate grouping for the finalized message
                    const sender = messageWrapper.querySelector('.message')?.dataset.sender;
                    const previousWrapper = messageWrapper.previousElementSibling;
                     if (previousWrapper && previousWrapper.classList.contains('message-wrapper')) {
                        const previousSender = previousWrapper.querySelector('.message')?.dataset.sender;
                        if (sender === previousSender) {
                             messageWrapper.classList.add('grouped');
                            previousWrapper.classList.add('grouped');
                            previousWrapper.classList.remove('group-end');
                         } else {
                            messageWrapper.classList.add('group-start');
                            previousWrapper.classList.add('group-end');
                        }
                     } else {
                         messageWrapper.classList.add('group-start'); // First message is always a start
                     }
                     // Mark the very last message as end of its potential group
                     messageWrapper.classList.add('group-end');


                    if (!currentAbortController || (currentAbortController && !currentAbortController.signal.aborted)) {
                        enableInput();
                    }
                    smoothScrollToBottom(); // Use smooth scroll after finalizing
                };

                const stopTypingAndGeneration = () => {
                    if (currentAbortController) { currentAbortController.abort(); console.log('Generation aborted by user.'); }
                    else { // Handle stopping typing indicator before fetch starts
                        clearTimeout(typingTimeout); typingTimeout = null;
                        const typingMsgWrapper = chatOutputInner?.querySelector('.ai-message-wrapper .typing-indicator')?.closest('.message-wrapper');
                        if (typingMsgWrapper) {
                            const contentDiv = typingMsgWrapper.querySelector('.message-content');
                            if (contentDiv) {
                                finalizeAiMessage(typingMsgWrapper, contentDiv, contentDiv.textContent); // Finalize with whatever was typed
                            } else {
                                typingMsgWrapper.remove(); // Remove if content div missing
                            }
                        }
                        enableInput();
                        console.log('Typing process stopped.');
                    }
                    if (chatOutputInner) chatOutputInner.removeAttribute('aria-busy');
                 };

                const addCopyButtonToCodeBlock = (pre) => { if(!pre || pre.querySelector('.copy-code-button')) return; const btn = document.createElement('button'); btn.textContent = ''; btn.className = 'copy-code-button'; btn.ariaLabel = ' '; btn.type = 'button'; btn.onclick = (e) => { e.stopPropagation(); const codeElement = pre.querySelector('code') || pre; let textToCopy = (codeElement.textContent || ''); // Basic text content extraction
                // Attempt to remove the button text if it got included (simple check)
                if (textToCopy.endsWith('') || textToCopy.endsWith('!') || textToCopy.endsWith('')) { const buttonTextLength = btn.textContent.length; textToCopy = textToCopy.substring(0, textToCopy.length - buttonTextLength).trimEnd(); } navigator.clipboard.writeText(textToCopy.trim()).then(()=>{ btn.textContent='!'; btn.classList.add('copied'); setTimeout(()=>{btn.textContent='';btn.classList.remove('copied');},1500);}).catch(err=>{console.error("Copy failed:", err);btn.textContent='';setTimeout(()=>{btn.textContent='';},1500);}); }; pre.style.position='relative'; pre.appendChild(btn); };
                const handleCopyClick = (e) => { const button = e.currentTarget; const wrapper = button.closest('.message-wrapper'); if (!wrapper) return; const content = wrapper.querySelector('.message-content'); if (!content) return; const textToCopy = content.dataset.rawText || content.textContent?.trim() || ''; if (!textToCopy) { console.warn("Nothing to copy."); return; } /* 87. Handle empty copy */ navigator.clipboard.writeText(textToCopy).then(()=>{button.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';button.classList.add('copied');button.title='!';setTimeout(()=>{button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';button.classList.remove('copied');button.title=' ';},1500);}).catch(err=>{console.error("Copy failed:", err);button.title=' ';}); };
                const handleRegenerateClick = (e) => { if(typingTimeout || currentAbortController) { showCustomDialog({ title: " ", message: "     -AI ." }); return; } const button = e.currentTarget; const wrapper = button.closest('.message-wrapper'); if(!wrapper) return; const msg = wrapper.querySelector('.ai-message'); if(!msg) return; const originalUserQuery=msg.dataset.userQuery, modelValueUsed=msg.dataset.modelValue, modelNameUsed=msg.dataset.modelName, originalAiMsgId=wrapper.dataset.messageId; if(!originalUserQuery || !modelValueUsed || !modelNameUsed || !originalAiMsgId) { showCustomDialog({ title: "", message: "     (  )." }); return; } sendMessage(originalUserQuery, { isRegeneration: true, originalAiMsgId: originalAiMsgId, modelValueOverride: modelValueUsed, modelNameOverride: modelNameUsed }, false); };

                // --- Send Message ---
                const sendMessage = async (textToSend, options = {}, skipResponse = false) => {
                    if (!userInput || !chatOutputInner || !modelSelect || !sendButton) return;

                    const { isRegeneration = false, originalAiMsgId = null, modelValueOverride = null, modelNameOverride = null } = options;
                    const originalUserText = (textToSend !== undefined ? textToSend : userInput.value).trim();

                    if (originalUserText === '') { return; } // Don't send empty messages
                    if (currentAbortController) { showCustomDialog({ title: " ", message: "    ." }); return; }

                    disableInput();
                    if(clearInputButton) clearInputButton.classList.remove('visible'); // Hide clear button immediately
                    if(sendButton) sendButton.classList.remove('has-text');

                    let textForApi = originalUserText;
                    const stylePrefix = (!isRegeneration && currentStyle !== 'default') ? conversationStylePrefixes[currentStyle] || '' : '';
                    if (stylePrefix) { textForApi = stylePrefix + originalUserText; }

                    if (!isRegeneration) { addMessageToChat(originalUserText, 'user', { timestamp: getCurrentTimestamp(false), originalUserQueryForDisplay: originalUserText }); userInput.value = ''; adjustTextareaHeight(); instantScrollToBottom(); }
                    else if (originalAiMsgId) {
                        const oldWrapper = chatOutputInner.querySelector(`.message-wrapper[data-message-id="${originalAiMsgId}"]`);
                        if (oldWrapper) {
                             // Fix grouping after removal
                             const nextWrapper = oldWrapper.nextElementSibling;
                             const prevWrapper = oldWrapper.previousElementSibling;
                             oldWrapper.remove(); // Remove the old AI message
                             if (nextWrapper && nextWrapper.classList.contains('message-wrapper')) {
                                 nextWrapper.classList.remove('grouped'); // Next message becomes a start
                                 nextWrapper.classList.add('group-start');
                             }
                             if(prevWrapper && prevWrapper.classList.contains('message-wrapper')){
                                 prevWrapper.classList.add('group-end'); // Previous message becomes an end
                             }
                             lastSender = prevWrapper ? prevWrapper.querySelector('.message')?.dataset.sender : null; // Reset last sender based on previous message
                         }
                    }

                    if (skipResponse) { enableInput(); return; }

                    const loadingIndicatorWrapper = addMessageToChat(null, 'ai', { isLoading: true });
                    if (chatOutputInner) chatOutputInner.setAttribute('aria-busy', 'true');
                    instantScrollToBottom();

                    const historyArray = getChatHistory(isRegeneration, originalAiMsgId);
                    let requestPayloadText = historyArray.map(m => `[${m.role.toUpperCase()}] ${m.content}`).join('\n');
                    requestPayloadText += (requestPayloadText ? '\n' : '') + `[USER] ${textForApi}`;
                    requestPayloadText = requestPayloadText.trim();

                    const selectedOption = modelSelect ? (modelValueOverride ? (Array.from(modelSelect.options).find(opt => opt.value === modelValueOverride) || modelSelect.options[modelSelect.selectedIndex]) : modelSelect.options[modelSelect.selectedIndex]) : null;
                    const modelName = modelNameOverride || selectedOption?.text || 'default';
                    const selectedModelFile = selectedOption?.value || 'main-ai.php';
                    const finalApiUrl = BASE_API_URL + selectedModelFile;

                    currentAbortController = new AbortController();
                    const signal = currentAbortController.signal;

                    try {
                        const requestBody = { text: requestPayloadText };
                        const response = await fetch(finalApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal });

                        if (!signal.aborted) { loadingIndicatorWrapper?.remove(); }
                        else { loadingIndicatorWrapper?.remove(); if (chatOutputInner) chatOutputInner.removeAttribute('aria-busy'); currentAbortController = null; enableInput(false); /* Don't refocus if aborted */ return; }

                        if (!response.ok) {
                            let errorText = `  (${response.status})`;
                             try { const errorData = await response.json(); errorText += `: ${errorData?.error || response.statusText || ' '}`; } catch (e) { /* Ignore JSON parse error on error response */ errorText += `: ${response.statusText || ' '}`; }
                            response.text().then(text => console.error("Server error response body:", text)).catch(()=>{}); // Log body if possible
                            throw new Error(errorText);
                        }

                        const data = await response.json();

                        if (data?.text) {
                             // Create wrapper but don't add content immediately, let typeAiResponse handle it
                            const aiMsgWrapper = addMessageToChat('', 'ai', { timestamp: getCurrentTimestamp(false), modelNameUsed: modelName, userQuery: originalUserText, modelValue: selectedModelFile });
                            if (aiMsgWrapper) {
                                typeAiResponse(aiMsgWrapper, data.text);
                            } else {
                                throw new Error("Failed to create AI message element wrapper.");
                            }
                        } else if (data?.error) {
                             throw new Error(` -API: ${data.error}`);
                        } else {
                            throw new Error("   .");
                        }

                    } catch (error) {
                        if (loadingIndicatorWrapper) loadingIndicatorWrapper.remove(); // Ensure loading removed on error
                        if (chatOutputInner) chatOutputInner.removeAttribute('aria-busy');

                        if (error.name === 'AbortError') {
                            console.log('  .');
                            // Finalize might have already run in typeAiResponse, but run again if needed
                            const lastAiWrapper = chatOutputInner?.querySelector('.ai-message-wrapper:last-child');
                            if (lastAiWrapper && lastAiWrapper.querySelector('.ai-thinking-text')) { // Check if it's still showing "thinking"
                                const contentDiv = lastAiWrapper.querySelector('.message-content');
                                if (contentDiv) finalizeAiMessage(lastAiWrapper, contentDiv, contentDiv.textContent || ""); // Finalize with existing text
                            }
                        } else {
                             console.error("Send Error:", error);
                             addMessageToChat(` : ${error.message}`, 'ai', { modelNameUsed: '' }); // Indicate error in chat
                             enableInput(); // Re-enable input on non-abort error
                         }
                    } finally {
                        // Only set controller to null if it's the current one (prevent race conditions)
                        if (currentAbortController === signal.controller) {
                            currentAbortController = null;
                        }
                        // Enable input if no typing is happening AND the controller is truly null
                        if (!typingTimeout && !currentAbortController) {
                            enableInput();
                        }
                    }
                };

                // --- Download / Clear ---
                const downloadChat = () => { let chatContent = `AI Chat History (${new Date().toLocaleString('he-IL')})\nModel: ${modelSelect?.options[modelSelect.selectedIndex]?.text || 'N/A'}\nStyle: ${conversationStyles[styleSelect?.value || 'default']?.name || 'Default'}\n====================\n\n`; const historyForDownload = []; const wrappers = chatOutputInner?.querySelectorAll('.message-wrapper'); wrappers?.forEach(w => { const msgDiv = w.querySelector('.message'); if (!msgDiv) return; const sender = msgDiv.dataset.sender; const ts = msgDiv.dataset.timestamp; const model = msgDiv.dataset.modelName ? ` (${msgDiv.dataset.modelName})` : ''; const contentEl = msgDiv.querySelector('.message-content'); let text = contentEl?.dataset.rawText || contentEl?.textContent?.trim() || ''; if (sender === 'user' && msgDiv.dataset.originalUserQuery) text = msgDiv.dataset.originalUserQuery; const role = sender === 'user' ? 'User' : (ts === '' ? 'System' : 'AI'); historyForDownload.push(`[${ts}] ${role}${model}: ${text}`); }); chatContent += historyForDownload.join('\n\n'); try { const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const now = new Date(); const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`; const filename = `ai_chat_log_${dateString}.txt`; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch (e) { console.error("Download error:", e); showCustomDialog({ title: " ", message: "  .    ." }); } }; /* 88. Improved Error Msg */
                const clearChat = () => { showCustomDialog({ title: " ", message: "          ?", confirmText: "  ", cancelText: "", /* 89. Clearer Button Text */ onConfirm: () => { stopTypingAndGeneration(); if (chatOutputInner) chatOutputInner.innerHTML = ''; lastSender = null; /* 90. Reset lastSender on clear */ initializeGreeting(); messageCounterId = 0; if (scrollToBottomButton) scrollToBottomButton.classList.remove('visible'); isScrolledToBottom = true; if (userInput) { userInput.value = ''; adjustTextareaHeight(); } if(clearInputButton) clearInputButton.classList.remove('visible'); if(sendButton) sendButton.classList.remove('has-text'); enableInput(); console.log("Chat cleared."); }}); };
                const adjustTextareaHeight = () => { if (!userInput) return; const MIN_HEIGHT_PX = 50; userInput.style.height = 'auto'; const scrollH = userInput.scrollHeight; const computedStyle = window.getComputedStyle(userInput); const maxH = parseInt(computedStyle.maxHeight, 10) || 180; /* 91. Use updated maxH */ const borderBoxAdjustment = userInput.offsetHeight - userInput.clientHeight; /* Account for border/padding */ if (scrollH <= MIN_HEIGHT_PX - borderBoxAdjustment) { userInput.style.height = `${MIN_HEIGHT_PX}px`; } else if (scrollH > maxH - borderBoxAdjustment) { userInput.style.height = `${maxH}px`; } else { userInput.style.height = `${scrollH + borderBoxAdjustment}px`; } userInput.style.overflowY = (scrollH > maxH - borderBoxAdjustment) ? 'auto' : 'hidden'; };
                const handleUrlParameter = () => { try { const params = new URLSearchParams(window.location.search); const conversationParam = params.get('conversation'); if (conversationParam) { const decodedText = decodeURIComponent(conversationParam).trim(); if (decodedText) { setTimeout(() => { // Add user message first, then trigger API call
                         addMessageToChat(decodedText, 'user', { timestamp: getCurrentTimestamp(false), originalUserQueryForDisplay: decodedText });
                         instantScrollToBottom();
                         sendMessage(decodedText, {}, false); // Send the message to the API
                     }, 300); const nextURL = window.location.pathname; window.history.replaceState({}, document.title, nextURL); } } } catch (e) { console.error("URL param error:", e); } }; /* 92. Send URL param message */

                // --- Initial Greeting Function ---
                const initializeGreeting = () => { const greetingText = `  -AI Chat V9.3 - Quantum Core! \n\n   :\n*       .\n*      .\n*     .\n*     .\n\n  ?       !`; addMessageToChat(greetingText, 'ai', { timestamp: '' }); lastSender = 'ai'; /* 93. Set last sender after greeting */ };

                // --- Initialization ---
                const initializeChat = () => { console.log("Initializing AI Chat V9.3 - Quantum Core..."); originalDocumentTitle = document.title; populateStyleSelect(); loadSettings(); adjustTextareaHeight(); initializeGreeting(); handleUrlParameter(); instantScrollToBottom(); enableInput(); updateScrollState(); console.log("AI Chat V9.3 Initialized."); };

                // --- Event Listeners ---
                if (sendButton) sendButton.onclick = () => sendMessage();
                if (userInput) { userInput.addEventListener('keypress', (e) => { userInteracted = true; if (e.key === 'Enter' && !e.shiftKey && !e.isComposing && sendOnEnter) { e.preventDefault(); sendMessage(); } }); userInput.addEventListener('input', () => { userInteracted = true; adjustTextareaHeight(); const hasText = userInput.value.trim().length > 0; /* 94. Trim value for check */ if(clearInputButton) clearInputButton.classList.toggle('visible', hasText); if(sendButton) sendButton.classList.toggle('has-text', hasText); }); }
                if (clearInputButton) clearInputButton.onclick = () => { if (userInput) { userInput.value = ''; adjustTextareaHeight(); clearInputButton.classList.remove('visible'); if(sendButton) sendButton.classList.remove('has-text'); focusElement(userInput); } };
                if (chatOutput) chatOutput.addEventListener('scroll', debouncedUpdateScrollState);
                if (scrollToBottomButton) scrollToBottomButton.onclick = smoothScrollToBottom;
                if (settingsButton) settingsButton.onclick = (e) => { e.stopPropagation(); toggleSettingsPopover(); };
                document.addEventListener('click', (e) => { userInteracted = true; if (settingsPopover?.classList.contains('visible') && !settingsPopover.contains(e.target) && !settingsButton?.contains(e.target)) { toggleSettingsPopover(false); } });
                if (modelSelect) modelSelect.onchange = saveSettings;
                if (styleSelect) { styleSelect.onchange = () => { currentStyle = styleSelect.value; saveSettings(); console.log("Style changed to:", currentStyle); }; }
                if (sendOnEnterContainer) { sendOnEnterContainer.onclick = (e) => { userInteracted = true; if (e.target !== sendOnEnterCheckbox && sendOnEnterCheckbox) { sendOnEnterCheckbox.checked = !sendOnEnterCheckbox.checked; } sendOnEnter = sendOnEnterCheckbox.checked; saveSettings(); }; if(sendOnEnterCheckbox) sendOnEnterCheckbox.onchange = () => { sendOnEnter = sendOnEnterCheckbox.checked; saveSettings(); }; }
                if (darkModeContainer) { darkModeContainer.onclick = (e) => { userInteracted = true; if (e.target !== darkModeCheckbox && darkModeCheckbox) { darkModeCheckbox.checked = !darkModeCheckbox.checked; } applyDarkMode(darkModeCheckbox.checked); }; if(darkModeCheckbox) darkModeCheckbox.onchange = () => { applyDarkMode(darkModeCheckbox.checked); }; }
                if (downloadChatButtonTxt) downloadChatButtonTxt.onclick = downloadChat;
                if (clearChatButtonSettings) clearChatButtonSettings.onclick = clearChat;

                // --- Keyboard Shortcuts ---
                 document.addEventListener('keydown', (e) => {
                     userInteracted = true;
                     const focusOnInput = document.activeElement === userInput;
                     const popoverVisible = settingsPopover?.classList.contains('visible');
                     const isOverlayVisible = document.querySelector('#dialog-overlay.visible');
                     const isTextInputFocused = document.activeElement?.tagName === 'INPUT' || document.activeElement?.tagName === 'TEXTAREA' || document.activeElement?.tagName === 'SELECT'; /* 95. Include SELECT in check */
                     if (isOverlayVisible || (isTextInputFocused && !focusOnInput)) return; // Allow shortcuts if focus is on *our* input

                     if (e.altKey && e.key.toLowerCase() === 's') { e.preventDefault(); toggleSettingsPopover(); }
                     else if (e.altKey && e.key.toLowerCase() === 'i' && !focusOnInput) { e.preventDefault(); focusElement(userInput); }
                     else if (e.altKey && e.key.toLowerCase() === 'x' && focusOnInput) { e.preventDefault(); if (userInput?.value) { userInput.value = ''; adjustTextareaHeight(); if (clearInputButton) clearInputButton.classList.remove('visible'); if (sendButton) sendButton.classList.remove('has-text'); } }
                     else if (e.key === 'Escape') { /* 96. Escape closes popover/dialog */ if (popoverVisible) { e.preventDefault(); toggleSettingsPopover(false); } else if (isOverlayVisible) { e.preventDefault(); const cancelButton = isOverlayVisible.querySelector('.dialog-button.cancel'); if (cancelButton) cancelButton.click(); } }
                     else if (e.key === 'End' && !focusOnInput) { e.preventDefault(); instantScrollToBottom(); }
                     else if (e.key === 'Home' && !focusOnInput) { e.preventDefault(); if (chatOutput) chatOutput.scrollTo({ top: 0, behavior: 'smooth' }); }
                     else if (e.ctrlKey && e.key === 'Enter' && focusOnInput) { e.preventDefault(); sendMessage(); }
                 });

                 // 97. Window resize listener
                 window.addEventListener('resize', debounce(adjustTextareaHeight, 100));

                // --- Start Initialization ---
                initializeChat();

            } catch (error) {
                console.error("Fatal Error during Chat Initialization:", error);
                // Try to gracefully degrade or show an error message
                const escapeHtmlForError = (unsafe) => (typeof unsafe === 'string' ? unsafe.replace(/</g, "&lt;").replace(/>/g, "&gt;") : unsafe);
                const body = document.body;
                if (body) {
                    body.innerHTML = `<div style="padding: 30px; margin: 20px; border: 2px solid #ff4757; background-color: #101418; border-radius: 10px; text-align: center; font-family: 'Rubik', sans-serif; color: #e8edf3;">
                                        <h2 style="color: #ff4757; margin-bottom: 15px;">   ! </h2>
                                        <p style="margin-bottom: 10px;">  -AI    .</p>
                                        <p style="margin-bottom: 20px;">  <strong style="color: #00e5ff;">   (F5)</strong>.   ,     (F12)   .</p>
                                        <pre style="text-align:left; direction:ltr; white-space:pre-wrap; word-break:break-all; background-color: #1a222a; padding: 10px; border-radius: 5px; font-family: 'Fira Code', monospace; font-size: 12px; color: #ff6b6b; max-height: 200px; overflow-y: auto;">${escapeHtmlForError(error.stack || error.message)}</pre>
                                    </div>`;
                }
                // Hide splash if it exists, even on error
                const splash = document.getElementById('splash-screen');
                if (splash) splash.style.display = 'none';
             }
        }); // End DOMContentLoaded

    })(); // End IIFE
</script>

</body>
</html>
```
