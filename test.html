<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט AI עם בחירת מודל</title>
    <style>
        :root {
            /* ... (שאר משתני הצבעים ללא שינוי) ... */
            --header-bg: #00a884;
            --header-text: #ffffff;
            --header-icon-fill: #ffffff;
            --select-bg: rgba(255, 255, 255, 0.15); /* רקע לשדה הבחירה */
            --select-border: rgba(255, 255, 255, 0.3);
            --select-text: var(--header-text);
            --select-arrow: var(--header-icon-fill); /* צבע החץ */
        }

        body.dark-mode {
            /* ... (שאר משתני הצבעים למצב כהה) ... */
            --header-bg: #202c33;
            --header-text: #e9edef;
            --header-icon-fill: #aebac1;
            --select-bg: rgba(255, 255, 255, 0.08);
            --select-border: rgba(255, 255, 255, 0.15);
            --select-text: var(--header-text);
            --select-arrow: var(--header-icon-fill);
        }

        /* ... (שאר ה-CSS כמעט ללא שינוי, להוציא הוספת סגנונות ל-select) ... */

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: Assistant, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-default); color: var(--msg-text);
            display: flex; flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #chat-container {
            width: 100%; max-width: 800px; height: 100vh; margin: 0 auto;
            background-color: var(--chat-bg); display: flex; flex-direction: column;
            overflow: hidden; position: relative; transition: background-color 0.3s ease;
        }

        /* --- Header --- */
        #chat-header {
            background-color: var(--header-bg); color: var(--header-text);
            padding: 8px 10px; /* הקטנת padding קלה */
            display: flex; align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); z-index: 10;
            transition: background-color 0.3s ease, color 0.3s ease;
            gap: 8px; /* מרווח בין כל הפריטים בכותרת */
        }
        #chat-header h1 {
            margin: 0; font-size: 17px; /* הקטנת גודל כותרת */
            font-weight: 600; flex-grow: 1;
            white-space: nowrap; /* מונע שבירת שורה */
            overflow: hidden; /* מסתיר גלישה אם השם ארוך */
            text-overflow: ellipsis; /* מוסיף '...' אם השם נחתך */
        }
        .header-controls { /* עטיפה לכפתורים ול-select */
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- Model Selector --- */
        #model-select {
            background-color: var(--select-bg);
            color: var(--select-text);
            border: 1px solid var(--select-border);
            border-radius: 6px;
            padding: 5px 25px 5px 8px; /* ריווח פנימי (ימין מורחב לחץ) */
            font-size: 13px;
            cursor: pointer;
            outline: none;
            -webkit-appearance: none; /* מסיר עיצוב ברירת מחדל בדפדפני Webkit */
            -moz-appearance: none;    /* מסיר עיצוב ברירת מחדל בפיירפוקס */
            appearance: none;         /* מסיר עיצוב ברירת מחדל סטנדרטי */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23${(encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--select-arrow').trim().substring(1)))}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); /* הטמעת חץ SVG */
             background-repeat: no-repeat;
            background-position: right 5px center; /* מיקום החץ */
            background-size: 18px; /* גודל החץ */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #model-select option {
             background-color: var(--chat-bg); /* צבע רקע לאפשרויות */
             color: var(--msg-text); /* צבע טקסט לאפשרויות */
        }
        body.dark-mode #model-select option {
             background-color: var(--input-bg); /* רקע כהה יותר לאפשרויות */
        }


        /* --- Header Buttons --- */
        .icon-button {
            background: none; border: none; padding: 7px; /* התאמת padding */
            cursor: pointer; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease;
        }
        .icon-button:hover { background-color: var(--icon-button-hover-bg); }
        .icon-button svg {
            width: 20px; height: 20px; /* הקטנת אייקונים מעט */
            fill: var(--header-icon-fill);
            transition: fill 0.3s ease;
        }
        /* --- End Header --- */

        /* --- Chat Output (ללא שינוי משמעותי) --- */
        #chat-output { /* ... סגנונות קיימים ... */ flex-grow: 1; padding: 15px 15px 10px 15px; overflow-y: auto; background-image: url('...'); background-repeat: repeat; display: flex; flex-direction: column; }
        body.dark-mode #chat-output { background-image: none; background-color: var(--chat-bg); }
        #chat-output::-webkit-scrollbar { /* ... */ }
        #chat-output { /* ... */ }
        .message { /* ... */ max-width: 70%; padding: 6px 12px 8px 12px; margin-bottom: 8px; border-radius: 12px; word-wrap: break-word; line-height: 1.45; position: relative; font-size: 14.2px; color: var(--msg-text); box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .user-message { /* ... */ background-color: var(--user-msg-bg); align-self: flex-start; margin-left: auto; border-bottom-left-radius: 4px; }
        body.dark-mode .user-message { color: var(--msg-text); }
        .ai-message { /* ... */ background-color: var(--ai-msg-bg); align-self: flex-end; margin-right: auto; border: 1px solid var(--border-color); border-bottom-right-radius: 4px; box-shadow: none; }
        .message-content { padding-bottom: 15px; }
        .timestamp { /* ... */ font-size: 11px; color: var(--timestamp-color); position: absolute; bottom: 5px; transition: color 0.3s ease; }
        .user-message .timestamp { right: 10px; }
        .ai-message .timestamp { left: 10px; }

        /* --- Input Area (ללא שינוי משמעותי) --- */
        #chat-input-area { /* ... סגנונות קיימים ... */ display: flex; align-items: center; padding: 8px 12px; border-top: 1px solid var(--border-color); background-color: var(--input-area-bg); flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #user-input { /* ... */ flex-grow: 1; padding: 10px 18px; border: none; border-radius: 20px; margin-left: 8px; font-size: 15px; background-color: var(--input-bg); color: var(--input-text); outline: none; transition: background-color 0.3s ease, color 0.3s ease; }
        #send-button { /* ... */ width: 40px; height: 40px; /* ... */ background-color: var(--button-bg); /* ... */ }
        #send-button::before { /* ... */ background-color: var(--button-icon-fill); mask-image: url('data:image/svg+xml,...'); /* ... */ transition: background-color 0.3s ease; }
        #send-button:hover { background-color: var(--button-hover-bg); }

        /* --- Loading Indicator (ללא שינוי) --- */
        .loading span::after { /* ... */ }
        @keyframes dots { /* ... */ }

    </style>
</head>
<body>

<div id="chat-container">
    <!-- Header -->
    <div id="chat-header">
        <h1>צ'אט AI</h1>
        <div class="header-controls"> <!-- עטיפה לפקדים -->
             <!-- Model Selector -->
            <select id="model-select" aria-label="בחר מודל AI">
                <option value="main-ai.php">מודל 1 (ראשי)</option>
                <option value="gemini25.php">מודל 2 (Gemini)</option>
                <!-- אפשר להוסיף מודלים נוספים כאן -->
            </select>

            <!-- Header Buttons -->
            <button class="icon-button" id="dark-mode-toggle" aria-label="שנה ערכת נושא">
                 <!-- אייקון ערכת נושא (מצב בהיר) - החלפנו את הירח -->
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18v-8a2 2 0 0 0-2-2H4.08A8 8 0 0 1 12 4v8a2 2 0 0 0 2 2h5.92A8 8 0 0 1 12 20z"/></svg>
                <!-- אייקון שמש (מצב כהה - מוסתר בהתחלה) -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>
            </button>
            <button class="icon-button" id="download-chat" aria-label="הורד צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="icon-button" id="clear-chat" aria-label="נקה צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div id="chat-output">
        <!-- Initial Message -->
        <div class="message ai-message">
            <div class="message-content"><span>שלום! בחר מודל AI והתחל לשוחח.</span></div>
            <span class="timestamp">התחל</span>
        </div>
    </div>

    <!-- Input Area -->
    <div id="chat-input-area">
        <input type="text" id="user-input" placeholder="הקלד/י הודעה...">
        <button id="send-button" aria-label="שלח"></button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select'); // <<< חדש
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light'); // <<< השתנה מ moonIcon
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');

        // --- Base API URL ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/'; // <<< שינוי: רק הבסיס

        // --- Functions ---

        function getCurrentTimestamp() { /* ... (ללא שינוי) ... */ }
        function addMessageToChat(text, sender, isLoading = false, timestamp = null) { /* ... (ללא שינוי) ... */ }
        function scrollToBottom() { /* ... (ללא שינוי) ... */ }

        // Send message to API (UPDATED)
        async function sendMessage(textToSend) {
            const text = (textToSend || userInput.value).trim();
            if (text === '') return;

            addMessageToChat(text, 'user');
            if (!textToSend) { userInput.value = ''; }

            const loadingMessageElement = addMessageToChat("מעבד", 'ai', true);

            // --- קביעת כתובת ה-API המלאה לפי הבחירה ---
            const selectedModelFile = modelSelect.value; // קבל את שם הקובץ הנבחר
            const currentApiUrl = BASE_API_URL + selectedModelFile; // הרכב את הכתובת המלאה
            // -----------------------------------------

            try {
                console.log(`שולח בקשה ל: ${currentApiUrl}`); // לדיבאגינג
                const response = await fetch(currentApiUrl, { // <<< שימוש בכתובת הדינמית
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                // ... (שאר הלוגיקה של fetch וטיפול בתשובה ללא שינוי) ...
                 if (loadingMessageElement) { chatOutput.removeChild(loadingMessageElement); }
                 if (!response.ok) { throw new Error(`שגיאת שרת: ${response.status} ${response.statusText}`); }
                 const data = await response.json();
                 if (data && data.text) { addMessageToChat(data.text, 'ai'); }
                 else { console.error("תשובה לא תקינה:", data); addMessageToChat("אופס, קרתה שגיאה בקבלת התשובה מהשרת.", 'ai'); }

            } catch (error) {
                 if (loadingMessageElement && loadingMessageElement.parentNode === chatOutput) { chatOutput.removeChild(loadingMessageElement); }
                 console.error("שגיאה:", error);
                 addMessageToChat(`שגיאה: ${error.message}`, 'ai');
            }
        }

        // Toggle Dark Mode (UPDATED icon reference)
        function toggleDarkMode(forceMode) {
             const body = document.body;
             let isDark;
             if (forceMode) { isDark = (forceMode === 'dark'); }
             else { isDark = !body.classList.contains('dark-mode'); }
             body.classList.toggle('dark-mode', isDark);
             themeIconLight.style.display = isDark ? 'none' : 'inline-block'; // <<< שימוש במשתנה המעודכן
             sunIcon.style.display = isDark ? 'inline-block' : 'none';
             localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

             // עדכון צבע החץ של ה-select (דורש חישוב מחדש כי ערכי המשתנים השתנו)
             updateSelectArrowColor();
        }

        // Function to update select arrow color based on current mode (Needed because SVG is embedded)
        function updateSelectArrowColor() {
             const arrowColorVar = getComputedStyle(document.documentElement).getPropertyValue('--select-arrow').trim();
             // הסר # אם קיים והמר לקידוד URL
             const encodedColor = encodeURIComponent(arrowColorVar.startsWith('#') ? arrowColorVar.substring(1) : arrowColorVar);
              modelSelect.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg fill="%23${encodedColor}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>')`;
        }


        function downloadChat() { /* ... (ללא שינוי) ... */ }
        function clearChat() { /* ... (ללא שינוי, אך הודעת הפתיחה שונתה מעט) ... */
              if (confirm("האם אתה בטוח שברצונך למחוק את כל ההודעות בצ'אט?")) {
                 chatOutput.innerHTML = '';
                 addMessageToChat("בחר מודל AI והתחל לשוחח.", 'ai', false, 'התחל');
             }
        }
        function handleUrlParameter() { /* ... (ללא שינוי, ישתמש במודל הנבחר כרגע) ... */ }


        // --- Event Listeners ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { /* ... (ללא שינוי) ... */ });
        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', clearChat);

        // --- חדש: שמירת בחירת המודל ---
        modelSelect.addEventListener('change', () => {
            localStorage.setItem('selectedModel', modelSelect.value);
             console.log(`המודל שנבחר הוא: ${modelSelect.value}`); // לדיבאגינג
        });

        // --- Initialization ---

        // --- חדש: החלת בחירת המודל השמורה ---
        const savedModel = localStorage.getItem('selectedModel');
        if (savedModel) {
            // ודא שהערך השמור קיים כאפשרות לפני שקובעים אותו
            const isValidOption = Array.from(modelSelect.options).some(opt => opt.value === savedModel);
            if (isValidOption) {
                modelSelect.value = savedModel;
                 console.log(`טוען מודל שמור: ${savedModel}`);
            } else {
                 console.warn(`המודל השמור (${savedModel}) אינו אפשרות חוקית. משתמש בברירת המחדל.`);
                 localStorage.removeItem('selectedModel'); // נקה ערך לא חוקי
            }
        }

        // Apply saved dark mode preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'enabled') {
            toggleDarkMode('dark');
        } else {
            toggleDarkMode('light'); // הפעל גם במצב בהיר כדי לעדכן את חץ ה-select
        }

        // Check for URL parameter on load
        handleUrlParameter();

        // Initial scroll to bottom
        scrollToBottom();
    });
</script>

</body>
</html>
