<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט AI - רקע WhatsApp</title>
    <style>
    /* בסיס כללי */
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to bottom right, #f4f4f8, #e9ecf1);
  color: #222;
  transition: background 0.4s ease, color 0.4s ease;
}

.dark-mode {
  background: linear-gradient(to bottom right, #1e1e2f, #12121a);
  color: #eee;
}

.chat-container {
  max-width: 700px;
  margin: 0 auto;
  padding: 1rem;
  overflow-y: auto;
  height: calc(100vh - 100px);
  scroll-behavior: smooth;
}

.message {
  background: #ffffffcc;
  border-radius: 16px;
  padding: 0.75rem 1rem;
  margin: 0.5rem 0;
  max-width: 85%;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  position: relative;
  transition: transform 0.3s ease;
}

.message.user {
  background: #d0f0ff;
  align-self: flex-end;
  margin-left: auto;
  border-left: 4px solid #00aaff;
}

.message.bot {
  background: #f2f2f2;
  border-right: 4px solid #888;
}

.dark-mode .message {
  background: #2b2b3c;
  color: #fff;
}

.dark-mode .message.user {
  background: #004466;
  border-left-color: #00ccff;
}

.dark-mode .message.bot {
  background: #1f1f2a;
  border-right-color: #aaa;
}

/* אנימציה להודעה נכנסת */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.message {
  animation: fadeInUp 0.4s ease-out;
}

/* אפקט hover */
.message:hover {
  box-shadow: 0 0 0 2px #aaa4;
}

.message.active {
  outline: 2px solid #00ccff;
}

/* תצוגת תאריך */
.timestamp {
  font-size: 0.75rem;
  opacity: 0.6;
  margin-top: 4px;
  text-align: right;
}
.message:hover .timestamp::after {
  content: attr(data-time);
  position: absolute;
  right: 8px;
  bottom: -1.2em;
  font-size: 0.7rem;
  background: #000000bb;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
}

/* אינפוט + כפתור שליחה */
.input-bar {
  display: flex;
  padding: 1rem;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(6px);
  border-top: 1px solid #ccc;
  position: sticky;
  bottom: 0;
}

.input-bar textarea {
  flex: 1;
  padding: 0.7rem 1rem;
  border: 1px solid #ccc;
  border-radius: 12px;
  resize: none;
  font-size: 1rem;
  min-height: 2.5rem;
  max-height: 8rem;
  transition: border 0.2s ease;
}

.input-bar textarea:focus {
  border-color: #00aaff;
  outline: none;
}

.send-button {
  background: #00aaff;
  color: white;
  padding: 0.6rem 1.2rem;
  margin-left: 0.75rem;
  border: none;
  border-radius: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease;
}

.send-button:hover {
  background: #0077aa;
}

.send-button:active {
  transform: scale(0.95);
}

/* מצב שולח... */
.send-button.loading::after {
  content: '...';
  animation: dots 1.2s infinite;
}

@keyframes dots {
  0% { content: '.'; }
  33% { content: '..'; }
  66% { content: '...'; }
}

/* כפתור גלילה */
.scroll-button {
  position: fixed;
  right: 1rem;
  bottom: 5rem;
  background: #00aaff;
  color: white;
  padding: 0.5rem;
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 100;
  display: none;
  transition: transform 0.3s ease;
}
.scroll-button:hover {
  transform: scale(1.1);
}

/* נקודות טעינה */
.typing-indicator {
  display: flex;
  gap: 5px;
  margin-top: 6px;
}

.typing-indicator span {
  display: inline-block;
  width: 6px;
  height: 6px;
  background: #888;
  border-radius: 50%;
  animation: bounce 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}
.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0.8); }
  40% { transform: scale(1.2); }
}

/* מצב כהה */
.dark-mode .input-bar {
  background: rgba(20, 20, 30, 0.9);
  border-color: #333;
}

.dark-mode .input-bar textarea {
  background: #1f1f2a;
  color: #eee;
  border-color: #444;
}

.dark-mode .send-button {
  background: #005577;
}

.dark-mode .send-button:hover {
  background: #007799;
}

@media (max-width: 768px) {
  .chat-container {
    padding: 0.5rem;
  }

  .input-bar {
    flex-direction: column;
    gap: 0.5rem;
  }

  .send-button {
    width: 100%;
    margin-left: 0;
  }
}

    </style>
</head>
<body>

<div id="chat-container">
    <div id="chat-header">
        <h1>צ'אט AI</h1>
        <div class="header-controls">
            <select id="model-select" aria-label="בחר מודל AI">
                <option value="main-ai.php">Gemini 2 Flash</option>
                <option value="gemini25.php">Gemini 2.5 Pro</option>
            </select>
            <button class="icon-button" id="dark-mode-toggle" title="שנה ערכת נושא" aria-label="שנה ערכת נושא">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18v-8a2 2 0 0 0-2-2H4.08A8 8 0 0 1 12 4v8a2 2 0 0 0 2 2h5.92A8 8 0 0 1 12 20z"/></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41zM19.78 4.22c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41zm-12.73 12.73c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41z"/></svg>
            </button>
            <button class="icon-button" id="download-chat" title="הורד צ'אט" aria-label="הורד צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button class="icon-button" id="clear-chat" title="נקה צ'אט" aria-label="נקה צ'אט">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>
    </div>
    <div id="chat-output" aria-live="polite">
        <div class="message ai-message" data-message-id="initial-0">
            <div class="message-content"><span>שלום! בחר מודל AI והתחל לשוחח.</span></div>
            <div class="message-footer"><span class="timestamp">התחל</span></div>
        </div>
         <button id="scroll-to-bottom" title="גלול לתחתית" aria-label="גלול לתחתית">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/><path d="M0 0h24v24H0V0z" fill="none"/></svg>
         </button>
    </div>
    <div id="chat-input-area">
        <textarea id="user-input" placeholder="הקלד/י הודעה..." rows="1" aria-label="הודעת משתמש"></textarea>
        <button id="send-button" aria-label="שלח"></button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const modelSelect = document.getElementById('model-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const sunIcon = document.getElementById('sun-icon');
        const downloadChatButton = document.getElementById('download-chat');
        const clearChatButton = document.getElementById('clear-chat');
        const scrollToBottomButton = document.getElementById('scroll-to-bottom');

        // --- State Variables ---
        const BASE_API_URL = 'https://php-render-test.onrender.com/';
        let messageCounter = 0;
        let currentAbortController = null;
        let typingTimeout = null;
        const TYPING_SPEED = 10; // מהירות הקלדה
        const SCROLL_THRESHOLD = 150;

        // --- Utility Functions ---
        function getCurrentTimestamp() { const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); return `${hours}:${minutes}`; }
        function generateMessageId() { return `msg-${Date.now()}-${messageCounter++}`; }
        function scrollToBottom(behavior = 'smooth') { if (behavior === 'smooth') { chatOutput.scrollTo({ top: chatOutput.scrollHeight, behavior: 'smooth' }); } else { chatOutput.scrollTop = chatOutput.scrollHeight; } }

        // --- Get Chat History Function ---
        function getChatHistory(currentUserMessage, forRegeneration = false, regenerationTargetMsgId = null) {
             const history = [];
             const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)');
             messages.forEach((msg) => {
                 const sender = msg.dataset.sender; const timestamp = msg.dataset.timestamp; const messageId = msg.dataset.messageId;
                 if (timestamp === 'התחל' && sender === 'ai') return;
                 if (forRegeneration && messageId === regenerationTargetMsgId && sender === 'ai') return;
                 const contentElement = msg.querySelector('.message-content'); let content = '';
                 contentElement.childNodes.forEach(node => { if (node.nodeType === Node.TEXT_NODE) { content += node.textContent; } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('copy-code-button')) { if (node.tagName === 'PRE') { content += node.textContent; } else { content += node.textContent; } } });
                 content = content.trim();
                 if (content) { const role = sender === 'user' ? 'user' : 'model'; history.push({ role: role, content: content }); }
             });
             return history;
         }

        // --- Add Message to Chat Function ---
        function addMessageToChat(text, sender, options = {}) {
            const { isLoading = false, timestamp = null, modelNameUsed = null, userQuery = null, modelValue = null } = options;
            const messageId = generateMessageId(); const messageDiv = document.createElement('div'); messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message'); messageDiv.dataset.sender = sender; messageDiv.dataset.messageId = messageId; const contentDiv = document.createElement('div'); contentDiv.classList.add('message-content');

            if (isLoading) {
                messageDiv.classList.add('typing-indicator');
                // --- אנימצית טעינה "מגניבה" ---
                contentDiv.innerHTML = `
                    <div class="cool-loading-container">
                        <div class="loading-spinner"></div>
                        <span>מעבד...</span>
                        <button id="stop-generation-button" class="msg-action-button stop-button" title="עצור יצירה" aria-label="עצור יצירה">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13H7v-2h10v2z"/></svg>
                        </button>
                    </div>`;
                messageDiv.appendChild(contentDiv);
                const stopButton = messageDiv.querySelector('#stop-generation-button');
                if (stopButton) { stopButton.addEventListener('click', stopTypingAndGeneration); }
            } else {
                if (sender === 'user') { contentDiv.textContent = text; }
                messageDiv.appendChild(contentDiv);
                const footerDiv = document.createElement('div'); footerDiv.classList.add('message-footer'); const currentTimestamp = timestamp || getCurrentTimestamp(); messageDiv.dataset.timestamp = currentTimestamp; if (sender === 'ai' && modelNameUsed && timestamp !== 'התחל') { const modelSpan = document.createElement('span'); modelSpan.classList.add('model-indicator'); modelSpan.textContent = `(${modelNameUsed})`; footerDiv.appendChild(modelSpan); messageDiv.dataset.userQuery = userQuery || ''; messageDiv.dataset.modelName = modelNameUsed || ''; messageDiv.dataset.modelValue = modelValue || ''; } const timestampSpan = document.createElement('span'); timestampSpan.classList.add('timestamp'); timestampSpan.textContent = currentTimestamp; footerDiv.appendChild(timestampSpan); messageDiv.appendChild(footerDiv); const actionsDiv = document.createElement('div'); actionsDiv.classList.add('message-actions'); const copyButton = document.createElement('button'); copyButton.classList.add('msg-action-button', 'copy-button'); copyButton.title = 'העתק הודעה'; copyButton.setAttribute('aria-label', 'העתק הודעה'); copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; copyButton.addEventListener('click', handleCopyClick); actionsDiv.appendChild(copyButton); if (sender === 'ai' && userQuery && modelValue && timestamp !== 'התחל') { const regenerateButton = document.createElement('button'); regenerateButton.classList.add('msg-action-button', 'regenerate-button'); regenerateButton.title = 'צור תגובה מחדש'; regenerateButton.setAttribute('aria-label', 'צור תגובה מחדש'); regenerateButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>'; regenerateButton.addEventListener('click', handleRegenerateClick); actionsDiv.appendChild(regenerateButton); } messageDiv.appendChild(actionsDiv);
            }
            chatOutput.insertBefore(messageDiv, scrollToBottomButton);
            if (!isLoading) { setTimeout(() => scrollToBottom('smooth'), 50); }
            else { chatOutput.scrollTop = chatOutput.scrollHeight; }
            return messageDiv;
        }

        // --- AI Typing Effect Function ---
         function typeAiResponse(messageElement, fullText) {
             const contentDiv = messageElement.querySelector('.message-content');
             if (!contentDiv) { console.error("Content div not found for typing"); return; }
             contentDiv.innerHTML = ''; messageElement.classList.add('typing-cursor');
             let nodeIndex = 0; const nodes = []; const tempDiv = document.createElement('div'); tempDiv.innerHTML = fullText;
             tempDiv.childNodes.forEach(node => nodes.push(node));
             clearTimeout(typingTimeout);

             function processNode() {
                 if (nodeIndex >= nodes.length) { finalizeAiMessage(messageElement, contentDiv); return; }
                 const currentNode = nodes[nodeIndex];
                 if (currentNode.nodeType === Node.TEXT_NODE) {
                     let textContent = currentNode.textContent; let charIndex = 0;
                     function typeChar() {
                         if (charIndex < textContent.length) { if (contentDiv.lastChild && contentDiv.lastChild.nodeType === Node.TEXT_NODE) { contentDiv.lastChild.textContent += textContent[charIndex]; } else { contentDiv.appendChild(document.createTextNode(textContent[charIndex])); } charIndex++; scrollToBottom('auto'); typingTimeout = setTimeout(typeChar, TYPING_SPEED); }
                         else { nodeIndex++; typingTimeout = setTimeout(processNode, TYPING_SPEED); }
                     }
                     typeChar();
                 } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
                     const clonedNode = currentNode.cloneNode(true); contentDiv.appendChild(clonedNode); if (clonedNode.tagName === 'PRE') { addCopyButtonToCodeBlock(clonedNode); } nodeIndex++; scrollToBottom('auto'); typingTimeout = setTimeout(processNode, TYPING_SPEED);
                 } else { nodeIndex++; processNode(); }
             }
             processNode();
         }

        // --- Finalize AI Message after typing/rendering ---
        function finalizeAiMessage(messageElement, contentDiv) {
             clearTimeout(typingTimeout); typingTimeout = null;
             if (messageElement) { messageElement.classList.remove('typing-cursor'); contentDiv.querySelectorAll('pre').forEach(addCopyButtonToCodeBlock); }
             scrollToBottom('smooth');
             if (!document.querySelector('.typing-indicator') && !typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; if (document.activeElement !== sendButton && document.activeElement !== modelSelect) { userInput.focus(); } }
        }

        // --- Stop Typing and Fetch Request ---
         function stopTypingAndGeneration() {
             console.log('Stopping generation...');
             clearTimeout(typingTimeout); typingTimeout = null;
             const typingIndicator = chatOutput.querySelector('.typing-indicator'); if (typingIndicator) typingIndicator.remove();
             const typingCursorMsg = chatOutput.querySelector('.typing-cursor'); if(typingCursorMsg) typingCursorMsg.classList.remove('typing-cursor');
             if (currentAbortController) { currentAbortController.abort(); currentAbortController = null; }
             else { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); const lastAiMsg = chatOutput.querySelector('.message.ai-message:last-child'); if (!lastAiMsg || lastAiMsg.querySelector('.message-footer')) { addMessageToChat('היצירה הופסקה.', 'ai', { modelNameUsed: 'N/A' }); } }
         }

        // --- Helper Function to Add Copy Button to Code Blocks ---
        function addCopyButtonToCodeBlock(preElement) {
             if (!preElement || preElement.querySelector('.copy-code-button')) return; const copyButton = document.createElement('button'); copyButton.textContent = 'העתק קוד'; copyButton.className = 'copy-code-button'; copyButton.setAttribute('aria-label', 'העתק קוד'); copyButton.addEventListener('click', (e) => { e.stopPropagation(); const codeElement = preElement.querySelector('code') || preElement; const codeToCopy = codeElement.textContent || ''; navigator.clipboard.writeText(codeToCopy).then(() => { copyButton.textContent = 'הועתק!'; copyButton.classList.add('copied'); setTimeout(() => { copyButton.textContent = 'העתק קוד'; copyButton.classList.remove('copied'); }, 1500); }).catch(err => { console.error('שגיאה בהעתקת קוד: ', err); copyButton.textContent = 'שגיאה'; }); }); preElement.appendChild(copyButton);
        }

        // --- Send Message Function ---
        async function sendMessage(textToSend, options = {}) {
             const { isRegeneration = false, originalAiMsgId = null, modelValueOverride = null, modelNameOverride = null } = options;
             const currentText = textToSend !== undefined ? textToSend.trim() : userInput.value.trim();
             if (currentText === '' || typingTimeout) return;

             userInput.disabled = true; sendButton.disabled = true; userInput.style.opacity = '0.7';

             if (!isRegeneration) { addMessageToChat(currentText, 'user', { timestamp: getCurrentTimestamp() }); userInput.value = ''; adjustTextareaHeight(); }
             else if (originalAiMsgId) { const oldAiMsg = chatOutput.querySelector(`.message[data-message-id="${originalAiMsgId}"]`); if (oldAiMsg) oldAiMsg.remove(); }

             const historyArray = getChatHistory( null, isRegeneration, originalAiMsgId );
             let historyStringPart = ""; historyArray.forEach(message => { historyStringPart += `[ROLE=${message.role}] ${message.content}\n`; }); historyStringPart = historyStringPart.trim();
             const combinedStructuredText = `[USER_INPUT_START]\n${currentText}\n[USER_INPUT_END]\n[CHAT_HISTORY_START]\n${historyStringPart}\n[CHAT_HISTORY_END]`;

             const selectedOption = modelValueOverride ? Array.from(modelSelect.options).find(opt => opt.value === modelValueOverride) || modelSelect.options[modelSelect.selectedIndex] : modelSelect.options[modelSelect.selectedIndex];
             const modelName = modelNameOverride || selectedOption.text; const selectedModelFile = selectedOption.value; const currentApiUrl = BASE_API_URL + selectedModelFile;

             const typingIndicatorElement = addMessageToChat(null, 'ai', { isLoading: true });
             currentAbortController = new AbortController(); const signal = currentAbortController.signal;

             try {
                 const requestBody = { text: combinedStructuredText };
                 const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal });
                 const wasAborted = signal.aborted;
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }
                 if (wasAborted) throw new DOMException('Aborted by user', 'AbortError');

                 if (!response.ok) { let errorText = `Server Error: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); if(errorData && errorData.error) errorText += ` - ${errorData.error}`; else if(errorData && errorData.message) errorText += ` - ${errorData.message}`; } catch (e) {} throw new Error(errorText); }

                 const data = await response.json();
                 if (data && data.text) {
                     const aiMessageElement = addMessageToChat('', 'ai', { timestamp: getCurrentTimestamp(), modelNameUsed: modelName, userQuery: currentText, modelValue: selectedModelFile });
                     typeAiResponse(aiMessageElement, data.text);
                 } else {
                     console.error("Invalid response format from server (after OK):", data);
                     addMessageToChat("Unexpected response format from server.", 'ai', { modelNameUsed: modelName });
                     if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 }
             } catch (error) {
                 currentAbortController = null;
                 if (typingIndicatorElement && typingIndicatorElement.parentNode === chatOutput) { typingIndicatorElement.remove(); }
                 if (error.name === 'AbortError') {
                      console.log('Request aborted.');
                      if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 } else {
                      console.error("Error sending/receiving message:", error);
                      addMessageToChat(`שגיאה: ${error.message}`, 'ai', { modelNameUsed: modelName });
                      if (!typingTimeout) { userInput.disabled = false; sendButton.disabled = false; userInput.style.opacity = '1'; userInput.focus(); }
                 }
             }
         }

        // --- UI Interaction Functions ---
        function toggleDarkMode(forceMode) { const body = document.body; let isDark; if (forceMode) isDark = (forceMode === 'dark'); else isDark = !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); themeIconLight.style.display = isDark ? 'none' : 'inline-block'; sunIcon.style.display = isDark ? 'inline-block' : 'none'; localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); updateSelectArrowColor(); }
        function updateSelectArrowColor() { const getEncodedColor = () => { try { const colorValue = getComputedStyle(document.documentElement).getPropertyValue('--select-arrow').trim(); const hexColor = colorValue.startsWith('#') ? colorValue.substring(1) : 'ffffff'; const validHex = /^[0-9A-Fa-f]{3}$|^[0-9A-Fa-f]{6}$/.test(hexColor); return encodeURIComponent(validHex ? hexColor : 'ffffff'); } catch (e) { console.error("Error getting computed style for --select-arrow", e); return 'ffffff'; } }; const encodedColor = getEncodedColor(); modelSelect.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg fill="%23${encodedColor}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>')`; }
        function downloadChat() { let chatContent = `AI Chat History (${new Date().toLocaleString('he-IL')})\nModel: ${modelSelect.options[modelSelect.selectedIndex].text}\n====================\n\n`; const messages = chatOutput.querySelectorAll('.message:not(.typing-indicator)'); messages.forEach(msg => { const sender = msg.dataset.sender === 'user' ? 'User' : 'AI'; const timestamp = msg.dataset.timestamp || ''; const modelInfo = msg.dataset.modelName ? ` (${msg.dataset.modelName})` : ''; const textContent = msg.querySelector('.message-content')?.textContent || msg.querySelector('.message-content')?.innerText || ''; if (timestamp === "התחל" && sender === "AI") return; chatContent += `[${timestamp}] ${sender}${modelInfo}: ${textContent.trim()}\n`; }); const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const now = new Date(); const filename = `ai_chat_log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.txt`; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
        function clearChat() { if (confirm("האם אתה בטוח שברצונך למחוק את כל ההודעות בצ'אט?")) { stopTypingAndGeneration(); chatOutput.innerHTML = ''; chatOutput.appendChild(scrollToBottomButton); addMessageToChat("בחר מודל AI והתחל לשוחח.", 'ai', { timestamp: 'התחל' }); messageCounter = 0; scrollToBottomButton.classList.remove('visible'); } }
        function handleUrlParameter() { const urlParams = new URLSearchParams(window.location.search); const conversationText = urlParams.get('conversation'); if (conversationText) { const decodedText = decodeURIComponent(conversationText).trim(); if (decodedText) { console.log("Sending conversation from URL parameter:", decodedText); setTimeout(() => sendMessage(decodedText), 100); } } }
        function adjustTextareaHeight() { userInput.style.height = 'auto'; const scrollHeight = userInput.scrollHeight; const maxHeight = parseInt(window.getComputedStyle(userInput).maxHeight, 10); if (scrollHeight > maxHeight) { userInput.style.height = `${maxHeight}px`; userInput.style.overflowY = 'auto'; } else { userInput.style.height = `${scrollHeight}px`; userInput.style.overflowY = 'hidden'; } }
        function handleCopyClick(event) { const button = event.currentTarget; const messageElement = button.closest('.message'); if (!messageElement) return; const contentElement = messageElement.querySelector('.message-content'); if (!contentElement) return; const textToCopy = contentElement.textContent || contentElement.innerText || ''; navigator.clipboard.writeText(textToCopy.trim()).then(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>'; button.classList.add('copied'); button.title = 'הועתק!'; setTimeout(() => { button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>'; button.classList.remove('copied'); button.title = 'העתק הודעה'; }, 1500); }).catch(err => { console.error('Failed to copy message: ', err); alert('לא ניתן היה להעתיק את ההודעה.'); }); }
        function handleRegenerateClick(event) { if (typingTimeout) return; const button = event.currentTarget; const messageElement = button.closest('.message.ai-message'); if (!messageElement) return; const userQuery = messageElement.dataset.userQuery; const modelValue = messageElement.dataset.modelValue; const modelName = messageElement.dataset.modelName; const messageId = messageElement.dataset.messageId; if (!userQuery || !modelValue || !modelName || !messageId) { console.error('Regen Error: Missing data', messageElement.dataset); return; } console.log(`Regenerating for: "${userQuery}" using ${modelName} (${modelValue}), replacing ${messageId}`); sendMessage(userQuery, { isRegeneration: true, originalAiMsgId: messageId, modelValueOverride: modelValue, modelNameOverride: modelName }); }
        function handleScroll() { const isScrolledUp = chatOutput.scrollHeight - chatOutput.scrollTop - chatOutput.clientHeight > SCROLL_THRESHOLD; scrollToBottomButton.classList.toggle('visible', isScrolledUp); }

        // --- Event Listeners Setup ---
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
        userInput.addEventListener('input', adjustTextareaHeight);
        darkModeToggle.addEventListener('click', () => toggleDarkMode());
        downloadChatButton.addEventListener('click', downloadChat);
        clearChatButton.addEventListener('click', clearChat);
        modelSelect.addEventListener('change', () => { localStorage.setItem('selectedModel', modelSelect.value); console.log(`Model changed to: ${modelSelect.value}`); });
        chatOutput.addEventListener('scroll', handleScroll);
        scrollToBottomButton.addEventListener('click', () => scrollToBottom('smooth'));

        // --- Initialization ---
        const savedModel = localStorage.getItem('selectedModel'); if (savedModel) { const isValidOption = Array.from(modelSelect.options).some(opt => opt.value === savedModel); if (isValidOption) modelSelect.value = savedModel; else localStorage.removeItem('selectedModel'); }
        const savedDarkMode = localStorage.getItem('darkMode'); if (savedDarkMode === 'enabled') toggleDarkMode('dark'); else toggleDarkMode('light');
        handleUrlParameter(); adjustTextareaHeight(); scrollToBottom('auto');
        console.log("Enhanced Chat interface V2.4 (Cool Loading Animation) initialized.");

    });
</script>

</body>
</html>
